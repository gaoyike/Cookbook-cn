<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.8">
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


/*
 * Theme specific overrides of the preceding (asciidoc.css) CSS.
 *
 */
body {
  font-family: Garamond, Georgia, serif;
  font-size: 17px;
  color: #3E4349;
  line-height: 1.3em;
}
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Garmond, Georgia, serif;
  font-weight: normal;
  border-bottom-width: 0;
  color: #3E4349;
}
div.title, caption.title { color: #596673; font-weight: bold; }
h1 { font-size: 240%; }
h2 { font-size: 180%; }
h3 { font-size: 150%; }
h4 { font-size: 130%; }
h5 { font-size: 115%; }
h6 { font-size: 100%; }
#header h1 { margin-top: 0; }
#toc {
  color: #444444;
  line-height: 1.5;
  padding-top: 1.5em;
}
#toctitle {
  font-size: 20px;
}
#toc a {
    border-bottom: 1px dotted #999999;
    color: #444444 !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
div.toclevel1 { margin-top: 0.2em; font-size: 16px; }
div.toclevel2 { margin-top: 0.15em; font-size: 14px; }
em, dt, td.hdlist1 { color: black; }
strong { color: #3E4349; }
a { color: #004B6B; text-decoration: none; border-bottom: 1px dotted #004B6B; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }
div.tableblock > table, table.tableblock { border: 3px solid #E8E8E8; }
th.tableblock, td.tableblock { border: 1px solid #E8E8E8; }
ul > li > * { color: #3E4349; }
pre, tt, .monospaced { font-family: Consolas,Menlo,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; }
tt, .monospaced { font-size: 0.9em; color: black;
}
div.exampleblock > div.content, div.sidebarblock > div.content, div.listingblock > div.content { border-width: 0 0 0 3px; border-color: #E8E8E8; }
div.verseblock { border-left-width: 0; margin-left: 3em; }
div.quoteblock { border-left-width: 3px; margin-left: 0; margin-right: 0;}
div.admonitionblock td.content { border-left: 3px solid #E8E8E8; }
/*
  pygmentize filter
*/
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f4f4f4; }
.highlight .c { color: #008800; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #AA22FF; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #008800; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #008800 } /* Comment.Preproc */
.highlight .c1 { color: #008800; font-style: italic } /* Comment.Single */
.highlight .cs { color: #008800; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #AA22FF; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #AA22FF; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #AA22FF; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #AA22FF } /* Keyword.Pseudo */
.highlight .kr { color: #AA22FF; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #00BB00; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BB4444 } /* Literal.String */
.highlight .na { color: #BB4444 } /* Name.Attribute */
.highlight .nb { color: #AA22FF } /* Name.Builtin */
.highlight .nc { color: #0000FF } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #00A000 } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #B8860B } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BB4444 } /* Literal.String.Backtick */
.highlight .sc { color: #BB4444 } /* Literal.String.Char */
.highlight .sd { color: #BB4444; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BB4444 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BB4444 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BB4444 } /* Literal.String.Single */
.highlight .ss { color: #B8860B } /* Literal.String.Symbol */
.highlight .bp { color: #AA22FF } /* Name.Builtin.Pseudo */
.highlight .vc { color: #B8860B } /* Name.Variable.Class */
.highlight .vg { color: #B8860B } /* Name.Variable.Global */
.highlight .vi { color: #B8860B } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */



@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_序言">序言</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_关于这个文档">关于这个文档</h3>
<div class="paragraph"><p>这是一个在你开发Lift网络应用的时候, 可以参考的解决方案的集合 <a href="http://www.liftweb.net">Lift web framework</a>.</p></div>
<div class="paragraph"><p>这个文档的目标是, 给出一个单一的, 简练的解决方案对于特定的问题, 解决一个问题也许会有很多方法, 这个本书只提出一种方法, 但是你可以找到更多的信息在讨论中.</p></div>
</div>
<div class="sect2">
<h3 id="_学习lift架构">学习Lift架构</h3>
<div class="paragraph"><p>如果你在学习Lift, 请看以下书籍:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Simply Lift</em>, online at <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>.
</p>
</li>
<li>
<p>
<a href="http://www.packtpub.com/lift-web-applications/book">Lift Web Applications How-to</a>, PACKT Publishing, 2013.
</p>
</li>
<li>
<p>
<a href="http://www.manning.com/perrett/">Lift in Action</a>, Manning Publications, 2011.
</p>
</li>
<li>
<p>
<em>Seven Things</em> that distinguish Lift from other web frameworks: <a href="http://seventhings.liftweb.net">http://seventhings.liftweb.net/</a>.
</p>
</li>
<li>
<p>
<em>Exploring Lift</em> online at <a href="http://exploring.liftweb.net">http://exploring.liftweb.net</a> &#8201;&#8212;&#8201;also known as <a href="http://www.apress.com/9781430224211">The
Definitive Guide to Lift</a>, Apress Media, 2009.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_版权">版权</h3>
<div class="paragraph"><p>This document is licensed Creative Commons Attribution, Non Commercial,
No Derivatives.</p></div>
</div>
<div class="sect2">
<h3 id="_贡献者">贡献者</h3>
<div class="ulist"><ul>
<li>
<p>
Richard Dallaway
</p>
</li>
<li>
<p>
Jono Ferguson
</p>
</li>
<li>
<p>
<strong>Franz Bettag</strong>  Franz is an enthusiastic Scala Hacker for several years now. He joined the Lift team in January 2012 and actively tweets and blogs about his newest Scala adventures. Find him at <a href="https://twitter.com/fbettag">https://twitter.com/fbettag</a>
</p>
</li>
<li>
<p>
Marek Żebrowski
</p>
</li>
<li>
<p>
<strong>Peter Robinett</strong>  Peter is a web and mobile developer and a Lift committer. He can be found on the web at <a href="http://www.bubblefoundry.com">http://www.bubblefoundry.com</a> and on Twitter at <a href="http://twitter.com/pr1001">http://twitter.com/pr1001</a>.
</p>
</li>
<li>
<p>
<strong>Kevin Lau</strong> is a founder of few web apps with a focus in AWS cloud, iOS and Lift.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_翻译">翻译</h3>
<div class="paragraph"><p>Readman QQ 44546836. You can find me @ www.liftweb.cn</p></div>
</div>
<div class="sect2">
<h3 id="_源代码">源代码</h3>
<div class="paragraph"><p>源码在:
<a href="https://github.com/d6y/lift-cookbook">https://github.com/d6y/lift-cookbook</a></p></div>
</div>
<div class="sect2">
<h3 id="_更新">更新</h3>
<div class="paragraph"><p>请见 <a href="https://twitter.com/#!/liftcookbook">@LiftCookbook</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_软件版本">软件版本</h3>
<div class="paragraph"><p>如果没有特别声明, 所有源码运行在 Lift 2.5, SBT
0.12, Scala 2.9</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="InstallAndRunning">安装和运行</h2>
<div class="sectionbody">
<div class="paragraph"><p>这种主要覆盖了关于如何开始开发Lift的相关问题: 其中包括, 运行一个Lift应用和设置一个编程环境. 你将会找到关于生产部署在 <a href="#deployment">[deployment]</a>.</p></div>
<div class="sect2">
<h3 id="DownloadAndRun">下载和运行Lift</h3>
<div class="sect3">
<h4 id="_problem">Problem</h4>
<div class="paragraph"><p>你想安装和运行Lift在你的计算机.</p></div>
</div>
<div class="sect3">
<h4 id="_solution">Solution</h4>
<div class="paragraph"><p>安装和运行Lift的唯一前提是你需要有Java 1.5或者更新的版本在你的计算机上安装. 你可以找到关于如何安装Java在<a href="http://java.com/">http://java.com/</a>.</p></div>
<div class="paragraph"><p>你可以测试是否正确安装Java, 或检查Java的版本, 运行以下命令:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ java -version
java version "1.7.0_13"
Java(TM) SE Runtime Environment (build 1.7.0_13-b20)
Java HotSpot(TM) 64-Bit Server VM (build 23.7-b01, mixed mode)</pre>
</div></div>
<div class="paragraph"><p>当你安装好Java后, 通过运行以下命令, 将会下载, 建立和运行一个基础的Lift应用.</p></div>
<div class="sect4">
<h5 id="_for_mac_and_linux">For Mac and Linux</h5>
<div class="ulist"><ul>
<li>
<p>
打开 <a href="http://liftweb.net/download">http://liftweb.net/download</a> 然后下载 Lift 2.5-RC2 ZIP 文件.
</p>
</li>
<li>
<p>
解压缩ZIP文件.
</p>
</li>
<li>
<p>
打开 <em>Terminal</em> 或者你喜欢的命令行工具.
</p>
</li>
<li>
<p>
打开解压后的文件,然后找到 <span class="monospaced">scala_29</span> 子文件夹, 然后进入 <span class="monospaced">lift_basic</span> 文件夹.
</p>
</li>
<li>
<p>
运行:<span class="monospaced">./sbt</span>.
</p>
</li>
<li>
<p>
程序会自动下载所需要的依赖库.
</p>
</li>
<li>
<p>
在 SBT 上输入: <span class="monospaced">container:start</span>.
</p>
</li>
<li>
<p>
打开你的浏览器, 然后打开 <span class="monospaced">http://127.0.0.1:8080/</span>.
</p>
</li>
<li>
<p>
当你想结束时, 输入 <span class="monospaced">exit</span> 在SBT上, 然后会自动结束.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_for_windows">For Windows</h5>
<div class="ulist"><ul>
<li>
<p>
打开 <a href="http://liftweb.net/download">http://liftweb.net/download</a> 找到ZIP文件的 Lift 2.5-RC2, 存到你的计算机上.
</p>
</li>
<li>
<p>
解压缩ZIP文件.
</p>
</li>
<li>
<p>
打开解压缩的文件夹, 然后找到 <span class="monospaced">scala_29</span> 文件夹, 然后打开 <span class="monospaced">lift_basic</span>.
</p>
</li>
<li>
<p>
双击 <span class="monospaced">sbt.bat</span> 运行SBT编译工具, 一个窗口会自动打开.
</p>
</li>
<li>
<p>
程序会自动下载所需要的依赖库.
</p>
</li>
<li>
<p>
如果Windows的防火墙禁止运行Java, 请选择"允许访问".
</p>
</li>
<li>
<p>
在 SBT 上输入: <span class="monospaced">container:start</span>.
</p>
</li>
<li>
<p>
打开你的浏览器, 然后打开 <span class="monospaced">http://127.0.0.1:8080/</span>.
</p>
</li>
<li>
<p>
当你想结束时, 输入 <span class="monospaced">exit</span> 在SBT上, 然后会自动结束..
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_expected_result">Expected result</h5>
<div class="paragraph"><p>通过以上步骤, 你会运行一个基础的Lift应用, 结果会像以下一样 <a href="#LiftBasicScreenshot">[LiftBasicScreenshot]</a>.</p></div>
<div class="imageblock" id="LiftBasicScreenshot">
<div class="content">
<img src="images/apphome.png" alt="images/apphome.png" width="640">
</div>
<div class="title">Figure 1. The basic Lift application home page.</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion">Discussion</h4>
<div class="paragraph"><p>Lift没有通过常规的"安装"的方法运行, 而是通过编译工具来运行, 如SBT,Maven. 在这章中,我们下载了一个ZIP文件包含了四个尽可能简单的Lift应用, 然后运行了他们通过编译工具.</p></div>
<div class="sect4">
<h5 id="_simple_build_tool">Simple Build Tool</h5>
<div class="paragraph"><p>输入 <span class="monospaced">sbt</span> 打开SBT, 一个基于Scala工程的(不仅仅是对于Lift)依赖库管理工具. SBT将会检查工程的定义, 然后下载所有需要的依赖库, 包括Lift.</p></div>
<div class="paragraph"><p>整个下载过程只进行一次, 然后下载的文件会存在 <span class="monospaced">.ivy2/</span> 在你的主目录下.</p></div>
<div class="paragraph"><p>你的应用编译文件是 <span class="monospaced">build.sbt</span>.  如果你打开它, 你会看到:</p></div>
<div class="ulist"><ul>
<li>
<p>
基础信息关于你的应用, 包含一个名字和版本号;
</p>
</li>
<li>
<p>
resolvers, 一个字符串, 告诉SBT应该在哪里找到所需要的依赖库;
</p>
</li>
<li>
<p>
插件的设置和Scala的编译器; 还有
</p>
</li>
<li>
<p>
一个List的依赖库, 他们用来运行你的程序, 包括了Lift.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="RunningYourApplication">运行你的应用</h5>
<div class="paragraph"><p>SBT命令 <span class="monospaced">container:start</span> 打开了一个web服务器在默认的端口8080上,并且
传递requests到你的Lift应用. 名词 <em>container</em> 的意思是一个能让你部署Lift应用的软件 这里有许多不同的选择. 比如 (<em>Jetty</em> 或者<em>Tomcat</em> 是比较受欢迎的) 他们都是通过同一个标准进行部署的.
其实,你可以部署Lift在任何你想要的container上,.
命令 <span class="monospaced">container:start</span> 是Jetty的命令.</p></div>
</div>
<div class="sect4">
<h5 id="_source_code">Source Code</h5>
<div class="paragraph"><p>程序的源代码在目录 <span class="monospaced">src/main/webapp</span> 和 <span class="monospaced">src/main/scala</span>.如果你看 <span class="monospaced">index.html</span> 文件在  <span class="monospaced">webapp</span> 文件夹下. 你会看到里面有一段 <span class="monospaced">lift:helloWorld</span>. 这是这个文件的引用 <span class="monospaced">scala/code/snippet/HelloWorld.scala</span>. 这是一个 <em>snippet invocation</em> 并且是一个Lift的 <em>view first</em> 网络应用设计模式. 这个模式没有routing的设置: 从前端的index页面,收集数据然后转发到view. 相反, view定义了后端函数取代的位置, 就像函数定义在 <span class="monospaced">HelloWorld.scala</span>.</p></div>
<div class="paragraph"><p>Lift 知道如何去看 <span class="monospaced">code</span> 包去寻找Snippet, 是因为那个包定义了位置在 <span class="monospaced">scala/bootstrap/liftweb/Boot.scala</span>. Boot文件会在Lift运行后首先运行, 你可以在这里
定义许多Lift的行为.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also">See Also</h4>
<div class="paragraph"><p>SBt的文档在 <a href="http://www.scala-sbt.org">http://www.scala-sbt.org</a>.</p></div>
<div class="paragraph"><p>Lift的教程在 <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a> and in <em>Lift in Action</em> (Tim Perrett, 2011, Manning Publications Co).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="LiftFromScratch">使用SBT建立一个Lift Project</h3>
<div class="sect3">
<h4 id="_problem_2">Problem</h4>
<div class="paragraph"><p>你想建立一个Lift文档,但是不使用官网的ZIP文件</p></div>
</div>
<div class="sect3">
<h4 id="_solution_2">Solution</h4>
<div class="paragraph"><p>你需要设置SBT和Lift. 幸运的是, 只需要五个简单的文件</p></div>
<div class="paragraph"><p>第一, 建立一个SBT文件 <span class="monospaced">project/plugins.sbt</span> (所有文件名字都关联到文件的root目录):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">&lt;+=</span> <span class="n">sbtVersion</span><span class="o">(</span><span class="n">v</span> <span class="k">=&gt;</span> <span class="n">v</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;0.11.0&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.0-0.2.8&quot;</span>
  <span class="k">case</span> <span class="s">&quot;0.11.1&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.1-0.2.10&quot;</span>
  <span class="k">case</span> <span class="s">&quot;0.11.2&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.2-0.2.11&quot;</span>
  <span class="k">case</span> <span class="s">&quot;0.11.3&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.3-0.2.11.1&quot;</span>
  <span class="k">case</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="n">startsWith</span> <span class="s">&quot;0.12&quot;</span> <span class="k">=&gt;</span>
    <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.12.0-0.2.11.1&quot;</span>
<span class="o">})</span>
</pre></div></div></div>
<div class="paragraph"><p>这个文件告诉了SBT, 你将会使用xsbt-web-plugin并且让SBT选择正确的版本.</p></div>
<div class="paragraph"><p>然后,建立sbt编译文件, <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">organization</span> <span class="o">:=</span> <span class="s">&quot;org.yourorganization&quot;</span>

<span class="n">name</span> <span class="o">:=</span> <span class="s">&quot;liftfromscratch&quot;</span>

<span class="n">version</span> <span class="o">:=</span> <span class="s">&quot;0.1-SNAPSHOT&quot;</span>

<span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">&quot;2.10.0&quot;</span>

<span class="n">seq</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">siasia</span><span class="o">.</span><span class="nc">WebPlugin</span><span class="o">.</span><span class="n">webSettings</span> <span class="k">:_</span><span class="kt">*</span><span class="o">)</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-RC2&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span> <span class="o">%</span> <span class="s">&quot;compile&quot;</span><span class="o">,</span>
    <span class="s">&quot;org.eclipse.jetty&quot;</span> <span class="o">%</span> <span class="s">&quot;jetty-webapp&quot;</span> <span class="o">%</span> <span class="s">&quot;8.1.7.v20120910&quot;</span>  <span class="o">%</span> <span class="s">&quot;container,test&quot;</span><span class="o">,</span>
    <span class="s">&quot;org.eclipse.jetty.orbit&quot;</span> <span class="o">%</span> <span class="s">&quot;javax.servlet&quot;</span> <span class="o">%</span> <span class="s">&quot;3.0.0.v201112011016&quot;</span> <span class="o">%</span>
      <span class="s">&quot;container,compile&quot;</span> <span class="n">artifacts</span> <span class="nc">Artifact</span><span class="o">(</span><span class="s">&quot;javax.servlet&quot;</span><span class="o">,</span> <span class="s">&quot;jar&quot;</span><span class="o">,</span> <span class="s">&quot;jar&quot;</span><span class="o">)</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>请随意改变到不同的版本, 不过主版本的Lift只能建立在住版本的Scala上.</p></div>
<div class="paragraph"><p>现在你有一个基础的Lift工程, 你可以使用 <span class="monospaced">sbt</span> 命令行. 它将会自动的下载所有需要的依赖库, 和适当的Scala版本, 最后返回一个prompt.</p></div>
<div class="paragraph"><p>然后, 建立以下文件 <span class="monospaced">src/main/webapp/WEB-INF/web.xml</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE web-app SYSTEM &quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;&gt;</span>
<span class="nt">&lt;web-app&gt;</span>
  <span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>LiftFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;display-name&gt;</span>Lift Filter<span class="nt">&lt;/display-name&gt;</span>
    <span class="nt">&lt;description&gt;</span>The Filter that intercepts Lift calls<span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>net.liftweb.http.LiftFilter<span class="nt">&lt;/filter-class&gt;</span>
  <span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>LiftFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/filter-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">web.xml</span> 文件告诉web容器, 比如说Jetty, 把所有的request都传递给Lift.</p></div>
<div class="paragraph"><p>然后,建立简单的 <span class="monospaced">index.html</span> 文件在 <span class="monospaced">src/main/webapp/index.html</span>. 比如:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Lift From Scratch<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome, you now have a working Lift installation<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>最后, 设置基础的Lift启动文件 <span class="monospaced">Boot.scala</span> 在 <span class="monospaced">src/main/scala/bootstrap/Boot.scala</span>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">bootstrap.liftweb</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">Html5Properties</span><span class="o">,</span> <span class="nc">LiftRules</span><span class="o">,</span> <span class="nc">Req</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.sitemap.</span><span class="o">{</span><span class="nc">Menu</span><span class="o">,</span> <span class="nc">SiteMap</span><span class="o">}</span>

<span class="cm">/**</span>
<span class="cm"> * A class that&#39;s instantiated early and run.  It allows the application</span>
<span class="cm"> * to modify lift&#39;s environment</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">Boot</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">boot</span> <span class="o">{</span>
    <span class="c1">// where to search snippet</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">addToPackages</span><span class="o">(</span><span class="s">&quot;org.yourorganization.liftfromscratch&quot;</span><span class="o">)</span>

    <span class="c1">// Build SiteMap</span>
    <span class="k">def</span> <span class="n">sitemap</span><span class="o">()</span><span class="k">:</span> <span class="kt">SiteMap</span> <span class="o">=</span> <span class="nc">SiteMap</span><span class="o">(</span>
      <span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;index&quot;</span>
    <span class="o">)</span>

    <span class="c1">// Use HTML5 for rendering</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">htmlProperties</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">((</span><span class="n">r</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">new</span> <span class="nc">Html5Properties</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">userAgent</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>恭喜, 你现在有一个可以运行的Lift工程了!</p></div>
<div class="paragraph"><p>你现在可以验证是不是有一个可以使用的Lift工程,通过打开Jetty,使用 <span class="monospaced">sbt</span> 命令行的 <span class="monospaced">container:start</span> 命令. 首先 <span class="monospaced">Boot.scala</span> 文件将会编译然后你会被提示, Jetty运行在 <a href="http://localhost:8080">http://localhost:8080</a>. 你应该可以看到你先前建立的 <span class="monospaced">index.html</span> 文件</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_2">Discussion</h4>
<div class="paragraph"><p>就像上边展示的那样,从一个模版建立一个新的Lift工程是一个相当简单的过程. 然而, 这是对一个新手来说非常有诀窍, 特别是你对JVM环境不熟悉, 或者对web容器不熟悉的时候. 如果你遇到任何问题, 请确保文件目录的完整性. 如果还有其他问题, 请到google group里寻求 <a href="http://groups.google.com/group/liftweb">Lift mailing list</a>.</p></div>
<div class="paragraph"><p>Lift使用SBT或者相似的编译工具,编译一个同样架构的工程. 这个架构Scala的源码在 <span class="monospaced">src/main/scala</span> web源码在 <span class="monospaced">src/main/webapp</span>. 你的Scala文件必须都放在 <span class="monospaced">src/main/scala</span> 或者在任何你定义在<span class="monospaced">build.sbt</span> 的organization下, 我们的例子是 <span class="monospaced">src/main/scala/org/yourorganization/liftfromscratch/</span>. 测试文件需要放在 <span class="monospaced">src/test/</span> 而不是 <span class="monospaced">src/main/</span>. 同样,  <span class="monospaced">web.xml</span> 文件必须放在 <span class="monospaced">src/main/webapp/WEB-INF/</span> 才能被容器正确的调用.</p></div>
<div class="paragraph"><p>为了方便, 你需要你的工程像如下架构一样:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>- project root directory
  | build.sbt
  - project/
    | plugins.sbt
  - src/
    - main/
      - scala/
        - bootstrap/
          | Boot.scala
        - org/
          - yourorganization/
            - liftfromscratch/
              | &lt;your Scala code goes here&gt;
      - webapp/
        | index.html
        | &lt;any other web resources - images, HTML, JavaScript, etc - go here&gt;
        - WEB-INF/
          | web.xml
    - test/
      - scala/
        - org/
          - yourorganization/
            - liftfromscratch/
              | &lt;your tests go here&gt;</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_2">See Also</h4>
<div class="paragraph"><p>这里有一个简单的工程你可以直接使用: <a href="https://github.com/bubblefoundry/lift-from-scratch">https://github.com/bubblefoundry/lift-from-scratch</a>.</p></div>
<div class="paragraph" id="texteditor"><p>使用文本编辑器开发</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Problem
^^^^^^^

你想开发Lift应用,使用你喜欢的文档编译器,然后在浏览器中即时的查看修改结果.

Solution
^^^^^^^^

当你修改的时候,运行SBT, 让SBT去检测Scala文件的修改. 为了达到目标, 你需要用命令 `sbt` 然后输入以下命令:

--------------------------------------
~; container:start; container:reload /
--------------------------------------

当你保存文件的时候, SBT会检测到保存的文件是否被修改,然后刷新工程.

Discussion
^^^^^^^^^^

当一个SBT命令使用前缀 `~` 的时候, 意思是, 当文件改变的时候, 执行以下命令.
第一个分号后边继续跟着另一个命令的意思是, 当前一个命令成功后, 执行后边的命令. 在这里, 当
`start` 运行成功后, `reload` 便会在文件改变的时候, 运行.

当你使用这条SBT的命令时, 你会看到以下信息

----------------------------------------------------------
1. Waiting for source changes... (press enter to interrupt)
-----------------------------------------------------------

当你SBT窗口下, 键入enter, 你会退出 _triggered
execution_ 模式 并且 SBT不再监听文件改变. 然而, 当SBT坚挺的时候, 文件改变后
你会看到以下信息:

----------------------------------------------------------------------------------
[info] Compiling 1 Scala source to target/scala-2.9.1/classes...
[success] Total time: 1 s, completed 15-Nov-2012 18:14:46
[pool-301-thread-4] DEBUG net.liftweb.http.LiftServlet - Destroyed Lift handler.
[info] stopped o.e.j.w.WebAppContext{/,[src/main/webapp/]}
[info] NO JSP Support for /, did not find org.apache.jasper.servlet.JspServlet
[info] started o.e.j.w.WebAppContext{/,[src/main/webapp/]}
[success] Total time: 0 s, completed 15-Nov-2012 18:14:46
2. Waiting for source changes... (press enter to interrupt)
----------------------------------------------------------------------------------

修改HTML文件, 不会触发SBT的编译和重载.
这是因为SBT默认的行为是只监听Scala和Java的文件改变, 而且必须在目录`src/main/resources/`下.
这个是没有问题的, 因为Jetty会重载你的HTML文件, 当你刷新页面时

每次修改Scala文件的时候, 重启web容器并不是很理想, 你可以用过使用Jrebel来减少不必要的重启. <<jrebel>>.

然而, 如果你真的有很多的修改, 你最好使用 `container:stop` 命令, 直到你真的准备好了, 然后再用 `container:start`. 这样可以防止SBT一直重启. SBT控制台能查看以前输入过的命令, 通过使用下箭头, 可以翻看以前的命令, 这样可以减少多次输入的麻烦.

你可能在使用过程中看到以下错误:

------------------------------------------
java.lang.OutOfMemoryError: PermGen space
------------------------------------------

这里的 _permanent generation_ 是一个Java虚拟机的概念. 它是内存空间中存放class文件的一个地方 (与其他文件存放在一起). 他是一个固定大小的空间, 所以会出现溢出. 你可以想象, 持续的重启容器会不断的加载,重载class文件, 但是整个过程不是完美的, 所以最好的情况就是, 你把容器停止, 然后当修改完成代码后, 再重启.  如果你经常看到这个错误, 检查以下命令的设置 `-XX:MaxPermSize` 在 `sbt` (or `sbt.bat`) 脚本中, 如果你能修改它, 修改成双倍.

See Also
^^^^^^^^

这里有更多关于触发的信息 http://www.scala-sbt.org/release/docs/Detailed-Topics/Triggered-Execution[http://www.scala-sbt.org/release/docs/Detailed-Topics/Triggered-Execution].

SBT内核命令的引用: http://www.scala-sbt.org/release/docs/Detailed-Topics/Command-Line-Reference[http://www.scala-sbt.org/release/docs/Detailed-Topics/Command-Line-Reference].

SBT web插件的引用: https://github.com/siasia/xsbt-web-plugin/wiki[https://github.com/siasia/xsbt-web-plugin/wiki].


[[jrebel]]
使用 JRebel</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_problem_3">Problem</h4>
<div class="paragraph"><p>当你修改Scala源文件的时候, 通过JRbel. 你将避免重启应用.</p></div>
</div>
<div class="sect3">
<h4 id="_solutions">Solutions</h4>
<div class="paragraph"><p>安装JRbel需要三步, 安装, 每年更新一次Scala的License文件, 设置SBT调用JRebel.</p></div>
<div class="paragraph"><p>首先, 打开 <a href="http://zeroturnaround.com/software/jrebel/">http://zeroturnaround.com/software/jrebel/</a> 获得一个免费的Scala License.</p></div>
<div class="paragraph"><p>其次, 下载 "Generic ZIP Archive" 版本的JRebel, 解压缩并放到一个文件夹下. 在这里, 我使用 <span class="monospaced">/opt/zt/jrebel/</span>.</p></div>
<div class="paragraph"><p>当你收到你的JRebel账户信息时, 你可以复制你的验证token, 它在ZeroTurnaround网站的 "Active" 区域. 为了使用Token在本地, 运行JRbel的设置脚本:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ /opt/zt/jrebel/bin/jrebel-config.sh</pre>
</div></div>
<div class="paragraph"><p>Windows的用户可以使用 <span class="monospaced">bin\jrebel-config.cmd</span>.</p></div>
<div class="paragraph"><p>在 "Activation" 设置里选择 "I want to use myJRebel", 然后在 "License"里, 粘贴你的actionvation token. 点击 "Activate"  按钮, 当你看到你的状态变成 "You have a valid myJRebel token" 点击 "Finish".</p></div>
<div class="paragraph"><p>最后, 设置 SBT, 在 <span class="monospaced">sbt</span> 脚本中开启JRbel.  这意味着设置 <span class="monospaced">-javaagent</span> 和 <span class="monospaced">-noverify</span> Java标签, 然后开启JRebel的Lift插件.</p></div>
<div class="paragraph"><p>对于Mac和Linux, 脚本是在Lift的下载中就有的:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>java -Drebel.lift_plugin=true -noverify -javaagent:/opt/zt/jrebel/jrebel.jar \
 -Xmx1024M -Xss2M -XX:MaxPermSize=512m -XX:+CMSClassUnloadingEnabled -jar \
 `dirname $0`/sbt-launch-0.12.jar "$@"</pre>
</div></div>
<div class="paragraph"><p>对于Windows, 设置 <span class="monospaced">sbt.bat</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>set SCRIPT_DIR=%~dp0
java -Drebel.lift_plugin=true -noverify -javaagent:c:/opt/zt/jrebel/jrebel.jar \
 -XX:+CMSClassUnloadingEnabled -XX:MaxPermSize=256m -Xmx1024M -Xss2M \
 -jar "%SCRIPT_DIR%\sbt-launch-0.12.jar" %*</pre>
</div></div>
<div class="paragraph"><p>这就是配置JRbel所需要的所有设置. 当你开始SBT的时候, 你会看到类似于如下的提示:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#############################################################

  JRebel 5.1.1 (201211271929)
  (c) Copyright ZeroTurnaround OU, Estonia, Tartu.

  Over the last 30 days JRebel prevented
  at least 335 redeploys/restarts saving you about 13.6 hours.
....</pre>
</div></div>
<div class="paragraph"><p>当JRbel启动时, 你可以使用<span class="monospaced">container:start</span> 运行你的应用, 修改和编译Scala文件后会自动重载 你会看到重载的提示类似于如下:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[2012-12-16 23:15:44] JRebel: Reloading class 'code.snippet.HelloWorld'.</pre>
</div></div>
<div class="paragraph"><p>That change is live, without having to restart the container.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_3">Discussion</h4>
<div class="paragraph"><p>JRebel会极大的提高你的开发速度. 他重载一个Java或Scala代码在一个已经运行的JVM中, 并且不需要重启.  你可以只编译一个文件, 当你打开浏览器时, 就会自动的看到新的结果.</p></div>
<div class="paragraph"><p>尽管使用了Jrebel, 你依然需要每次都重启你的应用, 但是JRebel通常会减少重启的次数. 比如说, <span class="monospaced">Boot.scala</span> 在你应用开始时会运行, 所以尽管你使用JRebel, 当你修改它时, 你依然需要重启容器.</p></div>
<div class="paragraph"><p>而且这里还有另外的一些情况下 JRebel是没用的, 比如说一个superclass改变. 一般来说, 这种情况下, JRebel会显示一个提示在命令行.  如果你看到了提示, 你需要停止, 并且重启你的容器.</p></div>
<div class="paragraph"><p>命令 <span class="monospaced">-Drebel.lift_plugin=true</span> 添加Lift的功能性到JRebel.  特别是, 他允许JRebel重载 <span class="monospaced">LiftScreen</span>, <span class="monospaced">Wizard</span> 和 <span class="monospaced">RestHelper</span>. 这意味着你可以改变, fields 或者 screens, 和 REST <span class="monospaced">serve</span> code.</p></div>
<div class="sect4">
<h5 id="_purchased_licenses">Purchased licenses</h5>
<div class="paragraph"><p>在这里, 我们使用的是一个免费的license, 叫做myJRebel. 他通过activation code和JRebel服务器通信.  如果你曾经购买过 ZeroTurnaround 的license, 情况有一些不同. 你会有你的license key 在一个名叫 <span class="monospaced">jrebel.lic</span> 的文件中. 你可以把它放在你Home的 <span class="monospaced">.jrebel</span> 文件夹下. 或者一个叫 <span class="monospaced">jrebel.jar</span> (e.g., in the <span class="monospaced">/opt/zt/jrebel/</span> 的文件夹 如果你安装到这个目录), 或者你曾经安装的特定的目录.  对于其他设置, 改变 <span class="monospaced">sbt</span> 脚本, 并且设置特定目录, 通过使用以下的命令:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>-Drebel.license=/path/to/jrebel.lic</pre>
</div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_3">See Also</h4>
<div class="paragraph"><p>你可以找到更多关于JRebel如何工作的信息在: <a href="http://zeroturnaround.com/software/jrebel/resources/faq/">http://zeroturnaround.com/software/jrebel/resources/faq/</a>.</p></div>
<div class="paragraph"><p>对Lift的支持, 是写在一个2012年的blog中: <a href="http://zeroturnaround.com/jrebel/lift-support-in-jrebel/">http://zeroturnaround.com/jrebel/lift-support-in-jrebel/</a>, 在这里, 你会找到更多的插件.</p></div>
<div class="paragraph" id="eclipse"><p>使用Eclipse开发</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Problem
^^^^^^^

你希望使用Eclipse IDE来开发Lift应用.并且点击浏览器的reload
查看更新.

Solution
^^^^^^^^

使用 "Scala IDE for Eclipse" Eclipse插件. 以下链接有如何配置: http://scala-ide.org[http://scala-ide.org]. 这里有很多的可以选择的地方: (nightly builds, milestones) 但是, 请用一个稳定版本, 这会让你的Eclipse更稳定的支持Scala.

为了建立一个Eclipse自动重载的工程, 你需要安装 "sbteclipse", 这需要配置 `projects/plugins.sbt` 在你的Lift工程中:

[source,scala]
-----------------------------------------------------------------------
addSbtPlugin("com.typesafe.sbteclipse" % "sbteclipse-plugin" % "2.1.2")
-----------------------------------------------------------------------

你可以建立剩下的文件 (`.project` and `.classpath`) 通过以下的命令:

-------
eclipse
-------

打开工程, 然后点击"File > Import.." 然后选择 "General > Existing
Projects into Workspace". 找到, 并且选择你的Lift project. 然后, 你就可以
使用你的Eclipse开发应用了.

如果你想看它是如何工作的, 运行 SBT 在一个单独的窗口. 键入 `sbt` 在任何一个Eclipse外的窗口, 然后键入如下命令:

--------------------------------------
~; container:start; container:reload /
--------------------------------------

这个命令的用法, 在 <<texteditor>> 这里, 但是, 如果你使用JRebel (see <<jrebel>>) 你只需要运行 `container:start` .

然后你就可以保存修改的问题, 然后点击编译, 然后重载你的浏览器, 你会看到更新.

Discussion
^^^^^^^^^^

一个IDE最大的用途之一就是浏览源代码, 通过 cmd+click (Mac) 或者 F3 (PC).
你可以让SBT `eclipse` 下载Lift的源代码和Scaladoc, 你可以通过点击Lift的方法名字和class名字, 查看到Lift的源代码, 这会是学习Lift的一个很好的方法.

你可以通过以下命令来实现它, 在SBT运行 `eclipse with-source=true` , 如果你想把它设置成默认,你需要在 `build.sbt` 文件里添加:

[source,scala]
------------------------------
EclipseKeys.withSource := true
------------------------------

如果你发现你经常使用一些插件, 你也许会希望在全局下声明它, 这样你可以使用它在所有的工程里. 你可以通过以下命令实现它:
建立一个问题 `~/.sbt/plugins/plugins.sbt` 包含以下信息:

[source,scala]
------------------------------------------------------------------------
resolvers += Classpaths.typesafeResolver

addSbtPlugin("com.typesafe.sbteclipse" % "sbteclipse-plugin" % "2.1.2")
------------------------------------------------------------------------

请注意 `resolvers` 和 `addSbtPlugin` 之间的空格.  在 `.sbt` 文件里, 每条语句之间必须有一个空行.

设置全局配置 (比如说 `withSource`) 在 `~/.sbt/global.sbt`.

See Also
^^^^^^^^

还有很多sbteclipse上有用的设置, 你可以在这里找到: https://github.com/typesafehub/sbteclipse/wiki[https://github.com/typesafehub/sbteclipse/wiki]. 你也可以在这里找到更新的插件.

SBT的 `~/.sbt/` 结构在这里有讲解, http://www.scala-sbt.org/release/docs/Getting-Started/Using-Plugins[http://www.scala-sbt.org/release/docs/Getting-Started/Using-Plugins], 在wiki上, 对于全局配置的方法在 http://www.scala-sbt.org/release/docs/Detailed-Topics/Global-Settings[http://www.scala-sbt.org/release/docs/Detailed-Topics/Global-Settings].

[[idea]]
使用IntelliJ IDEA开发</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_problem_4">Problem</h4>
<div class="paragraph"><p>你想要开发Lift应用在 IntelliJ IDEA 环境下.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_3">Solution</h4>
<div class="paragraph"><p>你需要IntelliJ的Scala插件, 和SBT插件去生成一个IDEA的工程.</p></div>
<div class="paragraph"><p>你只需要安装一次IntelliJ的插件, 以下的步骤是对于 IntelliJ IDEA 12的.  安装的细节也许对于不同版本是不同的, 但是大体的思想是下载和使用Scala的插件.</p></div>
<div class="paragraph"><p>在 IntelliJ 的 "Welcome to Intellij IDEA" 界面, 选择 "Configure" 然后选择 "Plugins". 算泽 "Browse repositories&#8230;". 在搜索中, 右上角, 键入 "Scala".  你会发现只有几个会匹配结果: 选择 "Scala".  在右边, 你会看到发行的信息为 "Plugin for Scala language support" 和公司名称为 JetBrains Inc. 选择  "Download and Install"  (或者右键点击,下载).用 "Close" 关闭窗口, 然后点击 OK 推出. IntelliJ将会让你重新启动.</p></div>
<div class="paragraph"><p>当你设置完成后, 你将需要在你的工程里,添加一个SBT的插件, 添加以下命令到 <span class="monospaced">projects/plugins.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">addSbtPlugin</span><span class="o">(</span><span class="s">&quot;com.github.mpeltonen&quot;</span> <span class="o">%</span> <span class="s">&quot;sbt-idea&quot;</span> <span class="o">%</span> <span class="s">&quot;1.3.0&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>打开SBT, 在SBT控制台里输入:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gen-idea</pre>
</div></div>
<div class="paragraph"><p>这个命令会生成 <span class="monospaced">.idea</span> 和 <span class="monospaced">.iml</span> IntelliJ需要的文件. 在IntelliJ中, 你可以直接用以下方式打开工程 "File" 目录, 点 "Open&#8230;" 然后选择你的工程.</p></div>
<div class="paragraph"><p>如果你想看它是如何工作的, 运行 SBT 在一个单独的窗口. 键入 <span class="monospaced">sbt</span> 在任何一个IntelliJ外的窗口, 然后键入如下命令:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>~; container:start; container:reload /</pre>
</div></div>
<div class="paragraph"><p>这个命令的用法, 在 <a href="#texteditor">[texteditor]</a> 这里, 但是, 如果你使用JRebel (see <a href="#jrebel">[jrebel]</a>) 你只需要运行 <span class="monospaced">container:start</span> .</p></div>
<div class="paragraph"><p>每次你编译工程的时候, 容器会自动找到改变的文件, 你在浏览器重载的时候, 你会看到更新.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_4">Discussion</h4>
<div class="paragraph"><p>默认情况下, <span class="monospaced">gen-idea</span> 命令会下载依赖库的源码. 这意味着, 你可以直接点击方法名字或者class名字查看Lift的源码.</p></div>
<div class="paragraph"><p>如果你想使用最新版本的插件, 你需要添加以下命令到 <span class="monospaced">plugin.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">resolvers</span> <span class="o">+=</span> <span class="s">&quot;Sonatype snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/snapshots/&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>如果你想把它设置成全局命令, 请参考 <a href="#eclipse">[eclipse]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_4">See Also</h4>
<div class="paragraph"><p>sbt-idea 插件在 <a href="https://github.com/mpeltonen/sbt-idea">https://github.com/mpeltonen/sbt-idea</a> 没有教你如何配置. 你可以看 <span class="monospaced">notes</span> 文件夹下的文档来作为配置的参考.</p></div>
<div class="paragraph"><p>JetBrains 有一个讲述 Scala plugin 的blog: <a href="http://blog.jetbrains.com/scala/">http://blog.jetbrains.com/scala/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ViewH2">查看lift_proto H2 Database</h3>
<div class="sect3">
<h4 id="_problem_5">Problem</h4>
<div class="paragraph"><p>你使用默认的 <span class="monospaced">lift_proto.db</span> H2 database, 你想查看里面的tables.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_4">Solution</h4>
<div class="paragraph"><p>使用 H2 集成的默认web接口. 请参考以下步骤:</p></div>
<div class="ulist"><ul>
<li>
<p>
找到 H2 JAR 文件. 对于我来说, 它在: <span class="monospaced">~/.ivy2/cache/com.h2database/h2/jars/h2-1.2.147.jar</span>.
</p>
</li>
<li>
<p>
打开一个命令行, 然后用以下命令打开JAR文件: <span class="monospaced">java -cp /path/to/h2-version.jar org.h2.tools.Server</span>
</p>
</li>
<li>
<p>
它会打开你的浏览器, 并且让你登入.
</p>
</li>
<li>
<p>
选择 "Generic H2 Server" 在 "Saved Settings".
</p>
</li>
<li>
<p>
输入 <span class="monospaced">jdbc:h2:/path/to/youapp/lift_proto.db;AUTO_SERVER=TRUE</span> 在 "JDBC URL", 你可以调整你数据库的URL和名字, 默认是("lift_proto.db") .
</p>
</li>
<li>
<p>
点击 "Connect" 查看你当前的数据库.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_discussion_5">Discussion</h4>
<div class="paragraph"><p>默认的Lift工程包含一个数据库, 比如 <span class="monospaced">lift_basic</span>, 使用的是 H2 relational database, 因为它可以不需要特别的配置, 只需要添加依赖库就可以使用. 它是一个非常不错的工程,  尽管生产环境下, 一般使用独立的数据库, 比如 PostgreSQL 或者 MySQL.</p></div>
<div class="paragraph"><p>尽管你部署的时候, 也许使用的是非H2数据库, 但是我们希望你能保留H2, 因为它的 in-memory 功能很适合测试, 它不会把文件存在本地, 你可以直接删除它, 当你不需要再测试.</p></div>
<div class="paragraph"><p>如果你不喜欢web接口, 你可以使用它的连接设置, 连接其他的SQL数据库工具.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_5">See Also</h4>
<div class="paragraph"><p>H2数据库的特性:  <a href="http://www.h2database.com">http://www.h2database.com</a>.</p></div>
<div class="paragraph"><p>如果你经常使用命令行, 请考虑确保它能访问. Diego Medina 在他的博客中描述了如何操作 <a href="https://fmpwizard.telegr.am/blog/lift-and-h2">https://fmpwizard.telegr.am/blog/lift-and-h2</a>.</p></div>
<div class="paragraph"><p>Lift的例子工程使用 <a href="#Squeryl">[Squeryl]</a> 里开启了H2的命令行. 源代码在: <a href="https://github.com/LiftCookbook/cookbook_squeryl">https://github.com/LiftCookbook/cookbook_squeryl</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="snapshot">使用最新的Lift</h3>
<div class="sect3">
<h4 id="_problem_6">Problem</h4>
<div class="paragraph"><p>你想使用 ("snapshot") 版本的 Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_5">Solution</h4>
<div class="paragraph"><p>你需要改变两个地方在 <span class="monospaced">build.sbt</span> 文件. 首先, 添加依赖库:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">resolvers</span> <span class="o">+=</span> <span class="s">&quot;snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/snapshots&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>然后, 修改 <span class="monospaced">liftVersion</span> 的参数. 比如说, 使用 2.5-SNAPSHOT 版本的 Lift:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-SNAPSHOT&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>重启 SBT (或者使用 <span class="monospaced">reload</span> 命令) 会触发下载.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_6">Discussion</h4>
<div class="paragraph"><p>生产版本的Lift (e.g., "2.4", "2.5"),和 milestone releases
(e.g., "2.5-M3") 和 release candidates (e.g., "2.5-RC1") 被发布在一个依赖库目录下. 所以当SBT下载他们的时候, 只需要下载一次.</p></div>
<div class="paragraph"><p>Snapshot releases 是不同的: 他们是自动生成的, 并且经常改变. 你可以让SBT强制
使用他们通过 <span class="monospaced">clean</span> 然后 <span class="monospaced">update</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_6">See Also</h4>
<div class="paragraph"><p>如果你看关于 SNAPSHOT 版本的细节, 请看 at <a href="http://www.sonatype.com/books/mvnref-book/reference/pom-relationships-sect-pom-syntax.html">http://www.sonatype.com/books/mvnref-book/reference/pom-relationships-sect-pom-syntax.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="NewScala">使用新版本Scala</h3>
<div class="sect3">
<h4 id="_problem_7">Problem</h4>
<div class="paragraph"><p>当一个新版本的Scala被释放出后, 你想第一时间使用它在你的Lift工程.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_6">Solution</h4>
<div class="paragraph"><p>你会找到最新的snapshot版本的lift使用最新版本的Scala. 不过, 也许你更希望是等待一个稳定版本.
提供最新版本的Scala是 <em>binary compatible</em>. 不过你可以通过修改Build文件, 强制使用最新版本.</p></div>
<div class="paragraph"><p>比如说, 假设你的<span class="monospaced">build.sbt</span> 文件 设置的是使用 Lift 2.5
和 Scala 2.9.1:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">&quot;2.9.1&quot;</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span> <span class="o">%</span> <span class="s">&quot;compile-&gt;default&quot;</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>假设你现在想使用Scala 2.9.2 但是 Lift 2.5 只支持
 Scala 2.9.1. 替换 <span class="monospaced">%%</span> 成 <span class="monospaced">%</span> 在 `net.liftweb`上, 可以强制使用新的版本:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">&quot;2.9.2&quot;</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%</span> <span class="s">&quot;lift-webkit_2.9.1&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span> <span class="o">%</span> <span class="s">&quot;compile-&gt;default&quot;</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>这里我们改变的是 <span class="monospaced">scalaVersion</span>, 变成一个新的版本, 但是明确的说,我们希望使用 2.9.1 Scala 版本.
如果两个版本的Scala是 binary compatible 那么这个是有效的.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_7">Discussion</h4>
<div class="paragraph"><p>依赖库通常都有自己的命名方法.  比如说, <span class="monospaced">lift-webkit</span> 库, 对于 Lift 2.5-RC2 被叫做 <span class="monospaced">lift-webkit_2.9.1-2.5-RC2.jar</span>.  一般来说, 在 <span class="monospaced">build.sbt`我们简单的使用 `"net.liftweb" %% "lift-webkit"</span> , SBT会把他变成文件的名字, 然后下载它.</p></div>
<div class="paragraph"><p>然而, 在这里我们强制SBT下载, 使用Scala的 2.9.1 version, 而不是让它自己计算下载文件的名字. 这就是, 在一个依赖库上, 使用 <span class="monospaced">%%</span> 和 <span class="monospaced">%</span> 的区别: 使用 <span class="monospaced">%%</span> 你不需要制定Scala的版本. SBT会自动的添加 <span class="monospaced">scalaVersion</span> 到文件名上; 当使用 <em>%</em> SBT将不会自动添加, 所以我们必须自己添加更精确的库的名字.</p></div>
<div class="paragraph"><p>请记住, 这只是能使用在Scala小版本上: 每个大版本的释放, 都会打破兼容性. 比如说 Scala 2.9.1 兼容 Scala 2.9.0, 但是不兼容 2.10.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_7">See Also</h4>
<div class="paragraph"><p>Scala二进制兼容性, 在Scala用户的mailing list: <a href="http://article.gmane.org/gmane.comp.lang.scala.user/39290">http://article.gmane.org/gmane.comp.lang.scala.user/39290</a>.</p></div>
<div class="paragraph"><p>SBT的配置在: <a href="http://www.scala-sbt.org/release/docs/Getting-Started/Library-Dependencies">http://www.scala-sbt.org/release/docs/Getting-Started/Library-Dependencies</a>.</p></div>
<div class="paragraph"><p><a href="#snapshot">[snapshot]</a> 讲述了如何使用snapshot版本的Lift.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="HTML">HTML</h2>
<div class="sectionbody">
<div class="paragraph"><p>生成HTML文件, 通常是一个web应用的主要组件.  这章主要介绍Lift的 <em>View First</em> 设计模式 以及如何使用 <em>CSS Selectors</em>.后几章主要专注于表格的处理, REST web服务, JavaScript, Ajax 和 Comet.</p></div>
<div class="paragraph"><p>你可以在这里找到本章的Code: <a href="https://github.com/LiftCookbook/cookbook_html">https://github.com/LiftCookbook/cookbook_html</a>.</p></div>
<div class="sect2">
<h3 id="TestingAndDebuggingSelectors">测试一个 CSS Selecltor</h3>
<div class="sect3">
<h4 id="_problem_8">Problem</h4>
<div class="paragraph"><p>你想互动地, 探索和debug CSS selectors.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_7">Solution</h4>
<div class="paragraph"><p>你可以使用Scala REPL来运行你的 CSS selectors.</p></div>
<div class="paragraph"><p>这里有一个我们测试 CSS selector 的例子,通过添加一个 <em>href</em> 属性到一个链接中.
在运行的SBT控制台中输入 `console`命令, 打开REPL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; console
[info] Starting scala interpreter...
[info]
Welcome to Scala version 2.9.1.final
Type in expressions to have them evaluated.
Type :help for more information.</pre>
</div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="s">&quot;a [href]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;http://example.org&quot;</span>
<span class="n">f</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span> <span class="o">=</span>
  <span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="n">a</span> <span class="o">[</span><span class="kt">href</span><span class="o">]),</span> <span class="nc">Full</span><span class="o">(</span><span class="nc">ElemSelector</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="nc">Full</span><span class="o">(</span><span class="nc">AttrSubNode</span><span class="o">(</span><span class="n">href</span><span class="o">)))))</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">in</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="n">click</span> <span class="n">me</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="n">in</span><span class="k">:</span> <span class="kt">scala.xml.Elem</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="n">click</span> <span class="n">me</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span>
  <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://example.org&quot;</span><span class="o">&gt;</span><span class="n">click</span> <span class="n">me</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">Helpers._</span> 载入了 CSS Selector 的功能, 我們可以通过创建一个新的selector去测试它, 你可以让它调用一个简单的模版, 然后观察结果.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_8">Discussion</h4>
<div class="paragraph"><p>CSS selector transforms 是Lift与其他架构不同的地方之一. 它简单的声明一个html node (左手边的部分) 然后取代它(右手边的方程). 学习它需要很长时间, 所以我们推荐使用REPL这种更直观的方法.</p></div>
<div class="paragraph"><p>你需要知道 CSS selectors 中的Lift snippet是一个方法: 输入一个 <span class="monospaced">NodeSeq</span> 然后, 返回一个 <span class="monospaced">NodeSeq</span>, 通过方法 <span class="monospaced">bind</span>. Lift将会使用你的HTML模版, 作为输入的 <span class="monospaced">NodeSeq</span>, 通过方程的转化, 返回一个新的 <span class="monospaced">NodeSeq</span>. 虽然你不会看到bind方程(已经被#&gt;替代), 但是它使用的概念是一样的.</p></div>
<div class="paragraph"><p>Lift中的CSS selector 功能有一个方法 <span class="monospaced">CssSel</span>, 他是一个 <span class="monospaced">NodeSeq =&gt; NodeSeq</span>. 在上一个例子中, 我们利用它去建立一个输入的
<span class="monospaced">NodeSeq</span> (名为 <span class="monospaced">in</span>), 然后建立一个CSS方程 (叫做 <span class="monospaced">f</span>).  因为我们知道<span class="monospaced">CssSel</span>
是一个为`NodeSeq &#8658; NodeSeq`的方法, 所以最直接使用 selector 的方法是提供一个名为 <span class="monospaced">in</span> 的参数, 然后它会返回我们需要的结果, 为 <span class="monospaced">res0</span>.</p></div>
<div class="paragraph"><p>如果你的IDE支持 <em>worksheet</em>, Eclipse 和 IntelliJ IDEA 都支持, 你可以在worksheet中查看结果.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_8">See Also</h4>
<div class="paragraph"><p>selector的语法在这里有更好的解释: <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SequencingSelectorOps">连续的CSS Selector操作</h3>
<div class="sect3">
<h4 id="_problem_9">Problem</h4>
<div class="paragraph"><p>你希望你的 CSS selector binding 使用在另一个binding 表达式前.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_8">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">andThen</span> 而不是 <span class="monospaced">&amp;</span> 在你的 selector 表达式上.</p></div>
<div class="paragraph"><p>比如说, 我们希望替换 <span class="monospaced">&lt;div id="foo"/&gt;</span> 成
<span class="monospaced">&lt;div id="bar"&gt;bar content&lt;/div&gt;</span>, 但是因为一些原因, 我们需要生成 <span class="monospaced">bar</span> div 作为一个独立的过程在 selector 表达式中:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>sbt&gt; console
[info] Starting scala interpreter...
[info]
Welcome to Scala version 2.9.1.final (Java 1.7.0_05).
Type in expressions to have them evaluated.
Type :help for more information.</pre>
</div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;#foo&quot;</span> <span class="o">#&gt;</span> <span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="o">/&gt;</span> <span class="n">andThen</span> <span class="s">&quot;#bar *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;bar content&quot;</span>
<span class="n">render</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=&gt;</span> <span class="n">scala</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="nc">NodeSeq</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">render</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="o">/&gt;)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="o">&gt;</span><span class="n">bar</span> <span class="n">content</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_9">Discussion</h4>
<div class="paragraph"><p>当你使用 <span class="monospaced">&amp;</span> 时, 想象 CSS selectors 永远是使用你原本的HTML模版, 不管你用的是什么样的表达式.
这是因为 <span class="monospaced">&amp;</span> 把所有的表达式集合起来, 然后一起使用他们; 反之 <span class="monospaced">andThen</span> 是把Scala方法放在一起, 然后一个一个的调用, 位于后边的方法会等待前边的方法调用完成后, 才调用.</p></div>
<div class="paragraph"><p>如果在上面的例子中, 我们替换 <span class="monospaced">andThen</span> 成
<span class="monospaced">&amp;</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;#foo&quot;</span> <span class="o">#&gt;</span> <span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span> <span class="o">/&gt;</span> <span class="o">&amp;</span> <span class="s">&quot;#bar *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;bar content&quot;</span>
<span class="n">render</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">render</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="o">/&gt;)</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>第二个表达式将不会被匹配, 因为它使用第一个表达式原先的HTML, <span class="monospaced">&lt;div id="foo"/&gt;</span>.所以选择器 <span class="monospaced">#bar</span> 找不到匹配的对象,
返回的 <span class="monospaced">render</span> 没有任何结果.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_9">See Also</h4>
<div class="paragraph"><p>Lift Wiki 里的 CSS Selectors 也叙述了如何使用 <span class="monospaced">andThen</span>: <a href="https://www.assembla.com/spaces/liftweb/wiki/Binding_via_CSS_Selectors">https://www.assembla.com/spaces/liftweb/wiki/Binding_via_CSS_Selectors</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SetMetaTag">设置Meta Tag</h3>
<div class="sect3">
<h4 id="_problem_10">Problem</h4>
<div class="paragraph"><p>你想在Lift中添加Meta tag在你的HTML文件.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_9">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">@</span> CSS binding name selector. 比如:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;keywords&quot;</span> <span class="na">content=</span><span class="s">&quot;words, here, please&quot;</span> <span class="nt">/&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>下面的代码会更新HTLM的meta的值:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;@keywords [content]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;words, we, really, want&quot;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_10">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">@</span> selector 选择包含给于名称的所有的元素. 它在这里用来改变 <span class="monospaced">&lt;meta name="keyword"&gt;</span> tag, 不过你也会看到它被用在其他地方. 比如说,在一个HTML表格中, 你可以选择 <span class="monospaced">&lt;input name="address"&gt;</span> 通过使用 <span class="monospaced">"@address"</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">[content]</span> 部分是一个关于 <em>replacement rule</em> 的例子, 它是一个在selector后的选择.  在这个例子中, 它用来替换一个名为 "content" 的元素的特定属性的值(这里指得是, keywords).  如果meta tag 没有 "content" 属性, 它将会被添加.</p></div>
<div class="paragraph"><p>还有另外两个有用的替换法则,用来修改属性:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">[content!]</span>&#8201;&#8212;&#8201;删除一个特定属性的值.
</p>
</li>
<li>
<p>
<span class="monospaced">[content+]</span>&#8201;&#8212;&#8201;添加一个值.
</p>
</li>
</ul></div>
<div class="paragraph"><p>以下是使用的例子:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">in</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s">&quot;words, here, please&quot;</span> <span class="o">/&gt;</span>
<span class="n">in</span><span class="k">:</span> <span class="kt">scala.xml.Elem</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s">&quot;words, here, please&quot;</span><span class="o">&gt;&lt;/</span><span class="n">meta</span><span class="o">&gt;</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">remove</span> <span class="k">=</span> <span class="s">&quot;@keywords [content!]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;words, here, please&quot;</span>
<span class="n">remove</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span> <span class="o">=</span> <span class="nc">CssBind</span><span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="nd">@keywords</span> <span class="o">[</span><span class="kt">content!</span><span class="o">]),</span>
  <span class="nc">Full</span><span class="o">(</span><span class="nc">NameSelector</span><span class="o">(</span><span class="n">keywords</span><span class="o">,</span><span class="nc">Full</span><span class="o">(</span><span class="nc">AttrRemoveSubNode</span><span class="o">(</span><span class="n">content</span><span class="o">)))))</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">remove</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span><span class="o">&gt;&lt;/</span><span class="n">meta</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;和&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">add</span> <span class="k">=</span> <span class="s">&quot;@keywords [content+]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;, thank you&quot;</span>
<span class="n">add</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span> <span class="o">=</span> <span class="nc">CssBind</span><span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="nd">@keywords</span> <span class="o">[</span><span class="kt">content+</span><span class="o">]),</span>
  <span class="nc">Full</span><span class="o">(</span><span class="nc">NameSelector</span><span class="o">(</span><span class="n">keywords</span><span class="o">,</span><span class="nc">Full</span><span class="o">(</span><span class="nc">AttrAppendSubNode</span><span class="o">(</span><span class="n">content</span><span class="o">)))))</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">add</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">meta</span> <span class="n">content</span><span class="o">=</span><span class="s">&quot;words, here, please, thank you&quot;</span>
  <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span><span class="o">&gt;&lt;/</span><span class="n">meta</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="sect4">
<h5 id="_appending_to_a_span_class_monospaced_class_span_attribute">Appending to a <span class="monospaced">class</span> Attribute</h5>
<div class="paragraph"><p>尽管没有与 <span class="monospaced">meta</span> tags 的直接联系, 你应该知道这是一种, 添加属性和值的更简单的方法. 如果属性是一个 <span class="monospaced">class</span>, 一个空格会自动添加到你的classs值之间. 下面是一个示范, 它添加一个 "btn-primary" 属性到一个 <span class="monospaced">div</span> node:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;div [class+]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;btn-primary&quot;</span>
<span class="n">render</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">render</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;btn&quot;</span><span class="o">/&gt;)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;)</span>
</pre></div></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_10">See Also</h4>
<div class="paragraph"><p>这里有对selector的语法更好的说明: <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
<div class="paragraph"><p>在这里 <a href="#TestingAndDebuggingSelectors">[TestingAndDebuggingSelectors]</a>, 你可以找到如何运行selector在REPL下.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SetPageTitle">设置Title</h3>
<div class="sect3">
<h4 id="_problem_11">Problem</h4>
<div class="paragraph"><p>你想在Lift中设置页面的 <span class="monospaced">&lt;title&gt;</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_10">Solution</h4>
<div class="paragraph"><p>选择所有包含 <span class="monospaced">title</span> 的元素, 然后替换成你想要的文本:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;title *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;I am different&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>假设, 你有一个 <span class="monospaced">&lt;title&gt;</span> tag 在你的HTML模版中, 上面的code有如下结果:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>I am different<span class="nt">&lt;/title&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_11">Discussion</h4>
<div class="paragraph"><p>这个例子用了一个element selector, 它会找到HTML模版中的tags, 然后替换成你想要的.</p></div>
<div class="paragraph"><p>另一个可供选择的是, 你也可以在 <span class="monospaced">SiteMap</span> 设置你页面的title,
这意味着, 你可以给你所有的页面自由分配一个title在sitemap中.
你需要使用 <span class="monospaced">Menu.title</span> 在你的模版目录下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;Menu.title&quot;</span><span class="nt">&gt;&lt;/title&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">Menu.title</span> 代码添加到所有现存的文本到title中.
这意味着, 下面的例子会有 "Site Title - " 在title的前边:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;Menu.title&quot;</span><span class="nt">&gt;</span>Site Title - <span class="nt">&lt;/title&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>如果你需要更多的操作, 你可以在你的代码中, 绑定(bind) <span class="monospaced">&lt;title&gt;</span> 到一个普通的snippet里. 下面是一个使用的例子:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;MyTitle&quot;</span><span class="nt">&gt;&lt;/title&gt;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">MyTitle</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">Menu.title</span> <span class="kt">/&gt;</span> <span class="kt">-</span> <span class="kt">Site</span> <span class="kt">Title&lt;/title&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_11">See Also</h4>
<div class="paragraph"><p>在 <a href="https://www.assembla.com/spaces/liftweb/wiki/SiteMap">https://www.assembla.com/spaces/liftweb/wiki/SiteMap</a> 有更多关于Site Map 和 <span class="monospaced">Menu</span> 代码的示范.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ConditionalIncludes">HTML的注释</h3>
<div class="sect3">
<h4 id="_problem_12">Problem</h4>
<div class="paragraph"><p>你想使用Internet Explorer HTML conditional comments在你的代码中.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_11">Solution</h4>
<div class="paragraph"><p>把修饰的代码放到一个snippet中, 然后包含snippet在你的页面里.</p></div>
<div class="paragraph"><p>比如说, 假设我们想使用 HTML5 Shiv (比如. HTML5 Shim) JavaScript, 为了我们可以使用HTML5元素在老版本的IE中.  以下是示例:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">scala.xml.Unparsed</span>

<span class="k">object</span> <span class="nc">Html5Shiv</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="nc">Unparsed</span><span class="o">(</span><span class="s">&quot;&quot;&quot;&lt;!--[if lt IE 9]&gt;</span>
<span class="s">    &lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;</span>
<span class="s">    &lt;/script&gt;&lt;![endif]--&gt;&quot;&quot;&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>然后我们引用这段代码在 <span class="monospaced">&lt;head&gt;</span> 标签中, 也可以放进模版 `templates-hidden/default.html`中:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">data-lift=</span><span class="s">&quot;Html5Shiv&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_12">Discussion</h4>
<div class="paragraph"><p>Lift中的HTML5解析不包含已经生成了的页面的comments. 如果你只是想粘贴 <em>html5shim</em> 修饰到你的模版中, 你会发现, 你的页面会找不到它.</p></div>
<div class="paragraph"><p>我们通过解析未修饰的模版去解决这个问题. 如果你看到 <span class="monospaced">未解析</span> 然后松了一口气, 你的直觉是对的.
一般情况下, Lift会使用已经解析好的了模版然后套用代码, 但是在这里例子中, 我们希望的是一段未解析的 XML 内容(the comment tag) 并且输出它.</p></div>
<div class="paragraph"><p>如果你发现, 你经常使用 IE conditional comments, 你需要建立一个更普遍的snippet.
比如说:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">xml.</span><span class="o">{</span><span class="nc">NodeSeq</span><span class="o">,</span> <span class="nc">Unparsed</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>

<span class="k">object</span> <span class="nc">IEOnly</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">condition</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
    <span class="n">S</span><span class="o">.</span><span class="n">attr</span><span class="o">(</span><span class="s">&quot;cond&quot;</span><span class="o">)</span> <span class="n">openOr</span> <span class="s">&quot;IE&quot;</span>

  <span class="k">def</span> <span class="n">render</span><span class="o">(</span><span class="n">ns</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span> <span class="k">:</span> <span class="kt">NodeSeq</span> <span class="o">=</span>
    <span class="nc">Unparsed</span><span class="o">(</span><span class="s">&quot;&lt;!--[if &quot;</span> <span class="o">+</span> <span class="n">condition</span> <span class="o">+</span> <span class="s">&quot;]&gt;&quot;</span><span class="o">)</span> <span class="o">++</span> <span class="n">ns</span> <span class="o">++</span> <span class="nc">Unparsed</span><span class="o">(</span><span class="s">&quot;&lt;![endif]--&gt;&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>它将使用在如下&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;IEOnly&quot;</span><span class="nt">&gt;</span>
  A div just for IE
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;然后生成以下输入:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c">&lt;!--[if IE]&gt;&lt;div&gt;</span>
<span class="c">  A div just for IE</span>
<span class="c">&lt;/div&gt;&lt;![endif]--&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>请注意 <span class="monospaced">condition</span> 测试默认是对"IE", 但是首先, 请看属性 "cond". 它允许你写入:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;IEOnly?cond=lt+IE+9&quot;</span><span class="nt">&gt;</span>
  You&#39;re using IE 8 or earlier
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">+</span> 符号用来进行 URL 编码, 作为一个空格, 结果:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;&lt;div&gt;</span>
<span class="c">  You&#39;re using IE 8 or earlier</span>
<span class="c">&lt;/div&gt;&lt;![endif]--&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_12">See Also</h4>
<div class="paragraph"><p><span class="monospaced">IEOnly</span> 的例子是 Antonio Salazar Cardozo 在有Mail List上提出的: <a href="https://groups.google.com/d/msg/liftweb/kLzcJwfIqHQ/K91MdtoNz0MJ">https://groups.google.com/d/msg/liftweb/kLzcJwfIqHQ/K91MdtoNz0MJ</a>.</p></div>
<div class="paragraph"><p>Html5Shim可以在找到: <a href="http://code.google.com/p/html5shim/">http://code.google.com/p/html5shim/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="PassThru">返回一个没有改变的makeup</h3>
<div class="sect3">
<h4 id="_problem_13">Problem</h4>
<div class="paragraph"><p>你想一个snippet返回它修饰前的代码.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_12">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">PassThru</span> .</p></div>
<div class="paragraph"><p>比如说, 假设, 在某下条件达成下, 你有一个执行一些转化的snippet, 但是在没达成下, 你希望返回原先的html markup.</p></div>
<div class="paragraph"><p>从原先的markup开始&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;h2&gt;</span>Pass Thru Example<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;p&gt;</span>There&#39;s a 50:50 chance of seeing &quot;Try again&quot; or &quot;Congratulations!&quot;:<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;PassThruSnippet&quot;</span><span class="nt">&gt;</span>
  Try again - this is the template content.
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;我们可以通过以下snippet, 保留它, 或者修改它:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.PassThru</span>

<span class="k">import</span> <span class="nn">scala.util.Random</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">class</span> <span class="nc">PassThruSnippet</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">fiftyFifty</span> <span class="k">=</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextBoolean</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fiftyFifty</span><span class="o">)</span> <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Congratulations! The content was changed&quot;</span><span class="o">)</span>
    <span class="k">else</span> <span class="nc">PassThru</span>

<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_13">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">PassThru</span> 是一个 <em>identity function</em>, 它的类型为 <span class="monospaced">NodeSeq =&gt; NodeSeq</span>. 它返回它输入的NodeSeq:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">PassThru</span> <span class="k">extends</span> <span class="nc">Function1</span><span class="o">[</span><span class="kt">NodeSeq</span>, <span class="kt">NodeSeq</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span><span class="k">:</span> <span class="kt">NodeSeq</span> <span class="o">=</span> <span class="n">in</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>一个相关的例子未 <span class="monospaced">ClearNodes</span> :</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">ClearNodes</span> <span class="k">extends</span> <span class="nc">Function1</span><span class="o">[</span><span class="kt">NodeSeq</span>, <span class="kt">NodeSeq</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span><span class="k">:</span> <span class="kt">NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">.</span><span class="nc">Empty</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>转化一个 <span class="monospaced">NodeSeq</span> 到另一个 <span class="monospaced">NodeSeq</span> 是非常简单的, 但是它能强大到让你肆意的更改, 重写<span class="monospaced">NodeSeq</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SnippetNotFound">使用HTML5, 出现没找到Snippet</h3>
<div class="sect3">
<h4 id="_problem_14">Problem</h4>
<div class="paragraph"><p>你使用Lift 和 HTML5解析, 你的snippet之一发生了 "Class Not Found" 错误. 它发生在 <span class="monospaced">&lt;lift:HelloWorld.howdy /&gt;</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_13">Solution</h4>
<div class="paragraph"><p>请使用新的 designer-friendly 机制.  例如:,</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;HellowWorld.howdy&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_14">Discussion</h4>
<div class="paragraph"><p>HTML5解析和原始的Lift XHTML解析有很多不同. 事实上, HTML5解析转化所有的元素和属性到小写字母. 这意味着, Lift看到 <span class="monospaced">&lt;lift:HelloWorld.howdy /&gt;</span> 然后查找 "helloworld" 而不是 "HelloWorld", 这会造成一个 "Class Not Found Error".</p></div>
<div class="paragraph"><p>通过使用 designer-friendly 机制, 这个问题可以解决, 并且你还免费的得到了验证HTML文件的功能.</p></div>
<div class="paragraph"><p>在这里, 我们使用HTML5 解析, 它被设置在 <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Use HTML5 for rendering</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">htmlProperties</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span> <span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="k">new</span> <span class="nc">Html5Properties</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">userAgent</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_13">See Also</h4>
<div class="paragraph"><p>在 XHTML 和 HTML5 解析中最大的不同, 请看: <a href="https://groups.google.com/d/msg/liftweb/H-xe1uRLW1c/B60UH8P54VAJ">https://groups.google.com/d/msg/liftweb/H-xe1uRLW1c/B60UH8P54VAJ</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AvoidAssetCaching">避免 CSS 和 JavaScript缓存</h3>
<div class="sect3">
<h4 id="_problem_15">Problem</h4>
<div class="paragraph"><p>你正在修改你應用的 CSS 或者 JavaScript, 但是浏览器缓存了你应用以前的版本. 你想停止缓存.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_14">Solution</h4>
<div class="paragraph"><p>添加 <span class="monospaced">with-resource-id</span> data-lift 属性到你的脚本中,或者链接中:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">data-lift=</span><span class="s">&quot;with-resource-id&quot;</span> <span class="na">src=</span><span class="s">&quot;/myscript.js&quot;</span>
 <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>通过使用这个属性, Lift将会添加 "resource id" 到你的 <span class="monospaced">src</span> (或者 <span class="monospaced">href</span>), 每次Lift重新启动, 它将生成一个单独的id, 这确保了浏览器不缓存它.</p></div>
<div class="paragraph"><p>生成的HTML, 如下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/myscript.js?F619732897824GUCAAN=_&quot;</span>
  <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_15">Discussion</h4>
<div class="paragraph"><p>当你的Lift重启的时候, 一个随机的值会添加到你的资源后. 这意味着每次你更新时, 你将会确保看到新的内容.</p></div>
<div class="paragraph"><p>如果你需要使用 <span class="monospaced">with-resource-id</span> 在别的地方, 你可以配置一个 <span class="monospaced">String =&gt; String</span> 到
<span class="monospaced">LiftRules.attachResourceId</span>. 默认的实现,就像上边的 "/myscript.js" 一样, 然后它会返回你资源的名字, 并且附加一个id.</p></div>
<div class="paragraph"><p>你也可以包含很多的tags, 通过使用<span class="monospaced">&lt;lift:with-resource-id&gt;...&lt;lift:with-resource-id&gt;</span> 语句. 然而, 不要在 <span class="monospaced">&lt;head&gt;</span> 里做这些, 因为HTML5解析会把head以外的tag删除.</p></div>
<div class="paragraph"><p>请注意, 一些代理默认情况下, 不会给有id的文件, 做任何缓存. 如果这个影响到你, 你可以写一段代码, 将自动生成的id移出文件名, 放到文件路径下.</p></div>
<div class="paragraph"><p>这里有一个例子教你如何实现. 与其生成一个有id后缀的文件 <span class="monospaced">/assets/style.css?F61973</span>, 我们将生成 <span class="monospaced">/cache/F61973/assets/style.css</span>. 我们将告诉Lift, 使用新的格式, 并且找到正确的文件. 以下是代码:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">net.liftweb.util._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http._</span>

<span class="k">object</span> <span class="nc">CustomResourceId</span> <span class="o">{</span>

 <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="c1">// The random number we&#39;re using to avoid caching</span>
  <span class="k">val</span> <span class="n">resourceId</span> <span class="k">=</span> <span class="nc">Helpers</span><span class="o">.</span><span class="n">nextFuncName</span>

  <span class="c1">// Prefix with-resource-id links with &quot;/cache/{resouceId}&quot;</span>
  <span class="nc">LiftRules</span><span class="o">.</span><span class="n">attachResourceId</span> <span class="k">=</span> <span class="o">(</span><span class="n">path</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
   <span class="s">&quot;/cache/&quot;</span> <span class="o">+</span> <span class="n">resourceId</span> <span class="o">+</span> <span class="n">path</span>
  <span class="o">}</span>

  <span class="c1">// Remove the cache/{resourceId} from the request if there is one</span>
  <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessRewrite</span><span class="o">.</span><span class="n">prepend</span><span class="o">(</span> <span class="nc">NamedPF</span><span class="o">(</span><span class="s">&quot;BrowserCacheAssist&quot;</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">case</span> <span class="nc">RewriteRequest</span><span class="o">(</span><span class="nc">ParsePath</span><span class="o">(</span><span class="s">&quot;cache&quot;</span> <span class="o">::</span> <span class="n">id</span> <span class="o">::</span> <span class="n">file</span><span class="o">,</span> <span class="n">suffix</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">),</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">RewriteResponse</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">suffix</span><span class="o">)</span>
  <span class="o">})</span>

 <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>这些代码是在 <span class="monospaced">Boot.scala</span> 中的&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">CustomResourceId</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>通过使用上面的代码, 我们能, 比如说, 修改 <span class="monospaced">templates-hidden/default.html</span> 并且添加一个源码id到Jquery, 如下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jquery&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;with-resource-id&quot;</span>
  <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>上面的代码会生成以下HTML:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">id=</span><span class="s">&quot;jquery&quot;</span>
  <span class="na">src=</span><span class="s">&quot;/cache/F352555437877UHCNRW/classpath/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>大多数操作都在 <span class="monospaced">statelessRewrite</span> 中, 它在Lift的底层处理. 它包含两个部分:</p></div>
<div class="ulist"><ul>
<li>
<p>
一个 <span class="monospaced">RewriteRequest</span> 我们用来做匹配; 和
</p>
</li>
<li>
<p>
一个 <span class="monospaced">RewriteResponse</span> 我们希望匹配的结果.
</p>
</li>
</ul></div>
<div class="paragraph"><p>首先请看 <span class="monospaced">RewriteRequest</span> , 它需要三个参数: 路径, 方法 (比如说, <span class="monospaced">GetRequest</span>, <span class="monospaced">PutRequest</span>, 等等) 和 <span class="monospaced">HTTPRequest</span> 它自己.  在路径中, 我们希望找到匹配开始为 "cache"的语句, 并且后边跟着一些东西(是什么,我们并不在意), 然后其他的不分, 代表了名字 <span class="monospaced">file</span>. 在这个情况下, 我们重写原先的路径, 就是 <span class="monospaced">file</span> 和 <span class="monospaced">suffix</span>, 然后删除<span class="monospaced">/cache/F352555437877UHCNRW</span> 部分.  这就是Lift如何做的.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_14">See Also</h4>
<div class="paragraph"><p>源码关于 <span class="monospaced">LiftRules</span> 展示了`attachResourceId`的默认的实现 : <a href="https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/LiftRules.scala">https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/LiftRules.scala</a>.</p></div>
<div class="paragraph"><p>Google的 <em>Optimize caching</em> 是一个很好的学习浏览器行为的资源: <a href="https://developers.google.com/speed/docs/best-practices/caching">https://developers.google.com/speed/docs/best-practices/caching</a>.</p></div>
<div class="paragraph"><p>你可以学到更多关于 URL 重写在Lift wiki: <a href="https://www.assembla.com/spaces/liftweb/wiki/URL_Rewriting">https://www.assembla.com/spaces/liftweb/wiki/URL_Rewriting</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AddToHead">添加语句到Head中</h3>
<div class="sect3">
<h4 id="_problem_16">Problem</h4>
<div class="paragraph"><p>你的代码使用了一个模版, 不过你想在其中特定的页面添加 <span class="monospaced">&lt;head&gt;</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_15">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">head</span> snippet 或者 CSS class 才能让Lift整合你页面的 <span class="monospaced">&lt;head&gt;</span>.比如说, 假设你有以下HTML在 <span class="monospaced">templates-hidden/default.html</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">xmlns:lift=</span><span class="s">&quot;http://liftweb.net/&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;&lt;/meta&gt;</span>
    <span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;Menu.title&quot;</span><span class="nt">&gt;</span>App: <span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jquery&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span>
      <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;json&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/json.js&quot;</span>
      <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span>The main content will get bound here<span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>假设你有 <span class="monospaced">index.html</span>, 而且你想添加 <span class="monospaced">red-titles.css</span> 去只改变这个页面的CSS.</p></div>
<div class="paragraph"><p>你需要做的是把CSS文件加入head(data-lift)到 <span class="monospaced">head</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
 <span class="nt">&lt;head&gt;</span>
   <span class="nt">&lt;title&gt;</span>Special<span class="nt">&lt;/title&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">data-lift=</span><span class="s">&quot;head&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
       <span class="na">href=</span><span class="s">&quot;red-titles.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Hello<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>请注意, <span class="monospaced">index.html</span> 页面是一个有效的HTML5页面, 会生成有效的 <span class="monospaced">&lt;head&gt;</span> tag, 就像如下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>App:  Home<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
    <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span> <span class="na">id=</span><span class="s">&quot;jquery&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
    <span class="na">src=</span><span class="s">&quot;/classpath/json.js&quot;</span> <span class="na">id=</span><span class="s">&quot;json&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;red-titles.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;h2&gt;</span>Hello<span class="nt">&lt;/h2&gt;</span>
   <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/ajax_request/liftAjax.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="c1">// &lt;![CDATA[</span>
  <span class="kd">var</span> <span class="nx">lift_page</span> <span class="o">=</span> <span class="s2">&quot;F557573613430HI02U4&quot;</span><span class="p">;</span>
  <span class="c1">// ]]&gt;</span>
  <span class="nt">&lt;/script&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_16">Discussion</h4>
<div class="paragraph"><p>如果你发现你的tag没有在 <span class="monospaced">&lt;head&gt;</span> 中, 请检查你是否在使用一个有效的HTML5.</p></div>
<div class="paragraph"><p>你也可以使用 <span class="monospaced">&lt;lift:head&gt;...&lt;/lift:head&gt;</span> 去包含很多的表达式, 然后使用<span class="monospaced">&lt;head_merge&gt;...&lt;/head_merge&gt;</span> 在code中, 替代 <span class="monospaced">&lt;lift:head&gt;</span>.</p></div>
<div class="paragraph"><p>另一个可选的方法是 <span class="monospaced">class="lift:head"</span>, 可以替代 <span class="monospaced">data-lift="head"</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">head</span> snippet 是一个内建的 snippet, 其他和你写的snippet没有任何区别.  它是用来发布, 包含你需要的信息的<span class="monospaced">&lt;head&gt;</span> . 它可以是 <span class="monospaced">&lt;title&gt;</span>, <span class="monospaced">&lt;link&gt;</span>, <span class="monospaced">&lt;meta&gt;</span>, <span class="monospaced">&lt;style&gt;</span>, <span class="monospaced">&lt;script&gt;</span> 或者 <span class="monospaced">&lt;base&gt;</span> tags.  它是如何将 <span class="monospaced">&lt;head&gt;</span> 放入 <span class="monospaced">head</span> snippet 中加工, 并且最后插入到页面的<span class="monospaced">&lt;head&gt;</span> 中的? 当Lift处理你的HTML模版时, 它自动地整合所有的 <span class="monospaced">&lt;head&gt;</span> tags 到页面 <span class="monospaced">&lt;head&gt;</span> 中.</p></div>
<div class="paragraph"><p>你也许会怀疑, 你是否可以用一个纯文本的 <span class="monospaced">&lt;head&gt;</span> 在你的模版中, 但是那将不是一个有效的HTML5文件.</p></div>
<div class="paragraph"><p>还有一个 <span class="monospaced">tail</span> 命令, 也可以做相同的事情, 它把所有你想的东西, 放到body的闭合tag之前.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_15">See Also</h4>
<div class="paragraph"><p><a href="#JavaScriptTail">[JavaScriptTail]</a> 讲述了, 如何把JavaScript放到页面的最后.</p></div>
<div class="paragraph"><p>以下是一个验证器, 用来测试是不是有效的HTML5, 这会对于你的纠错有很大帮助. <a href="http://validator.w3.org/">http://validator.w3.org/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Custom404">自定义404页面</h3>
<div class="sect3">
<h4 id="_problem_17">Problem</h4>
<div class="paragraph"><p>你想使用一个自定义的 "404" (not found) 页面.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_16">Solution</h4>
<div class="paragraph"><p>在 <span class="monospaced">Boot.scala</span> 添加以下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http._</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">uriNotFound</span><span class="o">.</span><span class="n">prepend</span><span class="o">(</span><span class="nc">NamedPF</span><span class="o">(</span><span class="s">&quot;404handler&quot;</span><span class="o">){</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="n">failure</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">NotFoundAsTemplate</span><span class="o">(</span><span class="nc">ParsePath</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">&quot;404&quot;</span><span class="o">),</span><span class="s">&quot;html&quot;</span><span class="o">,</span><span class="kc">true</span><span class="o">,</span><span class="kc">false</span><span class="o">))</span>
<span class="o">})</span>
</pre></div></div></div>
<div class="paragraph"><p>文件 <span class="monospaced">src/main/webapp/404.html</span> 将被用来显示, 当没有找到可用的页面时.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_17">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">uriNotFound</span> 这条Lift法则,需要返回 <span class="monospaced">NotFound</span> 为了回复<span class="monospaced">Req</span> 和 <span class="monospaced">Box[Failure]</span>. 它
允许你自定义response,基于特定的类型错误或者请求.</p></div>
<div class="paragraph"><p>一共有三种 <span class="monospaced">NotFound</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">NotFoundAsTemplate</span>&#8201;&#8212;&#8201; 用来处理关于`ParsePath`的Lift处理HTML模版的事情.
</p>
</li>
<li>
<p>
<span class="monospaced">NotFoundAsResponse</span>&#8201;&#8212;&#8201;允许你返回一个特定的 <span class="monospaced">LiftResponse</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">NotFoundAsNode</span>&#8201;&#8212;&#8201;包裹一个 <span class="monospaced">NodeSeq</span> 并返回 404 response.
</p>
</li>
</ul></div>
<div class="paragraph"><p>在这里例子中, 我们匹配任何 not found 的请求, 不管是请求失败, 或者页面没找到, Lift会计算 <span class="monospaced">ParsePath</span>, 并使用路径 <span class="monospaced">/404.html</span>.</p></div>
<div class="paragraph"><p>如果你对, 最后的参数 <span class="monospaced">true</span> and <span class="monospaced">false`还有`ParsePath</span> 感到奇怪.
他们告诉Lift, 我们输入的路径是绝对路径, 并且在结尾没有 / .  <span class="monospaced">ParsePath</span> 是一个URI 路径, 不过在这里例子中, 他们之间没有关系.</p></div>
<div class="paragraph"><p>请注意, 在如果使用这种方法创建的404页面, 是不会出现在site map里的. 因为我们没有添加 <span class="monospaced">404.html</span> 文件到site map, 而且我们不需要添加因为我们创建页面是通过<span class="monospaced">NotFoundAsTemplate</span> 而不是直接发送一个请求到 <em>/404.html</em>. 然而, 这意味着, 如果你显示一个错误页面使用HTML模版, 并且包含<span class="monospaced">Menu.builder</span> 或者类似的, (比如 <span class="monospaced">templates-hidden/default.html</span>), 你将会看到 "No Navigation Defined". 为了解决这个问题, 你也许需要一个不同的模版在404页面上.</p></div>
<div class="paragraph"><p>另一个选择是, 你可以在你的sitemap里设置404页面, 当时把他设置成hideen, 这样在 <span class="monospaced">Menu.builder</span> 就看不到:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;404&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;404&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">Hidden</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_16">See Also</h4>
<div class="paragraph"><p><a href="#CatchException">[CatchException]</a> 这里有关于如何catch所有的异常的讲解.</p></div>
<div class="paragraph" id="CustomStatusPage"><p>另一些可以自定义的状态页面</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Problem
^^^^^^^

你想自定义一个关于一个确定的HTTP状态code的页面.

Solution
^^^^^^^^

使用 `LiftRules.responseTransformers` 去匹配response.

比如说, 假设,我们想设置一个自定义页面对于403
("Forbidden") 状态在Lift应用中. 然后假设这个页面包含snippet, 所以他必须通过Lift进行修饰.

为了实现它, 在`Boot.scala` 中, 我们定义 `LiftResponse` 我们想生成, 然后使用一个response, 当403状态将要被Lift处理:

[source,scala]
----
def my403 : Box[LiftResponse] =
  for {
    session <- S.session
    req <- S.request
    template = Templates("403" :: Nil)
    response <- session.processTemplate(template, req, req.path, 403)
  } yield response

LiftRules.responseTransformers.append {
  case resp if resp.toResponse.code == 403 => my403 openOr resp
  case resp => resp
}
----

当出现403的时候, 文件 _src/main/webapp/403.html_ 将被用来显示. 其他非403的回应将无视.

Discussion
^^^^^^^^^^

`LiftRules.responseTransformers` 允许你使用
`LiftResponse => LiftResponse` 方法去改变在HTTP处理末期的回复. 这里一个很普遍的机制: 在这个例子中, 我们只匹配一个HTTP的状态code, 但是我们能匹配任意 `LiftResponse`.


这章里, 我们制造了一个HTML模版,去返回response响应, 但是你也许遇到别的情况, 这时其他的response会更有用, 比如说 `InMemoryResponse`.

你可以把以上的例子简化为:

[source,scala]
----
LiftRules.responseTransformers.append {
  case resp if resp.toResponse.code == 403 => RedirectResponse("/403.html")
  case resp => resp
}
----

这个例子也同样能工作, 只有一个缺点是, 当HTTP状态code发送回浏览器时, 它不是一个403code.

这里还有一个更普遍的用法, 如果你自定义很多个页面, 你需要定义你想要自定义的HTTP状态code,
建立页面对每一个code, 然后设置匹配:

[source,scala]
----
LiftRules.responseTransformers.append {
  case Customised(resp) => resp
  case resp => resp
}

object Customised {

  // 这些页面将会匹配: 403.html and 500.html
  val definedPages = 403 :: 500 :: Nil

  def unapply(resp: LiftResponse) : Option[LiftResponse] =
    definedPages.find(_ == resp.toResponse.code).flatMap(toResponse)

  def toResponse(status: Int) : Box[LiftResponse] =
    for {
      session <- S.session
      req <- S.request
      template = Templates(status.toString :: Nil)
      response <- session.processTemplate(template, req, req.path, status)
  } yield response

}
----

我们一般喜欢用 `Customised` 是当我们有一个HTML文件在 `src/main/webapp`,当他匹配code的时候, 使用它.不过你也可以使用不同的 `Templates`.

如果你想测试以上的代码, 你需要添加以下代码到, `Boot.scala`, 它会把所有的请求发到 _/secret_ 并且返回 403:

[source,scala]
----
val Protected = If(() => false, () => ForbiddenResponse("No!"))

val entries = List(
  Menu.i("Home") / "index",
  Menu.i("secret") / "secret" >> Protected,
  // rest of your site map here...
)
----

如果你请求 _/secret_, 一个403回复会被触发, 它将会返回 _403.html_  模版.

[NOTE]
在Lift3 中 `responseTransformers` 将被改变为一个偏函数, 这意味着你需要把这个例子改成 `case r => r`.


See Also
^^^^^^^^

<<Custom404>> 解释了内建的对404页面的支持.

<<CatchException>> 介绍了如何catch你code中的所有异常.



[[LinksInNotice]]
Notice中的超级链接</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_problem_18">Problem</h4>
<div class="paragraph"><p>你想添加一个能点击的<span class="monospaced">S.error</span>, <span class="monospaced">S.notice</span> 或者
<span class="monospaced">S.warning</span> 信息.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_17">Solution</h4>
<div class="paragraph"><p>添加一个 <span class="monospaced">NodeSeq</span> 有超级链接的提示:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">S</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;checkPrivacyPolicy&quot;</span><span class="o">,</span>
  <span class="o">&lt;</span><span class="n">span</span><span class="o">&gt;</span><span class="nc">See</span> <span class="n">our</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;/policy&quot;</span><span class="o">&gt;</span><span class="n">privacy</span> <span class="n">policy</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>你可以把它和以下code同时使用&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;Msg?id=checkPrivacyPolicy&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_18">Discussion</h4>
<div class="paragraph"><p>你也许对`S.error(String)<span class="monospaced">的Lift提示比用 `NodeSeq</span> 作为参数的函数签名更熟悉, 但是 <span class="monospaced">String</span> 版本, 只是将 <span class="monospaced">String</span> 转变为 <span class="monospaced">scala.xml.Text</span> 类型的 <span class="monospaced">NodeSeq</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_17">See Also</h4>
<div class="paragraph"><p>Lift的消息机制在Wiki有说明: <a href="http://www.assembla.com/spaces/liftweb/wiki/Lift_Notices_and_Auto_Fadeout">http://www.assembla.com/spaces/liftweb/wiki/Lift_Notices_and_Auto_Fadeout</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DownloadLink">下载的超级链接</h3>
<div class="sect3">
<h4 id="_problem_19">Problem</h4>
<div class="paragraph"><p>你想点击一个按钮, 或者一个链接, 然后会触发下载, 而不是打开一个页面.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_18">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">SHtml.link</span> 建立一个链接, 建立一个函数, 返回<span class="monospaced">LiftResponse</span>, 然后用 <span class="monospaced">ResponseShortcutException</span> 包装它.</p></div>
<div class="paragraph"><p>比如说, 我们建立一个snippet, 它可以让用户阅览一段诗, 并且下载它. HTML模版中, 我们使用 <span class="monospaced">&lt;br&gt;</span> 将每段诗分开:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>A poem<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;DownloadLink&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;blockquote&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;poem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;line&quot;</span><span class="nt">&gt;</span>line goes here<span class="nt">&lt;/span&gt;</span> <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/blockquote&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>download link here<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>这段Snippet会修饰每段诗, 并且替换下载链接, 它将会回复一个下载请求,并且下载诗:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http._</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">class</span> <span class="nc">DownloadLink</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">poem</span> <span class="k">=</span>
    <span class="s">&quot;Roses are red,&quot;</span> <span class="o">::</span>
    <span class="s">&quot;Violets are blue,&quot;</span> <span class="o">::</span>
    <span class="s">&quot;Lift rocks!&quot;</span> <span class="o">::</span>
    <span class="s">&quot;And so do you.&quot;</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="s">&quot;.poem&quot;</span> <span class="o">#&gt;</span> <span class="n">poem</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="s">&quot;.line&quot;</span> <span class="o">#&gt;</span> <span class="n">line</span><span class="o">)</span> <span class="o">&amp;</span>
    <span class="s">&quot;a&quot;</span> <span class="o">#&gt;</span> <span class="n">downloadLink</span>

  <span class="k">def</span> <span class="n">downloadLink</span> <span class="k">=</span>
    <span class="nc">SHtml</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="s">&quot;/notused&quot;</span><span class="o">,</span>
      <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">ResponseShortcutException</span><span class="o">(</span><span class="n">poemTextFile</span><span class="o">),</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Download&quot;</span><span class="o">)</span> <span class="o">)</span>

  <span class="k">def</span> <span class="n">poemTextFile</span> <span class="k">:</span> <span class="kt">LiftResponse</span> <span class="o">=</span>
    <span class="nc">InMemoryResponse</span><span class="o">(</span>
      <span class="n">poem</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">getBytes</span><span class="o">(</span><span class="s">&quot;UTF-8&quot;</span><span class="o">),</span>
      <span class="s">&quot;Content-Type&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;text/plain; charset=utf8&quot;</span> <span class="o">::</span>
      <span class="s">&quot;Content-Disposition&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;attachment; filename=\&quot;poem.txt\&quot;&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
      <span class="n">cookies</span><span class="k">=</span><span class="nc">Nil</span><span class="o">,</span> <span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>请注意, <span class="monospaced">SHtml.link</span> 生成一个超级链接, 并且运行一个你提供的方法.</p></div>
<div class="paragraph"><p>这里的窍门是, 当一个`LiftResponse` 在 <span class="monospaced">ResponseShortcutException</span> 中, 将会暗示Lift, 这个response已经完成, 所以页面将会被记录 (<span class="monospaced">而不是使用</span>), 但是不被处理. 对于浏览器来说: 它收到了一个请求的完整回复, 并且将会修饰页面, 在这里, 我们不让它修饰页面, 而是转到下载.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_19">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">SHtml.link</span> 的工作原理是, 生成一个URL, 它可以包含一个方法. 在一个叫做 `downloadlink`的页面, 这个下载链接像如下这样:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>downloadlink?F845451240716XSXE3G=_#notused</pre>
</div></div>
<div class="paragraph"><p>当这样一个链接被使用时, Lift会查看方法, 并且调用它在跳转链接之前. 然而, 在这里, 我们使用了一种快捷的Lift通道, 通过throw一个异常,并且catch它.  异常会被Lift catch, 并且会封装一个response给浏览器.</p></div>
<div class="paragraph"><p>这种快捷方式是通过使用: <span class="monospaced">S.redirectTo</span> 通过 <span class="monospaced">ResponseShortcutException.redirect</span>. 这个对象被定义为 <span class="monospaced">shortcutResponse</span>, 你可以使用如下的方法使用它:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.ResponseShortcutException._</span>

<span class="k">def</span> <span class="n">downloadLink</span> <span class="k">=</span>
  <span class="nc">SHtml</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="s">&quot;/notused&quot;</span><span class="o">,</span>
    <span class="o">()</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;The file was downloaded&quot;</span><span class="o">)</span>
      <span class="k">throw</span> <span class="n">shortcutResponse</span><span class="o">(</span><span class="n">poemTextFile</span><span class="o">)</span>
    <span class="o">},</span>
    <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Download&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>当下一次页面重载的时候, 我们通过使用 <span class="monospaced">S.notice</span> 去高亮 <span class="monospaced">throw shortcutResponse</span> , 反之,则抛出 <span class="monospaced">throw new ResponseShortcutException</span>. 在这里, 当用户下载的时候, 这个提示并不会显示, 它会在下一次提示的时候, 才显示, 比如用户跳转到其他页面.  在很多情况下, 这没有本质区别.</p></div>
<div class="paragraph"><p>这章使用了Lift的stateful属性. 你可以看出来: 从查看, 跳转到诗, 到下载文件 , state的使用是多么的重要.  如果你做一个数据库的报告, 你可以直接提供一个下载文件, 从数据库中重新生成一个文件.</p></div>
<div class="paragraph"><p>然而, 在另一个情况下, 你也许想避免让一个链接直接连到一个文件. 这个情况下, 你需要使用REST 服务然后返回一个 <span class="monospaced">LiftResponse</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_18">See Also</h4>
<div class="paragraph"><p><a href="#REST">[REST]</a> 请看基于REST的Lift服务.</p></div>
<div class="paragraph"><p><a href="#RestStreamContent">[RestStreamContent]</a> 中讨论了 `InMemoryResponse`和类似的response</p></div>
<div class="paragraph"><p>对于做报告, the Apache POI project, <a href="http://poi.apache.org/">http://poi.apache.org/</a>, 包含了自动生成Excel文件的库;以下是OpenCSV, <a href="http://opencsv.sourceforge.net">http://opencsv.sourceforge.net</a>, 是一个可以自动生成 CSV 文件的库.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="TestingReq">测试一个 Req</h3>
<div class="sect3">
<h4 id="_problem_20">Problem</h4>
<div class="paragraph"><p>你想测试一个包含`Req`的方法.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_19">Solution</h4>
<div class="paragraph"><p>提供一个request的模型<span class="monospaced">MockWeb.testReq</span>, 然后用你的test作为 <span class="monospaced">testReq</span> 的内容.</p></div>
<div class="paragraph"><p>首先, 需要添加Lift的 Test Kit作为一个依赖库到<span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-testkit&quot;</span> <span class="o">%</span> <span class="s">&quot;2.5-RC2&quot;</span> <span class="o">%</span> <span class="s">&quot;test&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>为了展示如何使用 <span class="monospaced">testReq</span> 我们测试一个可以察觉Google crawler 的方法. Google设置crawlers 通过变量 "User-Agent" 在一个request的头里, 所以我们想测试的方法为:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.Req</span>

<span class="k">object</span> <span class="nc">RobotDetector</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">botNames</span> <span class="k">=</span>
    <span class="s">&quot;Googlebot&quot;</span> <span class="o">::</span>
    <span class="s">&quot;Mediapartners-Google&quot;</span> <span class="o">::</span>
    <span class="s">&quot;AdsBot-Google&quot;</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">def</span> <span class="n">known_?</span><span class="o">(</span><span class="n">ua</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
    <span class="n">botNames</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span><span class="n">ua</span> <span class="n">contains</span> <span class="k">_</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">googlebot_?</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span>
    <span class="n">r</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span><span class="o">).</span><span class="n">exists</span><span class="o">(</span><span class="n">known_?</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>我们有一个List的 <span class="monospaced">botNames</span>, 他们是用来让Google发送作为user agent的, 然后我们定义一个检查函数, <span class="monospaced">known_?</span>, 它用 user agent string 作为参数, 然后去查找是否有bot包含这个 user agent string.</p></div>
<div class="paragraph"><p><span class="monospaced">googlebot_?</span> 方法以 <span class="monospaced">Req</span> 对象作为参数, 然后通过它查找header. 它的结果是存在一个 <span class="monospaced">Box[String]</span> 因为有可能没找到任何header. 我们可以通过查看 <span class="monospaced">Box</span> 中是否有header, 并且它
 的值符合 <span class="monospaced">known_?</span> 的条件, 来得到结果.</p></div>
<div class="paragraph"><p>为了测试它, 我们建立一个user agent string, 准备一个 <span class="monospaced">MockHttpServletRequest</span> 和它的header, 然后使用Lift的 <span class="monospaced">MockWeb</span> 把一个底层的request变为Lift的<span class="monospaced">Req</span> 供我们测试:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">org.specs2.mutable._</span>
<span class="k">import</span> <span class="nn">net.liftweb.mocks.MockHttpServletRequest</span>
<span class="k">import</span> <span class="nn">net.liftweb.mockweb.MockWeb</span>

<span class="k">class</span> <span class="nc">SingleRobotDetectorSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="o">{</span>

  <span class="s">&quot;Google Bot Detector&quot;</span> <span class="n">should</span> <span class="o">{</span>

    <span class="s">&quot;spot a web crawler&quot;</span> <span class="n">in</span> <span class="o">{</span>

      <span class="k">val</span> <span class="n">userAgent</span> <span class="k">=</span> <span class="s">&quot;Mozilla/5.0 (compatible; Googlebot/2.1)&quot;</span>

      <span class="c1">// Mock a request with the right header:</span>
      <span class="k">val</span> <span class="n">http</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">()</span>
      <span class="n">http</span><span class="o">.</span><span class="n">headers</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span> <span class="o">-&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="n">userAgent</span><span class="o">))</span>

      <span class="c1">// Test with a Lift Req:</span>
      <span class="nc">MockWeb</span><span class="o">.</span><span class="n">testReq</span><span class="o">(</span><span class="n">http</span><span class="o">)</span> <span class="o">{</span> <span class="n">r</span> <span class="k">=&gt;</span>
        <span class="nc">RobotDetector</span><span class="o">.</span><span class="n">googlebot_?</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="n">must</span> <span class="n">beTrue</span>
      <span class="o">}</span>
    <span class="o">}</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>运行SBT,并且使用 "test" 命令会产生:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[info] SingleRobotDetectorSpec
[info]
[info] Google Bot Detector should
[info] + spot a web crawler
[info]
[info] Total for specification SingleRobotDetectorSpec
[info] Finished in 18 ms
[info] 1 example, 0 failure, 0 error</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_20">Discussion</h4>
<div class="paragraph"><p>尽管 <span class="monospaced">MockWeb.testReq</span> 负责处理 <span class="monospaced">Req</span>, 但是环境上的 <span class="monospaced">Req</span> 是由 <span class="monospaced">MockHttpServletRequest`提供的. 如果你想设置一个request, 建立一个mock的实例, 在使用它和 `testReq</span> 之前, 配置你想要的state.</p></div>
<div class="paragraph"><p>另外关于 HTTP headers, 你可以设置cookies, content type, query parameters, the HTTP method, authentication type, 和 body. 他们有多样的配置在 <span class="monospaced">body</span> 上, 这使得你可以轻易的依据你设置的值改变content类型:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">JValue</span> 的 content type 为 "application/json".
</p>
</li>
<li>
<p>
<span class="monospaced">NodeSeq</span> 则为 "text/xml" (或者你可以提供其他类型).
</p>
</li>
<li>
<p>
<span class="monospaced">String</span> 则为 "text/plain" (或者你可以提供其他类型.
</p>
</li>
<li>
<p>
<span class="monospaced">Array[Byte]</span> 没有content type.
</p>
</li>
</ul></div>
<div class="sect4">
<h5 id="_data_table">Data Table</h5>
<div class="paragraph"><p>在上一个例子中, 重复的设置相同的user agents会让人十分讨厌.  Specs2&#8217;s <em>Data Table</em> 提供了一个方法, 可以让你运行不同的值在相同的test中:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">org.specs2._</span>
<span class="k">import</span> <span class="nn">matcher._</span>
<span class="k">import</span> <span class="nn">net.liftweb.mocks.MockHttpServletRequest</span>
<span class="k">import</span> <span class="nn">net.liftweb.mockweb.MockWeb</span>

<span class="k">class</span> <span class="nc">RobotDetectorSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span> <span class="nc">DataTables</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">is</span> <span class="k">=</span> <span class="s">&quot;Can detect Google robots&quot;</span> <span class="o">^</span> <span class="o">{</span>
    <span class="s">&quot;Bot?&quot;</span> <span class="o">||</span> <span class="s">&quot;User Agent&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;Mozilla/5.0 (Googlebot/2.1)&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;Googlebot-Video/1.0&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;Mediapartners-Google&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;AdsBot-Google&quot;</span> <span class="o">|</span>
    <span class="kc">false</span>  <span class="o">!!</span> <span class="s">&quot;Mozilla/5.0 (KHTML, like Gecko)&quot;</span> <span class="o">|&gt;</span> <span class="o">{</span>
    <span class="o">(</span><span class="n">expectedResult</span><span class="o">,</span> <span class="n">userAgent</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">http</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">()</span>
      <span class="n">http</span><span class="o">.</span><span class="n">headers</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span> <span class="o">-&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="n">userAgent</span><span class="o">))</span>
      <span class="nc">MockWeb</span><span class="o">.</span><span class="n">testReq</span><span class="o">(</span><span class="n">http</span><span class="o">)</span> <span class="o">{</span> <span class="n">r</span> <span class="k">=&gt;</span>
        <span class="nc">RobotDetector</span><span class="o">.</span><span class="n">googlebot_?</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="n">must_==</span> <span class="n">expectedResult</span>
      <span class="o">}</span>
     <span class="o">}</span>
    <span class="o">}</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Test的核心内容没有改变: 我们建立了一个模型, 设置了user agent, 检查 `googlebot_?`的结果. 不同的是 Specs2 提供了一个更好的方法, 列出了不同变量的情况, 并且pipe他们到方法中.</p></div>
<div class="paragraph"><p>在SBT上运行以上code的结果是:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[info] Can detect Google robots
[info] + Bot?  | User Agent
[info]   true  | Mozilla/5.0 (Googlebot/2.1)
[info]   true  | Googlebot-Video/1.0
[info]   true  | Mediapartners-Google
[info]   true  | AdsBot-Google
[info]   false | Mozilla/5.0 (KHTML, like Gecko)
[info]
[info] Total for specification RobotDetectorSpec
[info] Finished in 1 ms
[info] 1 example, 0 failure, 0 error</pre>
</div></div>
<div class="paragraph"><p>尽管期待的值首先显示在我们的table上, 但是这里没有任何要求让它显示在第一位.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_19">See Also</h4>
<div class="paragraph"><p>Lift wiki里有关于这个的更多讨论, 包括使用Selenium. <a href="https://www.assembla.com/spaces/liftweb/wiki/Testing_Lift_Applications">https://www.assembla.com/spaces/liftweb/wiki/Testing_Lift_Applications</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Textile">使用Textile</h3>
<div class="sect3">
<h4 id="_problem_21">Problem</h4>
<div class="paragraph"><p>你想使用 Textile markup在你的Lift web应用中.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_20">Solution</h4>
<div class="paragraph"><p>安装 Lift Textile module 在你的 <span class="monospaced">build.sbt</span> 文件, 你需要安装以下依赖库:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;net.liftmodules&quot;</span> <span class="o">%%</span> <span class="s">&quot;textile_2.5&quot;</span> <span class="o">%</span> <span class="s">&quot;1.3&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>你可以是用这个模块去, 修饰 Textile到HTML, 通过使用 <span class="monospaced">toHtml</span> 方法.</p></div>
<div class="paragraph"><p>比如说, 在添加模块后, 运行 SBT, SBT <em>console</em> 命令允许你直接使用这个模块:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftmodules.textile._</span>
<span class="k">import</span> <span class="nn">net.liftmodules.textile._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="nc">TextileParser</span><span class="o">.</span><span class="n">toHtml</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s"> | h1. Hi!</span>
<span class="s"> |</span>
<span class="s"> | The module in &quot;Lift&quot;:http://www.liftweb.net for turning Textile markup</span>
<span class="s"> | into HTML is pretty easy to use.</span>
<span class="s"> |</span>
<span class="s"> | * As you can see.</span>
<span class="s"> | * In this example.</span>
<span class="s"> | &quot;&quot;&quot;</span><span class="o">)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span>
<span class="nc">NodeSeq</span><span class="o">(,</span> <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">Hi</span><span class="o">!&lt;/</span><span class="n">h1</span><span class="o">&gt;,</span>
<span class="o">,</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">The</span> <span class="n">module</span> <span class="n">in</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://www.liftweb.net&quot;</span><span class="o">&gt;</span><span class="nc">Lift</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">turning</span> <span class="nc">Textile</span>
  <span class="n">markup</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;&lt;/</span><span class="n">br</span><span class="o">&gt;</span><span class="n">into</span> <span class="nc">HTML</span> <span class="n">is</span> <span class="n">pretty</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">use</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;,</span>
<span class="o">,</span> <span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">see</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">In</span> <span class="k">this</span> <span class="n">example</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;,</span>
<span class="o">,</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>如果我们使用PrettyPrinter, 结果会更容易懂:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">pp</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrettyPrinter</span><span class="o">(</span><span class="n">width</span><span class="k">=</span><span class="mi">35</span><span class="o">,</span> <span class="n">step</span><span class="k">=</span><span class="mi">2</span><span class="o">)</span>
<span class="n">pp</span><span class="k">:</span> <span class="kt">scala.xml.PrettyPrinter</span> <span class="o">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="nc">PrettyPrinter</span><span class="k">@</span><span class="mi">54</span><span class="n">c19de8</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">formatNodes</span><span class="o">(</span><span class="n">res0</span><span class="o">)</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">Hi</span><span class="o">!&lt;/</span><span class="n">h1</span><span class="o">&gt;&lt;</span><span class="n">p</span><span class="o">&gt;</span>
  <span class="nc">The</span> <span class="n">module</span> <span class="n">in</span>
  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://www.liftweb.net&quot;</span><span class="o">&gt;</span>
    <span class="nc">Lift</span>
  <span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
  <span class="k">for</span> <span class="n">turning</span> <span class="nc">Textile</span> <span class="n">markup</span>
  <span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;&lt;/</span><span class="n">br</span><span class="o">&gt;</span>
  <span class="n">into</span> <span class="nc">HTML</span> <span class="n">is</span> <span class="n">pretty</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">use</span><span class="o">.</span>
<span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">see</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">In</span> <span class="k">this</span> <span class="n">example</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_21">Discussion</h4>
<div class="paragraph"><p>使用一个Lift的模块不需要其他多余的code, 但是这里有一些我们编程的习惯: 他们通常被包装成 <em>net.liftmodules</em>, 但是也不是都是这样的; 他们通常依赖于某一个版本的Lift; 他们通常使用hook在 `LiftRules`中来提供一种特定的服务. 每一个人都可以建立和公开一个Lift的模块, 并且任何人都可以给现有的模块做贡献. 最后, 他们在SBT中被声明为依赖库, 然后和你使用其他依赖库一样使用.</p></div>
<div class="paragraph"><p>一个依赖库的名字有两部分组成: 模块使用的Lift版本, 就像在 <a href="#ModuleVersioning">[ModuleVersioning]</a> 中讲解的一样. 当我们说"版本"的时候, 我们指得是第一个可用的Lift版本. 这意味着, 这个模块将对比此版本更新的版本兼容.</p></div>
<div class="imageblock" id="ModuleVersioning">
<div class="content">
<img src="images/moduleversioning.png" alt="images/moduleversioning.png" width="640">
</div>
<div class="title">Figure 2. The structure of a module version.</div>
</div>
<div class="paragraph"><p>这个结构被采用, 是因为模块有自己的发行周期, 和Lift的周期不同. 然而, 模块也基于现在Lift的功能和Lift改变自己的API在每个主要版本中, 因此, 使用Lift版本的一部分来定义模块名称是非常必要的.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_20">See Also</h4>
<div class="paragraph"><p>并没有一个准备的对Textile的定义, 但是这里有一些关于mark up和HTML的用法的引用, 也许对你有帮助; <a href="http://redcloth.org/hobix.com/textile/">http://redcloth.org/hobix.com/textile/</a>.</p></div>
<div class="paragraph"><p>Textile 模块的主页: <a href="https://github.com/liftmodules/textile">https://github.com/liftmodules/textile</a>.</p></div>
<div class="paragraph"><p>对Textile的Unit test,　可以让你更好的了解使用的方法和一些有用的示例: <a href="https://github.com/liftmodules/textile/blob/master/src/test/scala/net/liftmodules/textile/TextileSpec.scala">https://github.com/liftmodules/textile/blob/master/src/test/scala/net/liftmodules/textile/TextileSpec.scala</a>.</p></div>
<div class="paragraph"><p><a href="#modules">[modules]</a> 介绍了如何建立一个模块.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Forms">Lift的表格处理</h2>
<div class="sectionbody">
<div class="paragraph"><p>这章给出了使用Lift 表格的各种方法.  你会在以下地址找到更多的例子: <a href="https://github.com/LiftCookbook/cookbook_forms">https://github.com/LiftCookbook/cookbook_forms</a>.</p></div>
<div class="sect2">
<h3 id="PlainFormProcessing">老式的表格处理</h3>
<div class="sect3">
<h4 id="_problem_22">Problem</h4>
<div class="paragraph"><p>你想使用一个非AJAX的方法来处理表格数据.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_21">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">S.param</span> 来解析数据, 然后生成输出.</p></div>
<div class="paragraph"><p>比如说, 我们可以展示一个表格, 处理输入数据, 然后返回一个提示.  HTML模版一般是HTML表格, 和一个snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;Plain&quot;</span> <span class="na">action=</span><span class="s">&quot;/plain&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;What&#39;s your name?&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Go&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>在这里例子中,我们可以得到 "name" 的值通过使用 <span class="monospaced">S.param("name")</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.common.Full</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.PassThru</span>

<span class="k">object</span> <span class="nc">Plain</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Hello &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">)</span>
      <span class="n">S</span><span class="o">.</span><span class="n">redirectTo</span><span class="o">(</span><span class="s">&quot;/plain&quot;</span><span class="o">)</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="nc">PassThru</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>当你的浏览器读取到数据时, 如果是第一次, 因为没有URL参数, 所以不执行任何操作. 然后你可以在name区域输入一些值, 然后提交表格. 这个行为会让Lift再次处理模版, 但是这次因为有"name"的input.  结果将时跳到另一个页面, 并显示一个提示.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_22">Discussion</h4>
<div class="paragraph"><p>手动的从URL中提取数据, 这不是Lift推荐的, 但是有时候你需要这么做,  <span class="monospaced">S.param</span> 是你取得URL参数值的一种方法.</p></div>
<div class="paragraph"><p><span class="monospaced">S.param</span> 的结果是一个 <span class="monospaced">Box[String]</span>, 在上一个例子中, 我们使用匹配来处理数据.  当你处理超过一个参数的时候 <span class="monospaced">S.param</span> 是这样使用的:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">name</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
    <span class="n">pet</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="s">&quot;petName&quot;</span><span class="o">)</span>
  <span class="o">}</span> <span class="o">{</span>
    <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Hello %s and %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">pet</span><span class="o">))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">redirectTo</span><span class="o">(</span><span class="s">&quot;/plain&quot;</span><span class="o">)</span>
  <span class="o">}</span>

 <span class="nc">PassThru</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>如果"name" 和 "petName" 都有值,  <em>for</em> 里面的语句将被执行.</p></div>
<div class="paragraph"><p>相关的 <span class="monospaced">S</span> 方法包括:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">S.params(name)</span>&#8201;&#8212;&#8201;处理一个 <span class="monospaced">List[String]</span>, 然后返回他们在URL参数上的值.
</p>
</li>
<li>
<p>
<span class="monospaced">S.post_?</span>, <span class="monospaced">S.get_?</span>-- 看request是 GET 或者 POST.
</p>
</li>
<li>
<p>
<span class="monospaced">S.getRequestHeader(name)</span>&#8201;&#8212;&#8201;使用 <span class="monospaced">Box[String]</span> 作为header.
</p>
</li>
<li>
<p>
<span class="monospaced">S.request</span>&#8201;&#8212;&#8201;用来访问 <span class="monospaced">Box[Req]</span>, 它会给你访问一个特定信息的能力.
</p>
</li>
</ul></div>
<div class="paragraph"><p>作为一个使用 <span class="monospaced">S.request`的例子,  我们可以处理一个 `List[String]</span> 中所有的request参数 包含 "name" :</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">names</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">req</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">toList</span>
  <span class="n">paramName</span> <span class="k">&lt;-</span> <span class="n">req</span><span class="o">.</span><span class="n">paramNames</span>
  <span class="k">if</span> <span class="n">paramName</span><span class="o">.</span><span class="n">toLowerCase</span> <span class="n">contains</span> <span class="s">&quot;name&quot;</span>
  <span class="n">value</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="n">paramName</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">value</span>
</pre></div></div></div>
<div class="paragraph"><p>请注意, 当打开 <span class="monospaced">S.request</span> 时, 我们可以访问所有丢的参数通过 <span class="monospaced">paramNames</span> 方法在 `Req`上.</p></div>
<div class="paragraph"><p>Screen 和 Wizard 提供了其他可供选择的表格处理方法, 但是有时候, 你需要取得request中的值, 这时候, 你需要使用这章的内容.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_21">See Also</h4>
<div class="paragraph"><p><em>Simply Lift</em> 里面有很多表格处理的方法.  请看: <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AjaxFormProcessing">Ajax表格处理</h3>
<div class="sect3">
<h4 id="_problem_23">Problem</h4>
<div class="paragraph"><p>你想处理一个表格通过Ajax, 而不是重载整个页面.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_22">Solution</h4>
<div class="paragraph"><p>请标注你的表格为 <span class="monospaced">data-lift="form.ajax"</span> 然后, 在服务端提供一个需要运行的方法.</p></div>
<div class="paragraph"><p>这里有一个可以收集我们名字的表格的例子, 它通过Ajax提交到服务端:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;form.ajax&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;EchoForm&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;What&#39;s your name?&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;result&quot;</span><span class="nt">&gt;</span>Your name will be echoed here<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>以下的snippet会返回输入的名字:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml.</span><span class="o">{</span><span class="n">text</span><span class="o">,</span><span class="n">ajaxSubmit</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmd</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.SetHtml</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">object</span> <span class="nc">EchoForm</span> <span class="k">extends</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="n">process</span><span class="o">()</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">,</span> <span class="nc">Text</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>

    <span class="s">&quot;@name&quot;</span> <span class="o">#&gt;</span> <span class="n">text</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="n">name</span> <span class="k">=</span> <span class="n">s</span><span class="o">)</span> <span class="o">&amp;</span>
    <span class="s">&quot;type=submit&quot;</span> <span class="o">#&gt;</span> <span class="n">ajaxSubmit</span><span class="o">(</span><span class="s">&quot;Click Me&quot;</span><span class="o">,</span> <span class="n">process</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>当你点击按钮时, 方法 <span class="monospaced">process</span> 被调用, 将会返回 <span class="monospaced">name</span> 的值, 并替换ID为 <span class="monospaced">result</span> 的HTML元素.</p></div>
<div class="paragraph"><p>请注意, 你会经常看到 <span class="monospaced">s =&gt; name = s</span> 被简写为 <span class="monospaced">name = _</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_23">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">data-lift="form.ajax"</span> 部分, 确保了Lift添加Ajax机制到表格中. 这意味着 <span class="monospaced">&lt;form&gt;</span> 在Lift修饰后, 会变成:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;F2203365740CJME2G&quot;</span> <span class="na">action=</span><span class="s">&quot;javascript://&quot;</span>
  <span class="na">onsubmit=</span><span class="s">&quot;liftAjax.lift_ajaxHandler(</span>
<span class="s">    jQuery(&#39;#&#39;+&amp;quot;F2203365740CJME2G&amp;quot;).serialize(),</span>
<span class="s">    null, null, &amp;quot;javascript&amp;quot;);return false;&quot;</span><span class="nt">&gt;</span>
  ...
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>换句话说, 当表格被提交时, Lift会通过Ajax处理表格. 这意味着, 你根本不需要单独的提交按钮.  在这个例子中只有一个单一的text输入框, 当你省略了提交按钮, 你可以触发序列化通过按 <em>return</em>.  这回触发方法 <span class="monospaced">s =&gt; name = s</span> , 它被绑定在 <span class="monospaced">data-lift="EchoForm"</span> snippet中. 换句话说,  <span class="monospaced">name</span> 变量将被赋值, 即使没有提交按钮.</p></div>
<div class="paragraph"><p>添加一个提交按钮, 可以让我们处理一些行为, 当所有的输入框的方法都被执行过后.</p></div>
<div class="paragraph"><p>请注意, Lift的处理是序列化表格到服务器, 执行绑定输入框上的方法, 执行提交的按钮上的方法(如果存在), 然后返回一个JavaScript到客户端.</p></div>
<div class="sect4">
<h5 id="_submit_styling">Submit Styling</h5>
<div class="paragraph"><p><span class="monospaced">SHtml.ajaxSubmit</span> 方法生成一个 <span class="monospaced">&lt;input type="submit"&gt;</span> 元素到页面. 你也许想要一个可以设计的提交按钮. 比如说, 使用 Twitter Bootstrap, 一个button上有一个icon, 比如说如下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-large&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;icon-white icon-ok&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Submit
<span class="nt">&lt;/button&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>点击 <span class="monospaced">&lt;button&gt;</span> 在一个表格中会触发提交. 然而, 如果你把按钮通过 `Shtml.ajaxSubmit`绑定到, 将会丢失你的style.</p></div>
<div class="paragraph"><p>为了解决这个问题, 你可以设置一个方法到一个隐藏域上. 这个方法将被调用和其他的域上的方法一样.
在我们的snippet中, 唯一改变的是CSS selector binding:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.SHtml.hidden</span>

<span class="s">&quot;@name&quot;</span> <span class="o">#&gt;</span> <span class="n">text</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="n">name</span> <span class="k">=</span> <span class="n">s</span><span class="o">)</span> <span class="o">&amp;</span>
<span class="s">&quot;button *+&quot;</span> <span class="o">#&gt;</span> <span class="n">hidden</span><span class="o">(</span><span class="n">process</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>他将包含一个隐藏域, 比如说&#8230;.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;F11202029628285OIEC2&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;然后当表格提交时, 隐藏域也提交, 和其他域一样, Lift将会调用绑定的方法: <span class="monospaced">process</span>.</p></div>
<div class="paragraph"><p>这个例子的用法像 <span class="monospaced">ajaxSubmit</span>, 但不完全一样. 在这个例子中我们添加了一个隐藏郁在 <span class="monospaced">&lt;button&gt;`之后, 但是你可以放在任何你觉得方便的地方. 然而, 这里有一点容易混淆: 什么时候`process</span> 被调用? 是在调用 <span class="monospaced">name</span> 前还是后? 这个由你域的先后顺序决定. 这就是说, 在你的HTML模版中, 把按钮放在文本域前,  <span class="monospaced">process</span> 方法在name绑定的方法前被掉用.</p></div>
<div class="paragraph"><p>还有很多其他的方法关于这个例子.  不管哪种方法, 请都保证你的隐藏域在最后, 或者保证你的方法在一个`formGroup`:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.SHtml.hidden</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>

<span class="s">&quot;@name&quot;</span> <span class="o">#&gt;</span> <span class="n">text</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="n">name</span> <span class="k">=</span> <span class="n">s</span><span class="o">)</span> <span class="o">&amp;</span>
<span class="s">&quot;button *+&quot;</span> <span class="o">#&gt;</span> <span class="n">S</span><span class="o">.</span><span class="n">formGroup</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span> <span class="o">{</span> <span class="n">hidden</span><span class="o">(</span><span class="n">process</span><span class="o">)</span> <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>一个 <span class="monospaced">formGroup</span> 是一个而外的操控, 他可以让你的方法排序, 在这个例子中, 排序的结果是 <span class="monospaced">process</span> 被调用在group (0)之前.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Lift 2.6 和 3.0 也许包含 <span class="monospaced">ajaxOnSubmit</span>, 它包含可靠的<span class="monospaced">ajaxSubmit</span> 和 灵活的隐藏域.  如果你想使用它在Lift 2.5,
Antonio Salazar Cardozo 建立一个Helper, 你可以使用: <a href="https://gist.github.com/Shadowfiend/5042131">https://gist.github.com/Shadowfiend/5042131</a>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_22">See Also</h4>
<div class="paragraph"><p>方法调用的顺序可以参考: <a href="http://www.assembla.com/spaces/liftweb/wiki/cool_tips">http://www.assembla.com/spaces/liftweb/wiki/cool_tips</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="JsonForms">Ajax表格返回JSON</h3>
<div class="sect3">
<h4 id="_problem_24">Problem</h4>
<div class="paragraph"><p>你想通过Ajax表格发送一个json到服务器.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_23">Solution</h4>
<div class="paragraph"><p>使用 Lift的 <span class="monospaced">jlift.js</span> Javascript 和 <span class="monospaced">JsonHandler</span> 代码.
请看如下HTML, 它不是一个表格, 但是使用 <span class="monospaced">jlift.js</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;JsonForm&quot;</span> <span class="nt">&gt;</span>

 <span class="c">&lt;!--  required for JSON forms processing --&gt;</span>
 <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/classpath/jlift.js&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;tail&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

 <span class="c">&lt;!--  placeholder script required to process the form --&gt;</span>
 <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jsonFormScript&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;tail&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

 <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;formToJson&quot;</span> <span class="na">name=</span><span class="s">&quot;formToJson&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Royal Society&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;motto&quot;</span> <span class="na">value=</span><span class="s">&quot;Nullius in verba&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;sb&quot;</span> <span class="na">value=</span><span class="s">&quot;go!&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;result&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>服务端可以收到json, 通过使用如下code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util._</span>
<span class="k">import</span> <span class="nn">Helpers._</span>

<span class="k">import</span> <span class="nn">net.liftweb.http._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js._</span>
<span class="k">import</span> <span class="nn">JsCmds._</span>

<span class="k">import</span> <span class="nn">scala.xml._</span>

<span class="k">class</span> <span class="nc">JsonForm</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
     <span class="s">&quot;#formToJson&quot;</span> <span class="o">#&gt;</span> <span class="o">((</span><span class="n">ns</span><span class="k">:</span><span class="kt">NodeSeq</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">jsonForm</span><span class="o">(</span><span class="n">jsonHandler</span><span class="o">,</span> <span class="n">ns</span><span class="o">))</span> <span class="o">&amp;</span>
     <span class="s">&quot;#jsonFormScript&quot;</span> <span class="o">#&gt;</span> <span class="nc">Script</span><span class="o">(</span><span class="n">jsonHandler</span><span class="o">.</span><span class="n">jsCmd</span><span class="o">)</span>

    <span class="k">object</span> <span class="nc">jsonHandler</span> <span class="k">extends</span> <span class="nc">JsonHandler</span> <span class="o">{</span>

      <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Any</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="n">in</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">JsonCmd</span><span class="o">(</span><span class="s">&quot;processForm&quot;</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">params</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="k">_</span><span class="o">],</span> <span class="n">all</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">params</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;No Name&quot;</span><span class="o">)</span>
            <span class="k">val</span> <span class="n">motto</span> <span class="k">=</span> <span class="n">params</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;motto&quot;</span><span class="o">,</span> <span class="s">&quot;No Motto&quot;</span><span class="o">)</span>
            <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">,</span>
                <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;The motto of %s is %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">motto</span><span class="o">))</span> <span class="o">)</span>

          <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
            <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">,</span><span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Unknown command&quot;</span><span class="o">))</span>
      <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>如果你点击go按钮, 然后关键网络流, 你会看到以下信息发送到服务器:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;command&quot;</span><span class="o">:</span> <span class="s2">&quot;processForm&quot;</span><span class="p">,</span>
  <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Royal Society&quot;</span><span class="p">,</span><span class="s2">&quot;motto&quot;</span><span class="o">:</span><span class="s2">&quot;Nullius in verba&quot;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>服务器端将会把<span class="monospaced">results</span> 替换为
"The motto of the Royal Society is Nullius in verba".</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_24">Discussion</h4>
<div class="paragraph"><p>这里需要注意的是:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<span class="monospaced">jlift.js</span> 脚本可以使用变量的json; 并且
</p>
</li>
<li>
<p>
生成 JavaScript code (<span class="monospaced">jsonHandler.jsCmd</span>), 这些都在表格提交时会用到.
</p>
</li>
</ol></div>
<div class="paragraph"><p>在绑定过程中, <span class="monospaced">SHtml.jsonForm</span> 使用 <span class="monospaced">jsonHandler</span> 对象来处理表格, 然后使用你的HTML模版包裹, <span class="monospaced">ns</span>, 和 <span class="monospaced">&lt;form&gt;</span> tag. 我们也绑定JavaScript 和 <span class="monospaced">jsonFormScript</span> 的placeholder.</p></div>
<div class="paragraph"><p>当表格提交时,  <span class="monospaced">JsonHandler.apply</span> 允许我们可以匹配一个input, 然后从 <span class="monospaced">Map</span> 中找到需要的值. 请注意, 这里编译的时候, 会出现 <span class="monospaced">Map[String,_]</span> 是一个 "unchecked since it is eliminated by erasure".</p></div>
<div class="paragraph"><p>如果你需要一个 REST service 处理 JSON,  请考虑使用REST HELPER.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_23">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.javabeat.net/2011/05/using-json-forms-with-ajax-in-lift-framework/">使用 JSON 表格和AJAX在 Lift Framework</a>.
</p>
</li>
<li>
<p>
<em>Lift in Action</em>, section 9.1.4 "Using JSON forms with AJAX".
</p>
</li>
<li>
<p>
Lift 应用展示: <a href="https://github.com/marekzebrowski/lift-basics">Simple form</a> processing.
</p>
</li>
<li>
<p>
Section 10.4, JSON, in
<a href="http://exploring.liftweb.net/master/index-10.html">Exploring Lift</a>.
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Nullius_in_verba">Nullius in verba</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="DisableCheckbox">条件性的disable一个checkbox</h3>
<div class="sect3">
<h4 id="_problem_25">Problem</h4>
<div class="paragraph"><p>你想添加 <span class="monospaced">disabled</span> 属性到 <span class="monospaced">SHtml.checkbox</span>, 基于你现在的点击状态.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_24">Solution</h4>
<div class="paragraph"><p>建立一个 CSS selector 转换来添加disabled属性, 并且在你的checkbox使用这个转换. 比如, 假设你有一个checkbox:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Likes</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">likeTurtles</span> <span class="k">=</span> <span class="kc">false</span>
  <span class="k">def</span> <span class="n">checkbox</span> <span class="k">=</span> <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">checkbox</span><span class="o">(</span><span class="n">likeTurtles</span><span class="o">,</span> <span class="n">likeTurtles</span> <span class="k">=</span> <span class="k">_</span> <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>假设你想 disable 它在50%几率下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">disabler</span> <span class="k">=</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">math</span><span class="o">.</span><span class="n">random</span> <span class="o">&gt;</span> <span class="mf">0.5d</span><span class="o">)</span> <span class="s">&quot;* [disabled]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;disabled&quot;</span>
 <span class="k">else</span> <span class="nc">PassThru</span>

<span class="k">def</span> <span class="n">conditionallyDisabledCheckbox</span> <span class="k">=</span>
  <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="n">disabler</span><span class="o">(</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">checkbox</span><span class="o">(</span><span class="n">likeTurtles</span><span class="o">,</span> <span class="n">likeTurtles</span> <span class="k">=</span> <span class="k">_</span> <span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>使用 <span class="monospaced">lift:Likes.conditionallyDisabledCheckbox</span> checkbox将会在一半的时间被disabled.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_25">Discussion</h4>
<div class="paragraph"><p>命令 <span class="monospaced">disabler</span> 返回 <span class="monospaced">NodeSeq=&gt;NodeSeq</span> , 这意味着
当我们使用它在 <span class="monospaced">conditionallyDisabledCheckbox`中, 我们需要传递给它一个 `NodeSeq</span>, 而它正是由 <span class="monospaced">SHtml.checkbox</span> 提供的.</p></div>
<div class="paragraph"><p>CSS selector 的 <span class="monospaced">[disabled]</span> 不分是选择一个包含 disabled属性的元素, 然后使用 <span class="monospaced">#&gt;</span> 替换它为右边的元素,  在这里个例子中是 "disabled".</p></div>
<div class="paragraph"><p>这个组合的意思是, 一半时间 disabled属性都被设置在checkbox上, 另一半时间 <span class="monospaced">NodeSeq</span>
将没人碰, 因为 <span class="monospaced">PassThru</span> 没有改变 <span class="monospaced">NodeSeq</span>.</p></div>
<div class="paragraph"><p>以上的例子中, 我们没有test, 是为了让大家看例子更清楚. 你当然可以in-line测试它, 就像在mailing list, 如下的方法一样.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_24">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Mailing list question regarding
<a href="https://groups.google.com/d/topic/liftweb/KBVhkuM1NQQ/discussion">how to
conditionally mark a SHtml.checkbox as disabled</a>.
</p>
</li>
<li>
<p>
<em>Simply Lift</em> <a href="http://simply.liftweb.net/index-7.10.html">7.10 CSS
Selector Transforms</a>.
</p>
</li>
</ul></div>
<div class="paragraph" id="MultiSelectBox"><p>使用一个选择框进行多选</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Problem
^^^^^^^

你想给用户展示很多可选项在一个多选box中,  然后允许用户多选他们.

Solution
^^^^^^^^

使用 `SHtml.multiSelect`:

[source,scala]
----
class MySnippet {
  def multi = {
    case class Item(id: String, name: String)
    val inventory = Item("a", "Coffee") :: Item("b", "Milk") ::
       Item("c", "Sugar") :: Nil

     val options : List[(String,String)] =
       inventory.map(i => (i.id -> i.name))

     val default = inventory.head.id :: Nil

     "#opts *" #>
       SHtml.multiSelect(options, default, xs => println("Selected: "+xs))
  }
}
----

相关的HTML如下:

[source,html]
---------------------------------------------------------
<div data-lift="MySnippet.multi?form=post">
  <p>What can I getcha?</p>
  <div id="opts">options go here</div>
  <input type="submit" value="Submit" />
</div>
---------------------------------------------------------

他们会被修饰为:

[source,html]
---------------------------------------------------------
<form action="/" method="post"><div>
  <p>What can I getcha?</p>
  <div id="opts">
   <select name="F25749422319ALP1BW" multiple="true">
     <option value="a" selected="selected">Coffee</option>
     <option value="b">Milk</option>
     <option value="c">Sugar</option>
   </select>
  </div>
  <input value="Submit" type="submit">
</form>
---------------------------------------------------------

Discussion
^^^^^^^^^^

请回忆, 一个CSS selector由很多可选的参数, 他们中每一个都有一个属性和对应的值. 请看上边的例子, 他使用`inventory` 的对象, 然后返回 (value,name) 一对string, 叫做 `options`.

给 `multiSelect`的方法, 将会使用value (ids), 而不是 names. 当你运行上边代码的时候 u安泽 "Coffee" 和 "Milk", 你将会看到`List("a", "b")`.

Selected No Options
+++++++++++++++++++

请注意, 如果没有任何选项被选, 你的方法叫不会被调用. 这个在ticket 1139中有提到过. 有一个解决方案, 是使用一个隐藏域并绑定方法. 比如说, 我们修改以上的code为stateful的snippet, 然后记录我们选择的值:

[source,scala]
---------------------------------------------------------
class MySnippet extends StatefulSnippet {

  def dispatch = {
    case "multi" => multi
  }

  case class Item(id: String, name: String)
  val inventory = Item("a", "Coffee") :: Item("b", "Milk") ::
    Item("c", "Sugar") :: Nil

  val options : List[(String,String)] = inventory.map(i => (i.id -> i.name))

  var current = inventory.head.id :: Nil

  def multi = "#opts *" #> (
    SHtml.hidden( () => current = Nil) ++
    SHtml.multiSelect(options, current, current = _)
  )
}
---------------------------------------------------------

每次提交表格后, `current` list会被设置为你在浏览器中选择的选项. 但是请注意, 我们有一个隐藏域, 可以重置 `current` 为一个空List, 这意味着, 在 `multiSelect` 中收到的方法将不会被调用, 这意味着, 你没有选择任何东西. 这也许会很有用, 不过取决于你的应用的行为.

Type-safe Options
+++++++++++++++++

如果你不想使用 `String` 在一个option中, 你可以使用 `multiSelectObj`. 这个情况下, options的例子依旧提供一个text name,但是值是一个class. 同时, 默认的list将是一个class实例的list:

[source,scala]
---------------------------------------------------------
val options : List[(Item,String)] = inventory.map(i => (i -> i.name))
val current = inventory.head :: Nil
---------------------------------------------------------

从数据中生成一个的方法是相似的, 但是请注意, 方法将收到一个 `Item` list:

[source,scala]
---------------------------------------------------------
"#opts *" #> SHtml.multiSelectObj(options, current,
  (xs: List[Item]) => println("Got "+xs) )
---------------------------------------------------------

Enumerations
++++++++++++

你可以使用 `multiSelectObj` 作为枚举:

[source,scala]
---------------------------------------------------------
object Item extends Enumeration {
  type Item = Value
  val Coffee, Milk, Sugar = Value
}

import Item._

val options : List[(Item,String)] =
  Item.values.toList.map(i => (i -> i.toString))

var current = Item.Coffee :: Nil

def multi = "#opts *" #> SHtml.multiSelectObj[Item](options, current,
  xs => println("Got "+xs) )
---------------------------------------------------------

See Also
^^^^^^^^

<<SelectOptionChange>> 介绍了如何触发一个服务端的行为, 当用户选择一个选项时.

_Exploring Lift_, Chapter 6, "Forms in Lift", http://exploring.liftweb.net/[http://exploring.liftweb.net/].

关于没有选项的Ticket: https://github.com/lift/framework/issues/1139[https://github.com/lift/framework/issues/1139]



[[FileUpload]]
文件上传</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_problem_26">Problem</h4>
<div class="paragraph"><p>你想你的snippet允许用户上传文件.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_25">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">FileParamHolder</span> 在你的snippet中, 然后解析文件信息, 当表格提交时.</p></div>
<div class="paragraph"><p>从设置一个表格为 "multipart=true" 开始:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>File Upload<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jquery&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;json&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/json.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;FileUploadSnippet?form=post;multipart=true&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;</span>
     Select a file: <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
   <span class="nt">&lt;/label&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Submit&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>通过以下code绑定snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.FileParamHolder</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.</span><span class="o">{</span><span class="nc">Loggable</span><span class="o">,</span> <span class="nc">Full</span><span class="o">,</span> <span class="nc">Empty</span><span class="o">,</span> <span class="nc">Box</span><span class="o">}</span>


<span class="k">class</span> <span class="nc">FileUploadSnippet</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">upload</span> <span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">FileParamHolder</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Empty</span>

    <span class="k">def</span> <span class="n">processForm</span><span class="o">()</span> <span class="k">=</span> <span class="n">upload</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="nc">FileParamHolder</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">file</span><span class="o">))</span> <span class="k">=&gt;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;%s of type %s is %d bytes long&quot;</span> <span class="n">format</span> <span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="n">length</span><span class="o">))</span>

      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="o">(</span><span class="s">&quot;No file?&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="s">&quot;#file&quot;</span> <span class="o">#&gt;</span> <span class="n">fileUpload</span><span class="o">(</span><span class="n">f</span> <span class="k">=&gt;</span> <span class="n">upload</span> <span class="k">=</span> <span class="nc">Full</span><span class="o">(</span><span class="n">f</span><span class="o">))</span> <span class="o">&amp;</span>
      <span class="s">&quot;type=submit&quot;</span> <span class="o">#&gt;</span> <span class="n">onSubmitUnit</span><span class="o">(</span><span class="n">processForm</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>这段代码允许你, 在提交表格时, 访问 <span class="monospaced">Array[Byte]</span> 在 `processForm`方法中.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_26">Discussion</h4>
<div class="paragraph"><p>HTTP包含一种编码为"multipart/form-data"用来提供上传二进制代码的功能.  <span class="monospaced">?form=post;multipart=true</span> 参数是告诉HTML使用这种编码, 当HTML生成时会有如下:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;/fileupload&quot;</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>当浏览器提交表格时, Lift发现 "multipart/form-data" 编码然后从参数中解析文件.  这个参数时 <span class="monospaced">uploadedFiles</span> 在 <span class="monospaced">Req</span> 对象中, 比如说:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">files</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">FileParamHolder</span><span class="o">]</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">uploadedFiles</span><span class="o">)</span> <span class="n">openOr</span> <span class="nc">Nil</span>
</pre></div></div></div>
<div class="paragraph"><p>然而, 当我们处理只有一个文件上传的时候, 使用 <span class="monospaced">SHtml.fileUpload</span> 绑定input的 <span class="monospaced">upload</span> 变量是一种简单的实现方法.  Lift会组织 <span class="monospaced">f =&gt; upload = Full(f)</span> 方法, 当一个文件被选择为上传文件的时候. 如果文件的长度是0, 方法将不会被调用.</p></div>
<div class="paragraph"><p>Lift的默认行为是将浏览器中的文件读入内存, 然后作为 <span class="monospaced">FileParamHolder</span>.  在这里我们使用匹配去找到 <span class="monospaced">FileParamHolder</span> 然后print出我们知道关于文件的信息.  我们忽略了第一个参数, 它是一个Lift自动生产的名字, 并且保存这mime类型, 原始的文件名和书都存在里面.</p></div>
<div class="paragraph"><p>你也许不能用这个方法上传一个很大的文件. 事实上, <span class="monospaced">LiftRules</span> 提供了一个上传文件大小的限制:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">LiftRules.maxMimeFileSize</span>&#8201;&#8212;&#8201;最大单一上传文件 (7MB by default).
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.maxMimeSize</span>&#8201;&#8212;&#8201;最大多文件上传 (8MB by default)
</p>
</li>
</ul></div>
<div class="paragraph"><p>为什么使用这两个设置?  因为当表格提交的时候, 表格里会有很多个域.  比如说, 在这个例子中, 提交按钮的值将会作为一部分, 文件会是另一部分. 因此, 你需要限制文件大小, 但是允许别的域上传, 或者多文件上传.</p></div>
<div class="paragraph"><p>如果你超过了文件上传大小, 一个异常会从上传文件库中抛出. 你可以catch这个异常 <a href="#CatchException">[CatchException]</a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">x</span> <span class="k">:</span> <span class="kt">FileUploadIOException</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">ResponseWithReason</span><span class="o">(</span><span class="nc">BadResponse</span><span class="o">(),</span> <span class="s">&quot;Unable to process file. Too large?&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>请注意, 容器 (Jetty, Tomcat) 或者其他web容器 (Apache, NGINX)都有自己的上传文件大小限制.</p></div>
<div class="paragraph" id="UploadToDisk"><p>上传文件缓存在内存中, 也许在一些情况下是可以的, 但是你也许想上传一个大点的文件, 并且让Lift以stream来处理它们.  Lift提供对这个需求的支持:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">handleMimeFile</span> <span class="k">=</span> <span class="nc">OnDiskFileParamHolder</span><span class="o">.</span><span class="n">apply</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">handleMimeFile</span> 需要一个方法包含 name, mime type, filename 和 <span class="monospaced">InputStream</span> 然后返回一个 <span class="monospaced">FileParamHolder</span>.  默认的实现是使用 <span class="monospaced">InMemFileParamHolder</span>, 但是,当改成 <span class="monospaced">OnDiskFileParamHolder`时, 意味着Lift将会首先把文件写入硬盘. 你当然也可以自己写 `OnDiskFileParamHolder</span> 或者 <span class="monospaced">InMemFileParamHolder</span>.</p></div>
<div class="paragraph"><p>当使用 <span class="monospaced">OnDiskFileParamHolder</span>, 文件会被写入一个临时空间(<span class="monospaced">System.getProperty("java.io.tmpdir")</span>) 当你想删除时, 你可以随意删除它. 比如说, 我们的例子可以改成:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">processForm</span><span class="o">()</span> <span class="k">=</span> <span class="n">upload</span> <span class="k">match</span> <span class="o">{</span>

  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">content</span> <span class="k">:</span> <span class="kt">OnDiskFileParamHolder</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;File: &quot;</span><span class="o">+</span><span class="n">content</span><span class="o">.</span><span class="n">localFile</span><span class="o">.</span><span class="n">getAbsolutePath</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">InputStream</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">fileStream</span>
    <span class="c1">// ...do something with the stream here...</span>
    <span class="k">val</span> <span class="n">wasDeleted_?</span> <span class="k">=</span> <span class="n">content</span><span class="o">.</span><span class="n">localFile</span><span class="o">.</span><span class="n">delete</span><span class="o">()</span>

  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="o">(</span><span class="s">&quot;No file?&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>请注意, <span class="monospaced">OnDiskFileParamHolder</span> 实现了 <span class="monospaced">FileParamHolder</span> 所以会匹配 <span class="monospaced">FileParamHolder</span>. 然而, 如果你想访问  <span class="monospaced">OnDiskFileParamHolder</span> 的 <span class="monospaced">file</span> 域, 你将会被文件缓存到内存中, 这将会和存到硬盘, 然后用stream访问冲突.</p></div>
<div class="paragraph"><p>如果你想看服务器端如何处理上传文件的, 你可以使用,  <span class="monospaced">LiftRules</span> 的一个hook:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">progressPrinter</span><span class="o">(</span><span class="n">bytesRead</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">contentLength</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">fieldIndex</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;Read %d of %d for %d&quot;</span> <span class="n">format</span> <span class="o">(</span><span class="n">bytesRead</span><span class="o">,</span> <span class="n">contentLength</span><span class="o">,</span> <span class="n">fieldIndex</span><span class="o">))</span>
<span class="o">}</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">progressListener</span> <span class="k">=</span> <span class="n">progressPrinter</span>
</pre></div></div></div>
<div class="paragraph"><p>这是全部 multi-part 上传过程, 不知是一个文件被上传. 事实上,  <span class="monospaced">contentLength</span> 是未知的 (在这里例子中为 <span class="monospaced">-1</span>), 当时当全部完成的时候, 他将会被设置. 在这个例子中, 他会是文件的大小, 并且是提交按钮的值.  这也解释了 <span class="monospaced">fieldIndex</span>, 它是确定域被处理的顺序. 他将会是值 0 和 1 在这个例子中.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_25">See Also</h4>
<div class="paragraph"><p>HTTP上传的文档 RFC 1867, <em>Form-based File Upload in HTML</em>:
<a href="http://tools.ietf.org/html/rfc1867">http://tools.ietf.org/html/rfc1867</a></p></div>
<div class="paragraph"><p><a href="#RestBinaryData">[RestBinaryData]</a> REST服务的文件上传.</p></div>
<div class="paragraph"><p><a href="#AjaxFileUpload">[AjaxFileUpload]</a> 使用JavaScript的Ajax文件上传, 包含了拖拽功能.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="REST">REST</h2>
<div class="sectionbody">
<div class="paragraph"><p>这章是讲关于REST服务的, 通过使用 Lift 的 <span class="monospaced">RestHelper</span> trait. 作为一个介绍, 请看Lift Wiki <a href="https://www.assembla.com/spaces/liftweb/wiki/REST_Web_Services">https://www.assembla.com/spaces/liftweb/wiki/REST_Web_Services</a> and chapter 5 of <em>Simply Lift</em> at <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>.</p></div>
<div class="paragraph"><p>这章的代码在以下地方可以找到: <a href="https://github.com/LiftCookbook/cookbook_rest">https://github.com/LiftCookbook/cookbook_rest</a>.</p></div>
<div class="sect2">
<h3 id="DRYURLs">干净的URLs</h3>
<div class="sect3">
<h4 id="_problem_27">Problem</h4>
<div class="paragraph"><p>你发现你在重复一部分URL, 在使用 `RestHelper`的时候, 你不想重复的写同一段code.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_26">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">prefix</span> 在你的 <span class="monospaced">RestHelper</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>

<span class="k">object</span> <span class="nc">IssuesService</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">IssuesService</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span><span class="o">(</span><span class="s">&quot;issues&quot;</span> <span class="o">/</span> <span class="s">&quot;by-state&quot;</span> <span class="n">prefix</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;open&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">XmlGet</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">None</span> <span class="n">open</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
    <span class="k">case</span> <span class="s">&quot;closed&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">XmlGet</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">None</span> <span class="n">closed</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
    <span class="k">case</span> <span class="s">&quot;closed&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">XmlDelete</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">All</span> <span class="n">deleted</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
  <span class="o">})</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>这个服务回复URLs, <em>/issues/by-state/open</em> and <em>/issues/by-state/closed</em> 并且, 我们使用了 <span class="monospaced">prefix</span>.</p></div>
<div class="paragraph"><p>把这个连入 <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">code.rest.IssuesService</span>
<span class="nc">IssuesService</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>我们可以测试cURL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -H 'Content-Type: application/xml'
    http://localhost:8080/issues/by-state/open
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;p&gt;None open&lt;/p&gt;

$ curl -X DELETE -H 'Content-Type: application/xml'
    http://localhost:8080/issues/by-state/closed
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;p&gt;All deleted&lt;/p&gt;</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_27">Discussion</h4>
<div class="paragraph"><p>你有很多的 serve` 语句在你的 <span class="monospaced">RestHelper</span>, 他们构建了你的REST服务.</p></div>
<div class="paragraph"><p>在这里例子中, 我们决定返回 XML 并且匹配一个 XML request, 通过使用 <span class="monospaced">XmlGet</span> 和 <span class="monospaced">XmlDelete</span>. 对一个XML request的测试, 需要使用 <em>text/xml</em> 或者 <em>application/xml</em> 的content-type, 它是一个request以 <span class="monospaced">.xml`结尾. 这就是为什么cURL使用 `-H</span> 标签.  如果我们没有使用这个标签, 这个request将不会匹配任何条目, 然后将会返回 404 response.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_26">See Also</h4>
<div class="paragraph"><p><a href="#JSONREST">[JSONREST]</a> 给出一个接收并返回 JSON 的例子.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MissingSuffix">缺少文件后缀</h3>
<div class="sect3">
<h4 id="_problem_28">Problem</h4>
<div class="paragraph"><p>你的 <span class="monospaced">RestHelper</span> 需要一个文件名作为URL的一部分, 但是suffix(扩展名)丢失了, 但是你需要他.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_27">Solution</h4>
<div class="paragraph"><p>访问 <span class="monospaced">req.path.suffix</span> 来修复 suffix.</p></div>
<div class="paragraph"><p>比如说, 当处理 <span class="monospaced">/download/123.png</span> 你想你能够重新构建 <span class="monospaced">123.png</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">object</span> <span class="nc">Reunite</span> <span class="k">extends</span> <span class="nc">RestHelper</span>  <span class="o">{</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">reunite</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">suffix</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">suffix</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="n">name</span> <span class="k">else</span> <span class="n">name</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">suffix</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;You requested &quot;</span><span class="o">+</span><span class="n">reunite</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Reunite</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>我们匹配 <span class="monospaced">download</span> 但不是直接使用 <span class="monospaced">file</span> 的值, 我们把它放入 <span class="monospaced">reunite</span> 方法中, 让他找回后缀 (如果有后缀的话).</p></div>
<div class="paragraph"><p>对这种URL, 使用cURL做请求, 你会看到:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://127.0.0.1:8080/download/123.png
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
You requested 123.png</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_28">Discussion</h4>
<div class="paragraph"><p>当Lift处理一个request的时候, 它将request分割成几部分(比如说, 把一个路径变成<span class="monospaced">List[String]</span>). 这里包含了后缀. 这是一个非常好的做法, 因为有时候, 你需要匹配一个后缀, 但是却出现了我们这里提到的问题.</p></div>
<div class="paragraph"><p>这里设置了后缀的使用 <span class="monospaced">LiftRules.explicitlyParsedSuffixes</span>, 它把一个文件名分割出后缀. 它包含很多带逗号的后缀, (比如说 "png", "atom", "json")还有一些你也许不想要, 比如说 "com".</p></div>
<div class="paragraph"><p>请注意, 如果后缀没有在 <span class="monospaced">explicitlyParsedSuffixes</span> 中, 后缀将是一个空string, 并且 <span class="monospaced">name</span> (在上个例子中)会包含它的后缀.</p></div>
<div class="paragraph"><p>这取决于你的需求, 你也可以设置一个保护措施, 检查后缀:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s">&quot;png&quot;</span> <span class="k">=&gt;</span>
  <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;You requested PNG file called &quot;</span><span class="o">+</span><span class="n">file</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>或者简单的把后缀附在名字上, 有时候并不用修改后缀的. 比如说, 如果客户端支持 WebP 图像格式, 你这样发送它:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">object</span> <span class="nc">Reunite</span> <span class="k">extends</span> <span class="nc">RestHelper</span>  <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Reunite</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;negotiate&quot;</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">toSend</span> <span class="k">=</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;Accept&quot;</span><span class="o">).</span><span class="n">exists</span><span class="o">(</span><span class="k">_</span> <span class="o">==</span> <span class="s">&quot;image/webp&quot;</span><span class="o">))</span> <span class="n">file</span><span class="o">+</span><span class="s">&quot;.webp&quot;</span>
        <span class="k">else</span> <span class="n">file</span><span class="o">+</span><span class="s">&quot;.png&quot;</span>

      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;You requested &quot;</span><span class="o">+</span><span class="n">file</span><span class="o">+</span><span class="s">&quot;, would send &quot;</span><span class="o">+</span><span class="n">toSend</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>通过调用这个服务, 将会在决定哪个资源发送之前, 检查HTTP Accept header:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://localhost:8080/negotiate/123
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
You requested 123, would send 123.png

$ curl http://localhost:8080/negotiate/123 -H "Accept: image/webp"
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
You requested 123, would send 123.webp</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_27">See Also</h4>
<div class="paragraph"><p><a href="#MissingDotCom">[MissingDotCom]</a> 展示了如何删除 <span class="monospaced">explicitlyParsedSuffixes</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">HttpHelpers.scala</span> 的源码包含了 <span class="monospaced">explicitlyParsedSuffixes</span> list, 是一个默认的list包含所有的后缀:  <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/HttpHelpers.scala">https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/HttpHelpers.scala
</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MissingDotCom">Email地址中缺少.com</h3>
<div class="paragraph"><p>当我们通过REST提交一个email时, 一个域名以 ".com" 结尾, 但是在被 REST 处理前被删除.</p></div>
<div class="sect3">
<h4 id="_solution_28">Solution</h4>
<div class="paragraph"><p>修改 <span class="monospaced">LiftRules.explicitlyParsedSuffixes</span>, 这样Lift不会改变后缀 ".com".</p></div>
<div class="paragraph"><p>在 <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Helpers</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">explicitlyParsedSuffixes</span> <span class="k">=</span> <span class="nc">Helpers</span><span class="o">.</span><span class="n">knownSuffixes</span> <span class="o">&amp;~</span> <span class="o">(</span><span class="nc">Set</span><span class="o">(</span><span class="s">&quot;com&quot;</span><span class="o">))</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_29">Discussion</h4>
<div class="paragraph"><p>默认情况下, Lift会捕获文件的后缀, 这是为了匹配更方便: 也许你需要匹配 ".xml" or ".pdf".  然而, ".com" 是其中之一, 但是这会造成它的丢失.</p></div>
<div class="paragraph"><p>请注意, 这个不会影响在URL中间的email.  比如说, 请看如下的REST服务:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">object</span> <span class="nc">Suffix</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Suffix</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;email&quot;</span> <span class="o">::</span> <span class="n">e</span> <span class="o">::</span> <span class="s">&quot;send&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;In middle: &quot;</span><span class="o">+</span><span class="n">e</span><span class="o">)</span>

    <span class="k">case</span> <span class="s">&quot;email&quot;</span> <span class="o">::</span> <span class="n">e</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;At end: &quot;</span><span class="o">+</span><span class="n">e</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>在这个服务中, <span class="monospaced">init</span> 方法在 <span class="monospaced">Boot.scala</span> 中被调用, 我们可以通过request看发生的问题:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://localhost:8080/email/you@example.com/send
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
In middle: you@example.com

$ curl http://localhost:8080/email/you@example.com
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
At end: you@example</pre>
</div></div>
<div class="paragraph"><p>".com" 被认为是一个文件的后缀, 这就是为什么从后缀List中删除它会解决问题.</p></div>
<div class="paragraph"><p>请注意, 因为他是一个顶级域名, 比如说 ".uk", ".nl", ".gov", 不再 <span class="monospaced">explicitlyParsedSuffixes</span> 中, 这里的Email将不会被修改.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_28">See Also</h4>
<div class="paragraph"><p><a href="#MissingSuffix">[MissingSuffix]</a>  中介绍了更多关于后缀的介绍.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SuffixMatchFail">无法匹配前缀</h3>
<div class="sect3">
<h4 id="_problem_29">Problem</h4>
<div class="paragraph"><p>你尝试匹配一个后缀, 但是匹配失败.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_29">Solution</h4>
<div class="paragraph"><p>确保你匹配的后缀在 <span class="monospaced">LiftRules.explicitlyParsedSuffixes</span>.</p></div>
<div class="paragraph"><p>比如说, 假设你想匹配所有的问题以<span class="monospaced">.csv</span> 结尾, 在 <span class="monospaced">/reports/</span> URL中:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;reports&quot;</span> <span class="o">::</span> <span class="n">name</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="s">&quot;csv&quot;</span><span class="o">,</span> <span class="nc">GetRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Here&#39;s your CSV report for &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>你希望的到的是让 <span class="monospaced">/reports/foo.csv</span> 返回 "Here&#8217;s your CSV report
for foo", 但是你得到的是 404.</p></div>
<div class="paragraph"><p>为了解决这个问题, 包含 "csv" 作为一个Lift的后缀, 让Lift知道如何分离它.  在 <span class="monospaced">Boot.scala</span> 中添加:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">explicitlyParsedSuffixes</span> <span class="o">+=</span> <span class="s">&quot;csv&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>然后这个匹配就可以使用了.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_30">Discussion</h4>
<div class="paragraph"><p>如果不添加 ".csv" 到 <span class="monospaced">explicitlyParsedSuffixes</span>, URL将会使用:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;reports&quot;</span> <span class="o">::</span> <span class="n">name</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="nc">GetRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Here&#39;s your CSV report for &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>在这里我们匹配一个 (<span class="monospaced">""</span>). 在这里例子中, <span class="monospaced">name</span> 被设置为 "foo.csv".  这是因为Lift分割一个后缀, 只能分割在 <span class="monospaced">explicitlyParsedSuffixes`中的.  因为默认下, `csv</span> 并不在, "foo.csv" 将不会被分割. 这就是为什么 <span class="monospaced">csv</span> 在后缀匹配的时候, 不会被匹配.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_29">See Also</h4>
<div class="paragraph"><p><a href="#MissingSuffix">[MissingSuffix]</a> 解释了更多关于Lift的后缀缺失.</p></div>
<div class="paragraph" id="RestBinaryData"><p>在REST服务中接收二进制数据</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Problem
^^^^^^^

你想让用户上传一个图片, 或者二进制数据通过RESTFUL服务.

Solution
^^^^^^^^

通过访问request的body:

[source,scala]
----------------------
package code.rest

import net.liftweb.http.rest.RestHelper
import net.liftweb.http.LiftRules

object Upload extends RestHelper {

  def init() : Unit = {
    LiftRules.statelessDispatch.append(Upload)
  }

  serve {
    case "upload" :: Nil Post req =>
      for {
        bodyBytes <- req.body
      } yield <info>Received {bodyBytes.length} bytes</info>
  }

}
----------------------

把这个连入你的`Boot.scala`:

[source,scala]
----------------------
import code.rest.Upload
Upload.init()
----------------------

你可以使用cURL来测试:

----------------------
$ curl -X POST --data-binary "@dog.jpg" -H 'Content-Type: image/jpg'
    http://127.0.0.1:8080/upload
<?xml version="1.0" encoding="UTF-8"?>
<info>Received 1365418 bytes</info>
----------------------

Discussion
^^^^^^^^^^

在上边的例子中, 访问二进制数据通过`req.body`, 并且返回一个 `Box[Array[Byte]]`.  我们把它转换为 `Box[Elem]` 并发回客户端. 在 `RestHelper` 里, 会转为 `XmlResponse` 以供Lift处理.

请注意, 作为web容器, 比如说 Jetty 和 Tomcat, 会有上传限制. 当你看到以下错误的时候 "java.lang.IllegalStateException: Form too large705784>200000" 你就会知道上限是什么了.
你也可以通过查看文档来了解上限.

为了限制上传文件的类型, 你添加一个条件去匹配文件, 但是你会发现, 一个更简单的方法是, 你可以使用对象的 `unapply` .  比如说, 只允许上传JPEG文件:


[source,scala]
----------------------
serve {
  case "jpg" :: Nil Post JPeg(req) =>
    for {
      bodyBytes <- req.body
    } yield <info>Jpeg Received {bodyBytes.length} bytes</info>
  }

object JPeg {
  def unapply(req: Req): Option[Req] =
    req.contentType.filter(_ == "image/jpg").map(_ => req)
}
----------------------

我们定义了一个过滤器, 它将解析 `JPeg` , 如果文件类型为 "image/jpg", 返回一个 `Some[Req]`, ; 如果不是,  结果是 `None`. 这就是REST服务的匹配 `JPeg(req)`.  请注意, 方法 `unapply` 需要返回 `Option[Req]` 这是 `Post` 解析器所需要的类型.


See Also
^^^^^^^^

Odersky _et al._, (2008), _Programming in Scala_, chapter 24, 解释了什么是解析器: http://www.artima.com/pins1ed/extractors.html[http://www.artima.com/pins1ed/extractors.html].


<<FileUpload>> 解释了多文件上传



[[JSONREST]]
返回JSON</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_problem_30">Problem</h4>
<div class="paragraph"><p>你想返回一个JSON当使用REST Call.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_30">Solution</h4>
<div class="paragraph"><p>使用 Lift JSON domain specific language (DSL). 比如说:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonAST._</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonDSL._</span>

<span class="k">object</span> <span class="nc">QuotationsAPI</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">QuotationsAPI</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;quotation&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">JsonGet</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="o">(</span><span class="s">&quot;text&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;A beach house isn&#39;t just real estate. It&#39;s a state of mind.&quot;</span><span class="o">)</span> <span class="o">~</span>
        <span class="o">(</span><span class="s">&quot;by&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;Douglas Adams&quot;</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JValue</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Wire this into <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">code.rest.QuotationsAPI</span>
<span class="nc">QuotationsAPI</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>Running this example produces:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -H 'Content-type: text/json' http://127.0.0.1:8080/quotation
{
  "text":"A beach house isn't just real estate. It's a state of mind.",
  "by":"Douglas Adams"
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_31">Discussion</h4>
<div class="paragraph"><p><em>type ascription</em> 在 JSON 表达式的最后 (<span class="monospaced">: JValue</span>)
告诉了编译器, 表达式希望获得的类型为 <span class="monospaced">JValue</span>. 这是使用DSL时必须的. 如果没有强制它, 比如说, 你将会调用一个名叫 <span class="monospaced">JValue</span> 的方法.</p></div>
<div class="paragraph"><p>JSON DSL 允许你创建一个嵌套结构, lists 和其他你所有想做为JSON的东西.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_30">See Also</h4>
<div class="paragraph"><p>lift-json工程的README文件是一个非常好的学习lift-json的资源: <a href="https://github.com/lift/framework/tree/master/core/json">https://github.com/lift/framework/tree/master/core/json</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="GoogleSitemap">Google Sitemap</h3>
<div class="sect3">
<h4 id="_problem_31">Problem</h4>
<div class="paragraph"><p>你想使用Lift去创建一个Google Sitemap.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_31">Solution</h4>
<div class="paragraph"><p>建立一个sitemap的结构, 然后把它绑定在HTML模版上.</p></div>
<div class="paragraph"><p>我们从 <span class="monospaced">sitemap.html</span> 在你的 <span class="monospaced">webapp</span> 文件夹开始, 它包含一个有效的XML-Sitemap:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<span class="nt">&lt;urlset</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;url</span> <span class="na">data-lift=</span><span class="s">&quot;SitemapContent.base&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;loc&gt;&lt;/loc&gt;</span>
        <span class="nt">&lt;changefreq&gt;</span>daily<span class="nt">&lt;/changefreq&gt;</span>
        <span class="nt">&lt;priority&gt;</span>1.0<span class="nt">&lt;/priority&gt;</span>
        <span class="nt">&lt;lastmod&gt;&lt;/lastmod&gt;</span>
    <span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;url</span> <span class="na">data-lift=</span><span class="s">&quot;SitemapContent.list&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;loc&gt;&lt;/loc&gt;</span>
        <span class="nt">&lt;lastmod&gt;&lt;/lastmod&gt;</span>
    <span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/urlset&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>创建一个snippet去填补需要的地方:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">org.joda.time.DateTime</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.CssSel</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="k">class</span> <span class="nc">SitemapContent</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Post</span><span class="o">(</span><span class="n">url</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span>

  <span class="k">lazy</span> <span class="k">val</span> <span class="n">entries</span> <span class="k">=</span>
    <span class="nc">Post</span><span class="o">(</span><span class="s">&quot;/welcome&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Post</span><span class="o">(</span><span class="s">&quot;/about&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">val</span> <span class="n">siteLastUdated</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DateTime</span>

  <span class="k">def</span> <span class="n">base</span><span class="k">:</span> <span class="kt">CssSel</span> <span class="o">=</span>
    <span class="s">&quot;loc *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;http://%s/&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">S</span><span class="o">.</span><span class="n">hostName</span><span class="o">)</span> <span class="o">&amp;</span>
      <span class="s">&quot;lastmod *&quot;</span> <span class="o">#&gt;</span> <span class="n">siteLastUdated</span><span class="o">.</span><span class="n">toString</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZZ&quot;</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">list</span><span class="k">:</span> <span class="kt">CssSel</span> <span class="o">=</span>
    <span class="s">&quot;url *&quot;</span> <span class="o">#&gt;</span> <span class="n">entries</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">post</span> <span class="k">=&gt;</span>
      <span class="s">&quot;loc *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;http://%s%s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">S</span><span class="o">.</span><span class="n">hostName</span><span class="o">,</span> <span class="n">post</span><span class="o">.</span><span class="n">url</span><span class="o">)</span> <span class="o">&amp;</span>
        <span class="s">&quot;lastmod *&quot;</span> <span class="o">#&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">toString</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZZ&quot;</span><span class="o">))</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>这个例子是, 用存储的信息在两个页面上.</p></div>
<div class="paragraph"><p>使用HTML模版和snippet在一个REST服务中在URL `/sitemap`上:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>

<span class="k">object</span> <span class="nc">Sitemap</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>
  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;sitemap&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="nc">GetRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="nc">XmlResponse</span><span class="o">(</span>
        <span class="n">S</span><span class="o">.</span><span class="n">render</span><span class="o">(&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">embed</span> <span class="kt">what</span><span class="o">=</span><span class="s">&quot;sitemap&quot;</span> <span class="o">/&gt;,</span>
        <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">request</span><span class="o">).</span><span class="n">head</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>把它连入你的 <span class="monospaced">Boot.scala</span>, 比如说:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="nc">Sitemap</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>测试服务, 通过使用cURL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>curl http://127.0.0.1:8080/sitemap

&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;
&lt;urlset <span class="nv">xmlns</span><span class="o">=</span><span class="s2">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>&gt;
    &lt;url&gt;
        &lt;loc&gt;http://127.0.0.1/&lt;/loc&gt;
        &lt;changefreq&gt;daily&lt;/changefreq&gt;
        &lt;priority&gt;1.0&lt;/priority&gt;
        &lt;lastmod&gt;2013-02-10T19:16:12.433+00:00&lt;/lastmod&gt;
    &lt;/url&gt;
    &lt;url&gt;
        &lt;loc&gt;http://127.0.0.1/welcome&lt;/loc&gt;
        &lt;lastmod&gt;2013-02-10T19:16:12.434+00:00&lt;/lastmod&gt;
    &lt;/urrl&gt;&lt;url&gt;
        &lt;loc&gt;http://127.0.0.1/about&lt;/loc&gt;
        &lt;lastmod&gt;2013-02-10T19:16:12.434+00:00&lt;/lastmod&gt;
    &lt;/url&gt;
&lt;/urlset&gt;
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_32">Discussion</h4>
<div class="paragraph"><p>你也许很奇怪, 为什么我们在这里使用 REST , 这里我们只有一些普通的HTML和snippet. 原因是我们想使用XML而不是HTML作为输出.  我们使用相同的机制, 但是把他作为一个 <span class="monospaced">XmlResponse</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">S.render</span> 方法, 需要 <span class="monospaced">NodeSeq</span> 和 <span class="monospaced">HTTPRequst</span> 作为参数. 第一个参数, 我们提供它通过运行<span class="monospaced">sitemap.html</span> snippet; 第二个参数我们使用现在的request.  <span class="monospaced">XmlResponse</span> 需要一个 <span class="monospaced">Node`而不是一个 `NodeSeq</span>, 这就是为什么我们调用 <span class="monospaced">head</span>&#8201;&#8212;&#8201;它是这里唯一的Node, 并且是我们需要的类型.</p></div>
<div class="paragraph"><p>请注意, Google Sitemaps 需要日期是 ISO 8601 格式. 内奸的 <span class="monospaced">java.text.SimpleDateFormat</span> 直到Java 7都不支持这种格式. 如果你正在使用Java 6 你可以使用 <span class="monospaced">org.joda.time.DateTime</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_31">See Also</h4>
<div class="paragraph"><p>Sitemaps在这里有说明: <a href="http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=156184">http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=156184</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="iOSNativePost">在IOS应用中调用REST服务</h3>
<div class="sect3">
<h4 id="_problem_32">Problem</h4>
<div class="paragraph"><p>你想使用HTTP POST通过REST服务在IOS中.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_32">Solution</h4>
<div class="paragraph"><p>使用 <span class="monospaced">NSURLConnection</span> 确保你的内容类型为 "application/json".</p></div>
<div class="paragraph"><p>比如说, 假设我们想调用这个服务:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonDSL._</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonAST._</span>

<span class="k">object</span> <span class="nc">Shouty</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">greet</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JValue</span> <span class="o">=</span>
    <span class="s">&quot;greeting&quot;</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="s">&quot;HELLO &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">)</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;shout&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">JsonPost</span> <span class="n">json</span><span class="o">-&gt;</span><span class="n">request</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span> <span class="nc">JString</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="o">(</span><span class="n">json</span> <span class="o">\\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">toOpt</span> <span class="o">}</span>
      <span class="k">yield</span> <span class="n">greet</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>这个服务需要一个 JSON post 和一个名为 "name"的参数, 然后它返回一个JSON对象.  为了展示数据是如何从服务器输入, 输出, 我们可以添加以下语句到 <span class="monospaced">Boot.scala</span>&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Shouty</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;and then call it from the command line:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -d '{ "name" : "Richard" }' -X POST -H 'Content-type: application/json'
   http://127.0.0.1:8080/shout
{
  "greeting":"HELLO RICHARD"
}</pre>
</div></div>
<div class="paragraph"><p>我们实现POST通过 <span class="monospaced">NSURLConnection</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="s">@&quot;http://localhost:8080/shout&quot;</span><span class="p">;</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">postAction</span> <span class="p">{</span>
  <span class="c1">// JSON data:</span>
  <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">dic</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;name&quot;</span><span class="o">:</span> <span class="s">@&quot;Richard&quot;</span><span class="p">};</span>
  <span class="n">NSData</span><span class="o">*</span> <span class="n">jsonData</span> <span class="o">=</span>
    <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="n">dataWithJSONObject</span><span class="o">:</span><span class="n">dic</span> <span class="n">options</span><span class="o">:</span><span class="mi">0</span> <span class="n">error</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
  <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">NSMutableURLRequest</span> <span class="n">requestWithURL</span><span class="o">:</span><span class="p">[</span><span class="n">NSURL</span> <span class="n">URLWithString</span><span class="o">:</span><span class="n">url</span><span class="p">]</span>
    <span class="nl">cachePolicy:</span><span class="n">NSURLRequestUseProtocolCachePolicy</span> <span class="n">timeoutInterval</span><span class="o">:</span><span class="mf">60.0</span><span class="p">];</span>

  <span class="c1">// Construct HTTP request:</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPMethod</span><span class="o">:</span><span class="s">@&quot;POST&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="s">@&quot;application/json&quot;</span> <span class="n">forHTTPHeaderField</span><span class="o">:</span><span class="s">@&quot;Content-Type&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">jsonData</span> <span class="n">length</span><span class="p">]]</span>
    <span class="nl">forHTTPHeaderField:</span><span class="s">@&quot;Content-Length&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPBody</span><span class="o">:</span> <span class="n">jsonData</span><span class="p">];</span>

  <span class="c1">// Send the request:</span>
  <span class="n">NSURLConnection</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSURLConnection</span> <span class="n">alloc</span><span class="p">]</span>
    <span class="nl">initWithRequest:</span><span class="n">request</span> <span class="n">delegate</span><span class="o">:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span>
  <span class="nl">didReceiveResponse:</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="p">)</span><span class="nv">response</span> <span class="p">{</span>
   <span class="c1">// Start off with new, empty, response data</span>
   <span class="n">self</span><span class="p">.</span><span class="n">receivedJSONData</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableData</span> <span class="n">data</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span>
  <span class="nl">didReceiveData:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span> <span class="p">{</span>
   <span class="c1">// append incoming data</span>
   <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">receivedJSONData</span> <span class="n">appendData</span><span class="o">:</span><span class="n">data</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span>
  <span class="nl">didFailWithError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error occurred &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connectionDidFinishLoading:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span> <span class="p">{</span>
  <span class="n">NSError</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
  <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">JSON</span> <span class="o">=</span>
    <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="n">JSONObjectWithData</span><span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">receivedJSONData</span>
    <span class="nl">options:</span> <span class="n">NSJSONReadingMutableContainers</span> <span class="n">error</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">];</span>
  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Return result: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">JSON</span> <span class="n">objectForKey</span><span class="o">:</span><span class="s">@&quot;greeting&quot;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>显然的, 这里我们有很多很难的code, 不过不用担心, 他们只是你的一个你应用的开始点.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_33">Discussion</h4>
<div class="paragraph"><p>做HTTP POST在IOS中有很多方法, 并且很难判断哪种是最好的方法, 特别是没有一个很好的外部支持库. 上面的例子使用的是原生的IOS API.</p></div>
<div class="paragraph"><p>另一个方法是使用 <em>AFNetworking</em>. 这是一个非常流行的外部库在iOS开发中, 在很多情况下, 它很有用:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#import &quot;AFHTTPClient.h&quot;</span>
<span class="cp">#import &quot;AFNetworking.h&quot;</span>
<span class="cp">#import &quot;JSONKit.h&quot;</span>

<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="s">@&quot;http://localhost:8080/shout&quot;</span><span class="p">;</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">postAction</span> <span class="p">{</span>
  <span class="c1">// JSON data:</span>
  <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">dic</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;name&quot;</span><span class="o">:</span> <span class="s">@&quot;Richard&quot;</span><span class="p">};</span>
  <span class="n">NSData</span><span class="o">*</span> <span class="n">jsonData</span> <span class="o">=</span>
   <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="n">dataWithJSONObject</span><span class="o">:</span><span class="n">dic</span> <span class="n">options</span><span class="o">:</span><span class="mi">0</span> <span class="n">error</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>

  <span class="c1">// Construct HTTP request:</span>
  <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span>
   <span class="p">[</span><span class="n">NSMutableURLRequest</span> <span class="n">requestWithURL</span><span class="o">:</span><span class="p">[</span><span class="n">NSURL</span> <span class="n">URLWithString</span><span class="o">:</span><span class="n">url</span><span class="p">]</span>
    <span class="nl">cachePolicy:</span><span class="n">NSURLRequestUseProtocolCachePolicy</span> <span class="n">timeoutInterval</span><span class="o">:</span><span class="mf">60.0</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPMethod</span><span class="o">:</span><span class="s">@&quot;POST&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="s">@&quot;application/json&quot;</span> <span class="n">forHTTPHeaderField</span><span class="o">:</span><span class="s">@&quot;Content-Type&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">jsonData</span> <span class="n">length</span><span class="p">]]</span>
    <span class="nl">forHTTPHeaderField:</span><span class="s">@&quot;Content-Length&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPBody</span><span class="o">:</span> <span class="n">jsonData</span><span class="p">];</span>

  <span class="c1">// Send the request:</span>
  <span class="n">AFJSONRequestOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span>
    <span class="p">[[</span><span class="n">AFJSONRequestOperation</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithRequest</span><span class="o">:</span> <span class="n">request</span><span class="p">];</span>
  <span class="p">[</span><span class="n">operation</span> <span class="n">setCompletionBlockWithSuccess</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span>
    <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span>
  <span class="p">{</span>
     <span class="n">NSString</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="p">[</span><span class="n">operation</span> <span class="n">responseString</span><span class="p">];</span>

     <span class="c1">// Use JSONKit to deserialize the response into NSDictionary</span>
     <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">deserializedJSON</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span> <span class="n">objectFromJSONString</span><span class="p">];</span>
     <span class="p">[</span><span class="n">deserializedJSON</span> <span class="n">count</span><span class="p">];</span>

     <span class="c1">// The response object can be a NSDicionary or a NSArray:</span>
      <span class="k">if</span><span class="p">([</span><span class="n">deserializedJSON</span> <span class="n">count</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Return value: %@&quot;</span><span class="p">,[</span><span class="n">deserializedJSON</span> <span class="n">objectForKey</span><span class="o">:</span><span class="s">@&quot;greeting&quot;</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">deserializedJSONArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span> <span class="n">objectFromJSONString</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Return array value: %@&quot;</span><span class="p">,</span> <span class="n">deserializedJSONArray</span> <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span><span class="n">failure</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
  <span class="p">}];</span>
  <span class="p">[</span><span class="n">operation</span> <span class="n">start</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">NSURLConnection</span> 的做法是给你更多功能的选择, 让你的starting point去构造你自己的解决方案, 比如说, 让内容类型(content-type)更明确. 然而, <span class="monospaced">AFNetworking</span> 更流行, 所以你也许更喜欢它.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_32">See Also</h4>
<div class="paragraph"><p>你能找到 "Complete REST Example" 在 <em>Simply Lift</em>. <a href="http://simply.liftweb.net/index-5.4.html">http://simply.liftweb.net/index-5.4.html</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ajax">JavaScript, Ajax, Comet</h2>
<div class="sectionbody">
<div class="paragraph"><p>For an introduction to Lift&#8217;s Ajax and Comet features, read <em>Simply Lift</em> at <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>, chapter 9 of <em>Lift in Action</em> (Perrett, 2012, Manning Publications Co.), or watch Diego Medina&#8217;s video presentation at <a href="https://fmpwizard.telegr.am/blog/comet-actors-presentation">https://fmpwizard.telegr.am/blog/comet-actors-presentation</a>.</p></div>
<div class="paragraph"><p>This chapter&#8217;s source code is: <a href="https://github.com/LiftCookbook/cookbook_ajax">https://github.com/LiftCookbook/cookbook_ajax</a>.</p></div>
<div class="sect2">
<h3 id="ButtonTriggerServerCode">Trigger Server-Side Code from a Button</h3>
<div class="sect3">
<h4 id="_problem_33">Problem</h4>
<div class="paragraph"><p>You want to trigger some server-side code when the user presses a
button.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_33">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">ajaxInvoke</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.</span><span class="o">{</span><span class="nc">JsCmd</span><span class="o">,</span> <span class="nc">JsCmds</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.Loggable</span>

<span class="k">object</span> <span class="nc">AjaxInvoke</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">callback</span><span class="o">()</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;The button was pressed&quot;</span><span class="o">)</span>
    <span class="nc">JsCmds</span><span class="o">.</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;You clicked it&quot;</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">button</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxInvoke</span><span class="o">(</span><span class="n">callback</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In this snippet we are binding the click event of a button to an <span class="monospaced">ajaxInvoke</span>: when the button is pressed, Lift
arranges for the function you gave <span class="monospaced">ajaxInvoke</span> to be executed.</p></div>
<div class="paragraph"><p>That function, <span class="monospaced">callback</span>, is just logging a message and returning a JavaScript alert to the browser. The corresponding HTML might include:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;AjaxInvoke.button&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_34">Discussion</h4>
<div class="paragraph"><p>The signature of the function you pass to <span class="monospaced">ajaxInvoke</span> is
<span class="monospaced">Unit =&gt; JsCmd</span>, meaning you can trigger a range of behaviours, from
returning <span class="monospaced">Noop</span> if you want nothing to happen, through changing DOM
element, all the way up to executing arbitrary JavaScript.</p></div>
<div class="paragraph"><p>The example above is using a button, but will work on any element that
has an event you can bind to.  We&#8217;re binding to <em>onclick</em> but it could be any event
the DOM exposes.</p></div>
<div class="paragraph"><p>Related to <span class="monospaced">ajaxInvoke</span> are the following functions:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">SHtml.onEvent</span> which calls a function with the signature <span class="monospaced">String =&gt; JsCmd</span> because it
is passed the <span class="monospaced">value</span> of the node it is attached to. In the above
example, this would be the empty string as the button has no value.
</p>
</li>
<li>
<p>
<span class="monospaced">SHtml.ajaxCall</span> which is, in a sense, more general than <span class="monospaced">onEvent</span>, as you give it the expression you want passed to your server-side code.
</p>
</li>
<li>
<p>
<span class="monospaced">SHtml.jsonCall</span> which is even more general still: you give it a function
that will return a JSON object when executed on the client, and this
object will be passed to your server-side function.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Let&#8217;s look at each of these in turn.</p></div>
<div class="sect4">
<h5 id="_onevent_8201_8212_8201_receiving_the_span_class_monospaced_value_span_of_a_dom_element">onEvent&#8201;&#8212;&#8201;Receiving the <span class="monospaced">value</span> of a DOM Element</h5>
<div class="paragraph"><p>You can use <span class="monospaced">onEvent</span> with any element that has a <span class="monospaced">value</span> attribute and responds to the event you choose to bind to. The function you supply to <span class="monospaced">onEvent</span> is called with the element&#8217;s value. As an example, we can write a snippet which presents a challenge to the user, and validates the response:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">scala.util.Random</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Alert</span>

<span class="k">object</span> <span class="nc">OnEvent</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span> <span class="k">=</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">sum</span> <span class="k">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

    <span class="s">&quot;p *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;What is %d + %d?&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="o">&amp;</span>
    <span class="s">&quot;input [onchange]&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">onEvent</span><span class="o">(</span> <span class="n">answer</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">answer</span> <span class="o">==</span> <span class="n">sum</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Correct!&quot;</span><span class="o">)</span>
      <span class="k">else</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Try again&quot;</span><span class="o">)</span>
     <span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This snippet prompts the user to add two random numbers in the <span class="monospaced">&lt;p&gt;</span> tag, and binds a validation function to the <span class="monospaced">&lt;input&gt;</span> on the page:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;OnEvent&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;</span>Problem appears here<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">placeholder=</span><span class="s">&quot;Type your answer&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>When <span class="monospaced">onchange</span> is triggered (by pressing return or the tab key, for example), the text entered is sent to our <span class="monospaced">onEvent</span> function as a <span class="monospaced">String</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_ajaxcall_8201_8212_8201_receiving_an_arbitrary_client_side_string">ajaxCall&#8201;&#8212;&#8201;Receiving an Arbitrary Client-Side String</h5>
<div class="paragraph"><p>Where <span class="monospaced">onEvent</span> sends <span class="monospaced">this.value</span> to your server-side code, <span class="monospaced">ajaxCall</span> allows you to specify the client-side expression used to produce a value.</p></div>
<div class="paragraph"><p>To demonstrate this we can create a template that includes two elements: a button and a text field.  We&#8217;ll bind our function to the button, but read a value from the input field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;AjaxCall&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;41&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
  <span class="nt">&lt;button&gt;</span>Increment<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>We want to arrange for the button to read the <span class="monospaced">num</span> field, increment it, and return it back to the input field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JE.ValById</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds._</span>

<span class="k">object</span> <span class="nc">AjaxCall</span> <span class="o">{</span>

 <span class="k">def</span> <span class="n">increment</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
  <span class="n">asInt</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span> <span class="n">openOr</span> <span class="n">in</span>

 <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span>
   <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxCall</span><span class="o">(</span><span class="nc">ValById</span><span class="o">(</span><span class="s">&quot;num&quot;</span><span class="o">),</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">SetValById</span><span class="o">(</span><span class="s">&quot;num&quot;</span><span class="o">,</span> <span class="n">increment</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">)</span>

 <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The first argument to <span class="monospaced">ajaxCall</span> is the expression that will produce a value for our function. It can be any <span class="monospaced">JsExp</span>, and we&#8217;ve
used <span class="monospaced">ValById</span> which looks up the value of an element by the id attribute.  We could have used a regular JQuery expression to achieve the same effect with: <span class="monospaced">JsRaw("$('#num').val()")</span>.</p></div>
<div class="paragraph"><p>Our second argument to <span class="monospaced">ajaxCall</span> takes the value of the <span class="monospaced">JsExp</span> expression as a <span class="monospaced">String</span>. We&#8217;re using one of Lift&#8217;s JavaScript command to replaces the value with a new value. The new value is the result of incrementing the number (providing it is a number).</p></div>
<div class="paragraph"><p>The end result is that you press the button, and the number updates. It should go without saying that these are simple illustrations, and you probably don&#8217;t want a server round-trip to add one to a number. The techniques come into their own when there is some action of value to perform on the server.</p></div>
<div class="paragraph"><p>You may have guessed that <span class="monospaced">onEvent</span> is implemented as an <span class="monospaced">ajaxCall</span> for <span class="monospaced">JsRaw("this.value")</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_jsoncall_8201_8212_8201_receiving_a_json_value">jsonCall&#8201;&#8212;&#8201;Receiving a JSON Value</h5>
<div class="paragraph"><p>Both <span class="monospaced">ajaxCall</span> and <span class="monospaced">onEvent</span> end up evaluating a <span class="monospaced">String =&gt; JsCmd</span> function. By contrast, <span class="monospaced">jsonCall</span> has the signature <span class="monospaced">JValue =&gt; JsCmd</span>, meaning you can pass more complex data structures from JavaScript to your Lift application.</p></div>
<div class="paragraph"><p>To demonstrate this, we&#8217;ll create a template that asks for input, has a function to convert the input into JSON, and a button to send the JSON to the server:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;JsonCall&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;</span>Enter an addition question:<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;x&quot;</span><span class="nt">&gt;</span> + <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;y&quot;</span><span class="nt">&gt;</span> = <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;z&quot;</span><span class="nt">&gt;</span>.
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button&gt;</span>Check<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
// <span class="cp">&lt;![CDATA[</span>
<span class="cp">function currentQuestion() {</span>
<span class="cp">  return {</span>
<span class="cp">    first:  parseInt($(&#39;#x&#39;).val()),</span>
<span class="cp">    second: parseInt($(&#39;#y&#39;).val()),</span>
<span class="cp">    answer: parseInt($(&#39;#z&#39;).val())</span>
<span class="cp">  };</span>
<span class="cp">}</span>
<span class="cp">// ]]&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>On the server we&#8217;ll check that the JSON represents a valid integer addition problem:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.</span><span class="o">{</span><span class="nc">JsCmd</span><span class="o">,</span> <span class="nc">JE</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.Loggable</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonAST._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Alert</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.DefaultFormats</span>

<span class="k">object</span> <span class="nc">JsonCall</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="n">formats</span> <span class="k">=</span> <span class="nc">DefaultFormats</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Question</span><span class="o">(</span><span class="n">first</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">second</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">answer</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">valid_?</span> <span class="k">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">second</span> <span class="o">==</span> <span class="n">answer</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">def</span> <span class="n">validate</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">JValue</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
      <span class="n">value</span><span class="o">.</span><span class="n">extractOpt</span><span class="o">[</span><span class="kt">Question</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">valid_?</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Looks good&quot;</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;That doesn&#39;t add up&quot;</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;That doesn&#39;t make sense&quot;</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span>
      <span class="nc">SHtml</span><span class="o">.</span><span class="n">jsonCall</span><span class="o">(</span> <span class="nc">JE</span><span class="o">.</span><span class="nc">Call</span><span class="o">(</span><span class="s">&quot;currentQuestion&quot;</span><span class="o">),</span> <span class="n">validate</span> <span class="k">_</span> <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Working from the bottom of this snippet up, we see a binding of the <span class="monospaced">&lt;button&gt;</span> to the <span class="monospaced">jsonCall</span>. The value we&#8217;ll be working on is the value provided by the JavaScript function called <span class="monospaced">currentQuestion</span>.  This was defined on the template page.  When the button is clicked the JavaScript function is called and the resulting value will be presented to <span class="monospaced">validate</span>, which is our <span class="monospaced">JValue =&gt; JsCmd</span> function.</p></div>
<div class="paragraph"><p>All <span class="monospaced">validate</span> does is log the JSON data and alert back if the question looks correct or not.  To do this we use the Lift JSON ability to extract JSON to a case class and call the <span class="monospaced">valid_?</span> test to see if the numbers add up.  This will evaluate to <span class="monospaced">Some(true)</span> if the addition works, <span class="monospaced">Some(false)</span> if the addition isn&#8217;t correct or <span class="monospaced">None</span> if the input is missing or not a valid integer.</p></div>
<div class="paragraph"><p>Running the code and entering 1, 2 and 3 into the text fields will produce the following in the server log:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">JObject</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="nc">JField</span><span class="o">(</span><span class="n">first</span><span class="o">,</span><span class="nc">JInt</span><span class="o">(</span><span class="mi">1</span><span class="o">)),</span> <span class="nc">JField</span><span class="o">(</span><span class="n">second</span><span class="o">,</span><span class="nc">JInt</span><span class="o">(</span><span class="mi">2</span><span class="o">)),</span>
  <span class="nc">JField</span><span class="o">(</span><span class="n">answer</span><span class="o">,</span><span class="nc">JInt</span><span class="o">(</span><span class="mi">3</span><span class="o">))))</span>
</pre></div></div></div>
<div class="paragraph"><p>This is the <span class="monospaced">JValue</span> representation of the JSON.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_33">See Also</h4>
<div class="paragraph"><p><a href="#SelectOptionChange">[SelectOptionChange]</a> includes an example of <span class="monospaced">SHtml.onEvents</span> which will bind a function to a number of events on a <span class="monospaced">NodeSeq</span>.</p></div>
<div class="paragraph"><p>For another example of <span class="monospaced">AjaxInvoke</span> take a look at the <em>Call Scala code from JavaScript</em> section of Diego Medina&#8217;s blog at: <a href="http://blog.fmpwizard.com/scala-lift-custom-wizard">http://blog.fmpwizard.com/scala-lift-custom-wizard</a>.</p></div>
<div class="paragraph"><p><em>Exploring Lift</em>, chapter 10, lists various <span class="monospaced">JsExp</span> classes you can use for <span class="monospaced">ajaxCall</span>: <a href="http://exploring.liftweb.net/master/index-10.html">http://exploring.liftweb.net/master/index-10.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SelectOptionChange">Call Server when Select Option Changes</h3>
<div class="sect3">
<h4 id="_problem_34">Problem</h4>
<div class="paragraph"><p>When a HTML select option is selected, you want to trigger a function on the server.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_34">Solution</h4>
<div class="paragraph"><p>Register a <span class="monospaced">String =&gt; JsCmd</span> function with <span class="monospaced">SHtml.ajaxSelect</span>.</p></div>
<div class="paragraph"><p>In this example we will lookup the distance from Earth to the planet a user selects.  This lookup will
happen on the server and update the browser with the result:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;HtmlSelectSnippet&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>Planet:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;&lt;/select&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;distance&quot;</span><span class="nt">&gt;</span>Distance will appear here<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.common.Empty</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml.ajaxSelect</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmd</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.SetHtml</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">class</span> <span class="nc">HtmlSelectSnippet</span> <span class="o">{</span>

  <span class="c1">// Our &quot;database&quot; maps planet names to distances:</span>
  <span class="k">type</span> <span class="kt">Planet</span> <span class="o">=</span> <span class="nc">String</span>
  <span class="k">type</span> <span class="kt">LightYears</span> <span class="o">=</span> <span class="nc">Double</span>

  <span class="k">val</span> <span class="n">database</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">Planet</span>,<span class="kt">LightYears</span><span class="o">](</span>
    <span class="s">&quot;Alpha Centauri Bb&quot;</span> <span class="o">-&gt;</span> <span class="mf">4.23</span><span class="o">,</span>
    <span class="s">&quot;Tau Ceti e&quot;</span> <span class="o">-&gt;</span> <span class="mf">11.90</span><span class="o">,</span>
    <span class="s">&quot;Tau Ceti f&quot;</span> <span class="o">-&gt;</span> <span class="mf">11.90</span><span class="o">,</span>
    <span class="s">&quot;Gliese 876 d&quot;</span> <span class="o">-&gt;</span> <span class="mf">15.00</span><span class="o">,</span>
    <span class="s">&quot;82 G Eridani b&quot;</span> <span class="o">-&gt;</span> <span class="mf">19.71</span>
  <span class="o">)</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="c1">// To show the user a blank label and blank value option:</span>
    <span class="k">val</span> <span class="n">blankOption</span> <span class="k">=</span> <span class="o">(</span><span class="s">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;&quot;</span><span class="o">)</span>

    <span class="c1">// The complete list of options includes everything in our database:</span>
    <span class="k">val</span> <span class="n">options</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>,<span class="kt">String</span><span class="o">)]</span> <span class="k">=</span>
      <span class="n">blankOption</span> <span class="o">::</span>
      <span class="n">database</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">p</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">p</span><span class="o">,</span><span class="n">p</span><span class="o">)).</span><span class="n">toList</span>

    <span class="c1">// Nothing is selected by default:</span>
    <span class="k">val</span> <span class="n">default</span> <span class="k">=</span> <span class="nc">Empty</span>

    <span class="c1">// The function to call when an option is picked:</span>
    <span class="k">def</span> <span class="n">handler</span><span class="o">(</span><span class="n">selected</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="o">{</span>
      <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;distance&quot;</span><span class="o">,</span> <span class="nc">Text</span><span class="o">(</span><span class="n">database</span><span class="o">(</span><span class="n">selected</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot; light years&quot;</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="c1">// Bind the &lt;select&gt; tag:</span>
    <span class="s">&quot;select&quot;</span> <span class="o">#&gt;</span> <span class="n">ajaxSelect</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">default</span><span class="o">,</span> <span class="n">handler</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The last line of the code is doing the work for us.  It is generating the options and binding
the selection to a function called <span class="monospaced">handler</span>.  The handler function is called with the value
of the selected item.</p></div>
<div class="paragraph"><p>We&#8217;re using the same <span class="monospaced">String</span> (the planet name) for the option label and value, but they could be
different.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_35">Discussion</h4>
<div class="paragraph"><p>To understand what&#8217;s going on here, take a look at the HTML that Lift produces:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;dropdown&quot;</span>
  <span class="na">onchange=</span><span class="s">&quot;liftAjax.lift_ajaxHandler(&#39;F470183993611Y15ZJU=&#39; +</span>
<span class="s">    this.options[this.selectedIndex].value, null, null, null)&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;&lt;/option&gt;</span>
  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;Tau Ceti e&quot;</span><span class="nt">&gt;</span>Tau Ceti e<span class="nt">&lt;/option&gt;</span>
  ...
<span class="nt">&lt;/select&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">handler</span> function has been stored by Lift under the identifier of "F470183993611Y15ZJU" (in this particular rendering). An "onchange" event handler is attached to the select and the function is passed the value of the selected option. The <span class="monospaced">lift_ajaxHandler</span> JavaScript function is defined in <span class="monospaced">liftAjax.js</span> which is automatically added to your page.</p></div>
<div class="sect4">
<h5 id="_collecting_the_value_on_form_submission">Collecting the Value on Form Submission</h5>
<div class="paragraph"><p>If you need to additionally capture the selected value on a regular form submission, you can make use of <span class="monospaced">SHtml.onEvents</span>.  This attaches event listeners to a <span class="monospaced">NodeSeq</span>, triggering a server-side function when the event occurs.  We can use this with a regular form with a regular select box, but wire in Ajax calls to the server when the select changes.</p></div>
<div class="paragraph"><p>To make use of this, our snippet changes very little:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">var</span> <span class="n">selectedValue</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

<span class="s">&quot;select&quot;</span> <span class="o">#&gt;</span> <span class="n">onEvents</span><span class="o">(</span><span class="s">&quot;onchange&quot;</span><span class="o">)(</span><span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">select</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">default</span><span class="o">,</span> <span class="n">selectedValue</span> <span class="k">=</span> <span class="k">_</span><span class="o">)</span>
<span class="o">}</span> <span class="o">&amp;</span>
<span class="s">&quot;type=submit&quot;</span> <span class="o">#&gt;</span> <span class="n">onSubmitUnit</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Destination &quot;</span><span class="o">+</span><span class="n">selectedValue</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>We are arranging for the same <span class="monospaced">handler</span> function to be called when an "onchange" event is triggered.  This event binding is applied to a regular <span class="monospaced">SHtml.select</span>, which is storing the <span class="monospaced">selectedValue</span> when the form is submitted. We also bind a submit button to a function which generates a notice of which planet was selected.</p></div>
<div class="paragraph"><p>The corresponding HTML also changes little.  We need to add a button and make sure the form is marked as such:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;HtmlSelectFormSnippet?form=post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>Planet:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;&lt;/select&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;distance&quot;</span><span class="nt">&gt;</span>Distance will appear here<span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Book Ticket&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Now when you change a selected value you see the dynamically updated distance calculation, but pressing the "Book Ticket" button also delivers the value to the server.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_34">See Also</h4>
<div class="paragraph"><p><a href="#MultiSelectBox">[MultiSelectBox]</a> describes how to use classes rather than <span class="monospaced">String</span> values for select boxes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ClientSideOnlyActions">Creating Client-Side Actions from your Scala Code</h3>
<div class="sect3">
<h4 id="_problem_35">Problem</h4>
<div class="paragraph"><p>In your Lift code you want to set up a action that is run purely in
client-side JavaScript.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_35">Solution</h4>
<div class="paragraph"><p>Bind your JavaScript directly to the event handler you want to run.</p></div>
<div class="paragraph"><p>Here&#8217;s an example where we make a button slowly fade away when you press it, but notice
that we&#8217;re setting up this binding in our server-side Lift code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="k">object</span> <span class="nc">ClientSide</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;$(this).fadeOut()&quot;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In the template we&#8217;d perhaps say:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;ClientSide&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Lift will render the page as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;$(this).fadeOut()&quot;</span><span class="nt">&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_36">Discussion</h4>
<div class="paragraph"><p>Lift includes a JavaScript abstraction which you can use to build up
more elaborate expressions for the client-side. For example you can
combine basic commands&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.</span><span class="o">{</span><span class="nc">Alert</span><span class="o">,</span> <span class="nc">RedirectTo</span><span class="o">}</span>

<span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span>
  <span class="o">(</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Here we go...&quot;</span><span class="o">)</span> <span class="o">&amp;</span> <span class="nc">RedirectTo</span><span class="o">(</span><span class="s">&quot;http://liftweb.net&quot;</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;which pops up an alert dialog and then sends you to <em>http://liftweb.net</em>. The HTML would be rendered as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;alert(&amp;quot;Here we go...&amp;quot;);</span>
<span class="s">window.location = &amp;quot;http://liftweb.net&amp;quot;;&quot;</span><span class="nt">&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Another option is to use <span class="monospaced">JE.Call</span> to execute a JavaScript function with
parameters. Suppose we have this function defined:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">greet</span><span class="p">(</span><span class="nx">who</span><span class="p">,</span> <span class="nx">times</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">times</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hello &quot;</span><span class="o">+</span><span class="nx">who</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We could bind a client-side button press to this client-side function
like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JE</span>

<span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
  <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="nc">JE</span><span class="o">.</span><span class="nc">Call</span><span class="o">(</span><span class="s">&quot;greet&quot;</span><span class="o">,</span> <span class="s">&quot;World!&quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>On the client-side, we&#8217;d see:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;greet(&amp;quot;World!&amp;quot;,3)&quot;</span><span class="nt">&gt;</span>Click Me For Greeting<span class="nt">&lt;/button&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that the types <span class="monospaced">String</span> and <span class="monospaced">Int</span> have been preserved in the JavaScript syntax of the call. This has happened because <span class="monospaced">JE.Call</span> takes a variable number of <span class="monospaced">JsExp</span> arguments after the JavaScript function name. There are wrappers for JavaScript primitive types (<span class="monospaced">JE.Str</span>, <span class="monospaced">JE.Num</span>, <span class="monospaced">JsTrue</span>, <span class="monospaced">JsFalse</span>) and implicit conversions to save you having to wrap the Scala values yourself.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_35">See Also</h4>
<div class="paragraph"><p>Chapter 10 of <em>Exploring Lift</em> at <a href="http://exploring.liftweb.net/">http://exploring.liftweb.net/</a> gives a list of <span class="monospaced">JsCmds</span> and <span class="monospaced">JE</span> expressions.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FocusOnLoad">Focus on a Field on Page Load</h3>
<div class="sect3">
<h4 id="_problem_36">Problem</h4>
<div class="paragraph"><p>When a page loads you want the browser to select a particular field for
input focus from the user&#8217;s keyboard.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_36">Solution</h4>
<div class="paragraph"><p>Wrap the input with a <span class="monospaced">FocusOnLoad</span> command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.FocusOnLoad</span>

<span class="k">class</span> <span class="nc">Focus</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;name=username&quot;</span> <span class="o">#&gt;</span> <span class="nc">FocusOnLoad</span><span class="o">(&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="o">/&gt;)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The CSS transform in <span class="monospaced">render</span> will match against <span class="monospaced">name="username"</span> element in the HTML and
replace it with a text input field that will be focused on automatically
when the page loads.</p></div>
<div class="paragraph"><p>Although we&#8217;re focusing on in-line HTML, this could be any <span class="monospaced">NodeSeq</span>, such as the one produced by <span class="monospaced">SHtml.text</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_37">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">FocusOnLoad</span> is an example of a <span class="monospaced">NodeSeq =&gt; NodeSeq</span> transformation. It appends to the <span class="monospaced">NodeSeq</span> with the
JavaScript required to set focus on that field.</p></div>
<div class="paragraph"><p>The JavaScript that performs the focus simply looks up the node in the DOM by ID and calls <span class="monospaced">focus</span> on it. Although the example code above doesn&#8217;t specify an ID, the <span class="monospaced">FocusOn</span> command is smart enough to add one automatically for us.</p></div>
<div class="paragraph"><p>There are two related <span class="monospaced">JsCmd</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">Focus</span>&#8201;&#8212;&#8201;takes an element ID and sets focus on the element.
</p>
</li>
<li>
<p>
<span class="monospaced">SetValueAndFocus</span>&#8201;&#8212;&#8201;which is like <span class="monospaced">Focus</span> but takes an additional
<span class="monospaced">String</span> value to populate the element with.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These two are useful if you need to set focus from Ajax or Comet
components dynamically.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_36">See Also</h4>
<div class="paragraph"><p>The source for <span class="monospaced">FocusOnLoad</span> is worth checking out to understand how it, and related commands, are constructed.  This may help you package your own JavaScript functionality up into commands that can be used in CSS binding expressions: <a href="https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/js/JsCommands.scala">https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/js/JsCommands.scala</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CSSClassOnAjaxForm">Add CSS Class to an Ajax Form</h3>
<div class="sect3">
<h4 id="_problem_37">Problem</h4>
<div class="paragraph"><p>You want to set the CSS class of an AJAX form.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_37">Solution</h4>
<div class="paragraph"><p>Name the class via <span class="monospaced">?class=</span> query parameter:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;form.ajax?class=boxed&quot;</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_38">Discussion</h4>
<div class="paragraph"><p>If you need to set multiple CSS classes, encode a space between the
class names, e.g., <span class="monospaced">class=boxed+primary</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">form.ajax</span> construction is a regular snippet call: the <span class="monospaced">Form</span> snippet is one of the handful of built-in snippets, and in this case we&#8217;re calling the <span class="monospaced">ajax</span> method on that object.  However, normally snippet calls do not copy attributes into the resulting markup, but this snippet is implemented to do exactly that.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_37">See Also</h4>
<div class="paragraph"><p>For an example of accessing these query parameters in your own snippets, see <a href="#ConditionalIncludes">[ConditionalIncludes]</a>.</p></div>
<div class="paragraph"><p><em>Simply Lift</em>, chapter 4, introduces Ajax forms at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DynamicTemplateLoading">Running a Template via JavaScript</h3>
<div class="sect3">
<h4 id="_problem_38">Problem</h4>
<div class="paragraph"><p>You want to load an entire page, with template and snippets executed, inside of the current page (i.e., without a browser refresh).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_38">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">Template</span> to load the template, and <span class="monospaced">SetHtml</span> to place the content
on the page.</p></div>
<div class="paragraph"><p>Let&#8217;s populate a <span class="monospaced">&lt;div&gt;</span> with the site home page when a button is pressed:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;TemplateLoad&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;inject&quot;</span><span class="nt">&gt;</span>Content will appear here<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button&gt;</span>Load Template<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The corresponding snippet would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">SHtml</span><span class="o">,</span> <span class="nc">Templates</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.</span><span class="o">{</span><span class="nc">SetHtml</span><span class="o">,</span> <span class="nc">Noop</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmd</span>

<span class="k">object</span> <span class="nc">TemplateLoad</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">content</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span>
    <span class="nc">Templates</span><span class="o">(</span><span class="s">&quot;index&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">ns</span> <span class="k">=&gt;</span> <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;inject&quot;</span><span class="o">,</span> <span class="n">ns</span><span class="o">))</span> <span class="n">openOr</span> <span class="nc">Noop</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxInvoke</span><span class="o">(</span><span class="n">content</span> <span class="k">_</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Clicking the button will cause the content of <span class="monospaced">/index.html</span> to be
loaded into the <span class="monospaced">inject</span> element.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_39">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">Templates</span> produces a <span class="monospaced">Box[NodeSeq]</span>.  In the example above, we map this content into a <span class="monospaced">JsCmd</span> which will populate the <span class="monospaced">inject</span> div.</p></div>
<div class="paragraph"><p>If you write unit tests to access templates, be aware that you may need to modify your development or testing environment to include the <span class="monospaced">webapps</span> folder.  To do this for SBT, add the following to <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">unmanagedResourceDirectories</span> <span class="n">in</span> <span class="nc">Test</span> <span class="o">&lt;+=</span> <span class="o">(</span><span class="n">baseDirectory</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span> <span class="o">/</span> <span class="s">&quot;src/main/webapp&quot;</span> <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>For your IDE you&#8217;ll need to add <span class="monospaced">webapp</span> as a source folder, if your running tests that try to locate templates.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_38">See Also</h4>
<div class="paragraph"><p><a href="#ButtonTriggerServerCode">[ButtonTriggerServerCode]</a> describes <span class="monospaced">ajaxInvoke</span> and related methods.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="JavaScriptTail">Move JavaScript to End of Page</h3>
<div class="sect3">
<h4 id="_problem_39">Problem</h4>
<div class="paragraph"><p>You want the JavaScript created in your snippet to be included at the end of the HTML page.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_39">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">S.appendJs</span> which places your JavaScript just before the closing <span class="monospaced">&lt;/body&gt;</span> tag, along with other JavaScript produced by Lift.</p></div>
<div class="paragraph"><p>In this HTML we have placed a <span class="monospaced">&lt;script&gt;</span> tag in the middle of the page, and marked it with a snippet called <span class="monospaced">JavascriptTail</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="na">http-equiv=</span><span class="s">&quot;content-type&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>JavaScript in Tail<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>Javascript in the tail of the page<span class="nt">&lt;/h2&gt;</span>

  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;JavascriptTail&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/script&gt;</span>

  <span class="nt">&lt;p&gt;</span>
    The JavaScript about to be run will have been moved
    to the end of this page, just before the closing
    body tag.
  <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">&lt;script&gt;</span> content will be generated by a snippet.
It doesn&#8217;t need to be a <span class="monospaced">&lt;script&gt;</span> tag: the snippet just replaces the content with nothing, but
hanging the snippet on the <span class="monospaced">&lt;script&gt;</span> tag is a reminder of the purpose of the snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Alert</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">xml.NodeSeq</span>

<span class="k">class</span> <span class="nc">JavascriptTail</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">S</span><span class="o">.</span><span class="n">appendJs</span><span class="o">(</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Hi&quot;</span><span class="o">))</span>
    <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">NodeSeq</span><span class="o">.</span><span class="nc">Empty</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Although the snippet is rendering nothing, it calls <span class="monospaced">S.appendJs</span> with a <span class="monospaced">JsCmd</span>.  This will produce the following in the page just before the end of the body:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="c1">// &lt;![CDATA[</span>
<span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hi&quot;</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// ]]&gt;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Although the snippet was in the middle of the page, the JavaScript appears at the
end of the page.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_40">Discussion</h4>
<div class="paragraph"><p>There are three other ways you could tackle this problem.  The first is to move your JavaScript to an external file, and simply include it on the page where you want it.  For substantial JavaScript code, this might make sense.</p></div>
<div class="paragraph"><p>The second is a variation on <span class="monospaced">S.appendJs</span>: <span class="monospaced">S.appendGlobalJs</span> works in the same way but does not include the jQuery <span class="monospaced">ready</span> around your JavaScript.  This means you have no guarantee the DOM has loaded when your function is called.</p></div>
<div class="paragraph"><p>A third option is wrap your JavaScript in a <span class="monospaced">&lt;lift:tail&gt;</span> snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">JavascriptTail</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="o">&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">tail&gt;</span><span class="o">{</span><span class="kt">Script</span><span class="o">(</span><span class="kt">OnLoad</span><span class="o">(</span><span class="kt">Alert</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">Hi</span><span class="err">&quot;</span><span class="o">)))}</span><span class="kt">&lt;/lift:tail&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that <span class="monospaced">lift:tail</span> is a general-purpose Lift snippet and be used to move various kinds of content to the end of the page, not just JavaScript.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_39">See Also</h4>
<div class="paragraph"><p><a href="#AddToHead">[AddToHead]</a> discusses a related Lift snippet for moving content to the head of the page.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CometSessionLossJS">Run JavaScript on Comet Session Loss</h3>
<div class="sect3">
<h4 id="_problem_40">Problem</h4>
<div class="paragraph"><p>You&#8217;re using a comet actor and you want to arrange for some JavaScript to be executed in the event of the session being lost.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_40">Solution</h4>
<div class="paragraph"><p>Configure your JavaScript via <span class="monospaced">LiftRules.noCometSessionCmd</span>.</p></div>
<div class="paragraph"><p>As an example we can modify the standard Lift chat demo to save the message being typed in the event of the session loss.  In the style of the demo we would have a Ajax form for entering a message and the comet chat area for displaying messages received:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;form.ajax&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;ChatSnippet&quot;</span> <span class="na">id=</span><span class="s">&quot;message&quot;</span>
    <span class="na">placeholder=</span><span class="s">&quot;Type a message&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;comet?type=ChatClient&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>A message<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>To this we can add a function, <span class="monospaced">stash</span>, which we want to be called in the event of a comet session being lost:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="c1">// &lt;![CDATA[</span>
<span class="kd">function</span> <span class="nx">stash</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">saveCookie</span><span class="p">(</span><span class="s2">&quot;stashed&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#message&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
  <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">stashedValue</span> <span class="o">=</span> <span class="nx">readCookie</span><span class="p">(</span><span class="s2">&quot;stashed&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#message&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">stashedValue</span><span class="p">);</span>
  <span class="nx">deleteCookie</span><span class="p">(</span><span class="s2">&quot;stashed&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Definition of saveCookie, readCookie, deleteCookie omitted.</span>

<span class="nt">&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Our <span class="monospaced">stash</span> function will save the current value of the input field in a cookie called "stashed".  We arrange, on page load, to check for that cookie and insert the value into our message field.</p></div>
<div class="paragraph"><p>The final part is to modify <span class="monospaced">Boot.scala</span> to register our <span class="monospaced">stash</span> function:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Run</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">noCometSessionCmd</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Run</span><span class="o">(</span><span class="s">&quot;stash()&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In this way, if a session is lost while composing a chat message, the browser will stash the message, and when the page re-loads the message will be recovered.</p></div>
<div class="paragraph"><p>To test the example, type a message into the message field, then restart your Lift application.  Wait 10 seconds, and you&#8217;ll see the effect.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_41">Discussion</h4>
<div class="paragraph"><p>Without changing <span class="monospaced">noCometSessionCmd</span>, the default behavior of Lift is to arrange for the browser to load the page <span class="monospaced">LiftRules.noCometSessionPage</span>&#8201;&#8212;&#8201;which will be <span class="monospaced">/</span> unless you change it.  This is carried out via the JavaScript function <span class="monospaced">lift_sessionLost</span> in <span class="monospaced">cometAjax.js</span>.</p></div>
<div class="paragraph"><p>By providing our own <span class="monospaced">() =&gt; JsCmd</span> function to <span class="monospaced">LiftRules.noCometSessionCmd</span>, Lift arranges to call this function and deliver the <span class="monospaced">JsCmd</span>  to the browser, rather than <span class="monospaced">lift_sessionLost</span>.  If you watch the HTTP traffic between your browser and Lift, you&#8217;ll see the <span class="monospaced">stash</span> function call being returned in response to a comet request.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Factory</div>
<div class="paragraph"><p>The <span class="monospaced">noCometSessionCmd.default.set</span> call is making use of Lift&#8217;s dependency injection. Specifically, it&#8217;s setting up the "supply side" of the dependency. Although we&#8217;re setting a default here, it&#8217;s possible in Lift to supply different behaviours with different scopes: request or session.  See <a href="https://www.assembla.com/spaces/liftweb/wiki/Dependency_Injection">https://www.assembla.com/spaces/liftweb/wiki/Dependency_Injection</a>.</p></div>
</div></div>
<div class="paragraph"><p>This recipe has focused on the handling of loss of session for Comet, and for Ajax, there&#8217;s a corresponding <span class="monospaced">LiftRules.noAjaxSessionCmd</span> setting.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_40">See Also</h4>
<div class="paragraph"><p>You&#8217;ll find the <em>The ubiquitous Chat app</em> in <em>Simply Lift</em>: <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
<div class="paragraph"><p>Being able to debug HTTP traffic is a useful way to understand how your Comet or Ajax application is performing.  There are many plugins and products to help with this, such as the <em>HttpFox</em> plugin for Firefox: <a href="https://addons.mozilla.org/en-us/firefox/addon/httpfox/">https://addons.mozilla.org/en-us/firefox/addon/httpfox/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AjaxFileUpload">Ajax File Upload</h3>
<div class="sect3">
<h4 id="_problem_41">Problem</h4>
<div class="paragraph"><p>You want to offer your users an Ajax file upload tool, with progress bars and drag and drop support.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_41">Solution</h4>
<div class="paragraph"><p>Add Sebastian Tschan&#8217;s <em>jQuery File Upload</em> widget (<a href="https://github.com/blueimp/jQuery-File-Upload">https://github.com/blueimp/jQuery-File-Upload</a>) to your project, and implement a REST end point to receive files.</p></div>
<div class="paragraph"><p>The first step is to download the widget, and drag the <span class="monospaced">js</span> folder into your application as <span class="monospaced">src/main/webapp/js</span>.  We can then use the JavaScript in a template:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>jQuery File Upload Example<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;h1&gt;</span>Drag files onto this page<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;fileupload&quot;</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;files[]&quot;</span> <span class="na">data-url=</span><span class="s">&quot;/upload&quot;</span> <span class="na">multiple</span><span class="nt">&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;progress&quot;</span> <span class="na">style=</span><span class="s">&quot;width:20em; border: 1pt solid silver; display: none&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;progress-bar&quot;</span> <span class="na">style=</span><span class="s">&quot;background: green; height: 1em; width:0%&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/vendor/jquery.ui.widget.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/jquery.iframe-transport.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/jquery.fileupload.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#fileupload&#39;</span><span class="p">).</span><span class="nx">fileupload</span><span class="p">({</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
      <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress-bar&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;0%&#39;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">progressall</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">progress</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">data</span><span class="p">.</span><span class="nx">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress-bar&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">progress</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">files</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;p/&gt;&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>This template provides an input field for files, an area to use as a progress indicator, and configures the widget when the page loads in a JQuery <span class="monospaced">$( ... )</span> block.</p></div>
<div class="paragraph"><p>The final part is to implement a Lift REST service to receive the file or files.  The URL of the service, <span class="monospaced">/upload</span>, is set in <span class="monospaced">data-url</span> on the <span class="monospaced">input</span> field, and that&#8217;s the address we match on:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.OkResponse</span>

<span class="k">object</span> <span class="nc">AjaxFileUpload</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="n">serve</span> <span class="o">{</span>

    <span class="k">case</span> <span class="s">&quot;upload&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Post</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">file</span> <span class="k">&lt;-</span> <span class="n">req</span><span class="o">.</span><span class="n">uploadedFiles</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&quot;Received: &quot;</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="n">fileName</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="nc">OkResponse</span><span class="o">()</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This implementation simply logs the name of the file received and acknowledges successful delivery with a 200 status code back to the widget.</p></div>
<div class="paragraph"><p>As with all REST services, it needs to be registered in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="nc">AjaxFileUpload</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>By default the widget makes the whole HTML page a drop-target for files, meaning you can drag a file onto the page and it will immediately be uploaded to your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_42">Discussion</h4>
<div class="paragraph"><p>In this recipe we&#8217;ve shown just the basic integration of the widget with a Lift application.  The demo site for the widget, <a href="http://blueimp.github.com/jQuery-File-Upload/">http://blueimp.github.com/jQuery-File-Upload/</a>, shows other capabilities, and provides documentation on how to integrate them.</p></div>
<div class="paragraph"><p>May of the features just require JavaScript configuration.  For example, we&#8217;ve used the widget&#8217;s <span class="monospaced">add</span>, <span class="monospaced">progressall</span>, and <span class="monospaced">done</span> handlers to show, update and then fade out a progress bar.  When the upload is completed, the name of the uploaded file is appended to the page.</p></div>
<div class="paragraph"><p>In the REST service the uploaded file are available via the <span class="monospaced">uploadedFiles</span> method on the request. When Lift receives a multi-part form it automatically extracts files as <span class="monospaced">uploadedFiles</span>, each of which is a <span class="monospaced">FileParamHolder</span> which gives us access to the <span class="monospaced">fileName</span>, <span class="monospaced">length</span>, <span class="monospaced">mimeType</span> and <span class="monospaced">fileStream</span>.</p></div>
<div class="paragraph"><p>By default uploaded files are held in memory, but that can be changed (see <a href="#UploadToDisk">[UploadToDisk]</a> in <a href="#FileUpload">[FileUpload]</a>).</p></div>
<div class="paragraph"><p>In the recipe we return a 200 (<span class="monospaced">OkResponse</span>).  If we wanted to signal to the widget that a file was rejected we can return another code. For example, perhaps we want to reject all files except PNG images.  On the server-side we can do that by replacing the <span class="monospaced">OkResponse</span> with a test:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">ResponseWithReason</span><span class="o">,</span> <span class="nc">BadResponse</span><span class="o">,</span> <span class="nc">OkResponse</span><span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">uploadedFiles</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">mimeType</span> <span class="o">!=</span> <span class="s">&quot;image/png&quot;</span> <span class="o">))</span>
  <span class="nc">ResponseWithReason</span><span class="o">(</span><span class="nc">BadResponse</span><span class="o">(),</span> <span class="s">&quot;Only PNGs&quot;</span><span class="o">)</span>
<span class="k">else</span>
  <span class="nc">OkResponse</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>We would mirror this with a <span class="monospaced">fail</span> handler in the client JavaScript:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nx">fail</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">errorThrown</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>If we uploaded, say a JPEG, the browser would show an alert dialog reporting "Only PNGs".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_41">See Also</h4>
<div class="paragraph"><p>Diego Medina has posted a Gist of Lift REST code to integrate more fully with the image upload and image reviewing features of the widget, specifically implementing the JSON response that the widget expects for that functionality.  You&#8217;ll find it at: <a href="https://gist.github.com/a6715d1e3664f73cd03a">https://gist.github.com/a6715d1e3664f73cd03a</a>.</p></div>
<div class="paragraph"><p><a href="#FileUpload">[FileUpload]</a> describes the basic file upload behaviour of Lift and how to control where files are stored.</p></div>
<div class="paragraph"><p>Antonio Salazar Cardozo has posted example code for performing Ajax file upload using Lift&#8217;s Ajax mechanisms, which avoids external JavaScript libraries. You can find a description and link to the code at: <a href="https://groups.google.com/d/msg/liftweb/OuN1sqRMO_c/TrUGUaSvoN4J">https://groups.google.com/d/msg/liftweb/OuN1sqRMO_c/TrUGUaSvoN4J</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Pipeline">Request Pipeline</h2>
<div class="sectionbody">
<div class="paragraph"><p>When a request reaches Lift there are a number of points where you can jump in an control what Lift does, or send back a different kind of response, or control access.  This chapter looks at the pipeline through examples of different kinds of <span class="monospaced">LiftResponse</span> and configurations.</p></div>
<div class="paragraph"><p>You can get a great overview of the pipeline, including diagrams, from the Lift pipeline Wiki page at
<a href="http://www.assembla.com/spaces/liftweb/wiki/HTTP_Pipeline">http://www.assembla.com/spaces/liftweb/wiki/HTTP_Pipeline</a>.</p></div>
<div class="paragraph"><p>See <a href="https://github.com/LiftCookbook/cookbook_pipeline">https://github.com/LiftCookbook/cookbook_pipeline</a> for the source code that accompanies this chapter.</p></div>
<div class="sect2">
<h3 id="DebugRequest">Debugging a Request</h3>
<div class="sect3">
<h4 id="_problem_42">Problem</h4>
<div class="paragraph"><p>You want to debug a request and see what&#8217;s arriving to your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_42">Solution</h4>
<div class="paragraph"><p>Add an <span class="monospaced">onBeginServicing</span> function in <span class="monospaced">Boot.scala</span> to log the request.
For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">onBeginServicing</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">r</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Received: &quot;</span><span class="o">+</span><span class="n">r</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_43">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">onBeginServicing</span> call is called quite early in the Lift pipeline, before
<span class="monospaced">S</span> is set up, and before Lift has the chance to 404 your request.  The function signature it expects is <span class="monospaced">Req =&gt; Unit</span>.
We&#8217;re just logging, but the functions could be used for other purposes.</p></div>
<div class="paragraph"><p>If you want to select only certain paths, you can. For example, to track
all requests starting <em>/paypal</em>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">onBeginServicing</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">r</span> <span class="k">@</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;paypal&quot;</span> <span class="o">::</span> <span class="k">_</span><span class="o">),</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This pattern will match any request starting <em>/paypal</em>, and we&#8217;re ignoring the suffix on the request if any, and the type of request (e.g., GET, POST or so on).</p></div>
<div class="paragraph"><p>There&#8217;s also <span class="monospaced">LiftRules.early</span> which is called before <span class="monospaced">onBeginServicing</span>.  It expects a <span class="monospaced">HTTPRequest =&gt; Unit</span> function, so is a little lower-level than the <span class="monospaced">Req</span> used in <span class="monospaced">onBeginServicing</span>.  However, it will be called by all requests that pass through Lift. For example, you could mark a request as something that the container should handle by itself:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">liftRequest</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;robots&quot;</span> <span class="o">::</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">false</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Which this in place a request for <em>robots.txt</em> will be logged by <span class="monospaced">LiftRules.early</span> but won&#8217;t make it to any of the other methods described in this recipe.</p></div>
<div class="paragraph"><p>If you need access to state (e.g., <span class="monospaced">S</span>), use <span class="monospaced">earlyInStateful</span>, which is based on a <span class="monospaced">Box[Req]</span> not a <span class="monospaced">Req</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">earlyInStateful</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// access S here</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>It&#8217;s possible for your <span class="monospaced">earlyInStateful</span> function to be called twice. This will happen when a new session is being set up.  You can prevent this by only matching on requests in a running Lift session:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">earlyInStateful</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="k">if</span> <span class="nc">LiftRules</span><span class="o">.</span><span class="n">getLiftSession</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="n">running_?</span> <span class="k">=&gt;</span> <span class="c1">// access S here</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally, there&#8217;s also <span class="monospaced">earlyInStateless</span> which like <span class="monospaced">earlyInStateful</span> works on a <span class="monospaced">Box[Req]</span> but in other respects is the same as <span class="monospaced">onBeginServicing</span>. It is triggered after <span class="monospaced">early</span> and before <span class="monospaced">earlyInStateful</span>.</p></div>
<div class="paragraph"><p>As a summary, the functions described in this recipe are called in this order:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">LiftRules.early</span>
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.onBeginServicing</span>
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.earlyInStateless</span>
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.earlyInStateful</span>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_42">See Also</h4>
<div class="paragraph"><p>If you need to catch the end of a request, there is also an <span class="monospaced">onEndServicing</span> which can be given functions of type
<span class="monospaced">(Req, Box[LiftResponse]) =&gt; Unit</span>.</p></div>
<div class="paragraph"><p><a href="#RunningStateless">[RunningStateless]</a> describe show to force requests to be stateless.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="OnSession">Running Code when Sessions are Created (or Destroyed)</h3>
<div class="sect3">
<h4 id="_problem_43">Problem</h4>
<div class="paragraph"><p>You want to carry out actions when a session is created or destroyed.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_43">Solution</h4>
<div class="paragraph"><p>Make use of the hooks in <span class="monospaced">LiftSession</span>. For example, in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftSession</span><span class="o">.</span><span class="n">afterSessionCreate</span> <span class="o">::=</span>
 <span class="o">(</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span><span class="kt">LiftSession</span><span class="o">,</span> <span class="n">r</span><span class="k">:</span><span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Session created&quot;</span><span class="o">)</span> <span class="o">)</span>

<span class="nc">LiftSession</span><span class="o">.</span><span class="n">onBeginServicing</span> <span class="o">::=</span>
 <span class="o">(</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span><span class="kt">LiftSession</span><span class="o">,</span> <span class="n">r</span><span class="k">:</span><span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Processing request&quot;</span><span class="o">)</span> <span class="o">)</span>

<span class="nc">LiftSession</span><span class="o">.</span><span class="n">onShutdownSession</span> <span class="o">::=</span>
 <span class="o">(</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span><span class="kt">LiftSession</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Session going away&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>If the request path has been marked as being stateless via
<span class="monospaced">LiftRules.statelessReqTest</span>, the above example would only execute the
<span class="monospaced">onBeginServicing</span> functions.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_44">Discussion</h4>
<div class="paragraph"><p>The hooks in <span class="monospaced">LiftSession</span> allow you to insert code at various points in
the session lifecycle: when the session is created, at the start of
servicing the request, after servicing, when the session is about to
shutdown, at shutdown&#8230; the pipeline diagrams mentioned at the start of this chapter
are a useful guide to these stages.</p></div>
<div class="paragraph"><p>Note that the Lift session is not the same as the HTTP Session. Lift bridges from the HTTP session to it&#8217;s own session management.  This is described in some detail in <em>Exploring Lift</em> (see <em>See Also</em>).</p></div>
<div class="paragraph"><p>The full list of session hooks is:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">onSetupSession</span>&#8201;&#8212;&#8201;this will be the first hook called when a session is created.
</p>
</li>
<li>
<p>
<span class="monospaced">afterSessionCreate</span>&#8201;&#8212;&#8201;called after all <span class="monospaced">onSetupSession</span> functions have been called.
</p>
</li>
<li>
<p>
<span class="monospaced">onBeginServicing</span>&#8201;&#8212;&#8201;at the start of the request processing.
</p>
</li>
<li>
<p>
<span class="monospaced">onEndServicing</span>&#8201;&#8212;&#8201;and the end of request processing.
</p>
</li>
<li>
<p>
<span class="monospaced">onAboutToShutdownSession</span>&#8201;&#8212;&#8201;called just before a session is shutdown, for example when a session expires or the Lift application is being shutdown.
</p>
</li>
<li>
<p>
<span class="monospaced">onShutdownSession</span>&#8201;&#8212;&#8201;called after all <span class="monospaced">onAboutToShutdownSession</span> functions have been run.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you are testing testing these hooks, you might want to make session expire faster than the 30 minutes of inactivity used by default in Lift.  To do this, supply a millisecond value to <span class="monospaced">LiftRules.sessionInactivityTimeout</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// 30 second inactivity timeout</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">sessionInactivityTimeout</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="mi">1000L</span> <span class="o">*</span> <span class="mi">30</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>There are two other hooks in <span class="monospaced">LiftSession</span>: <span class="monospaced">onSessionActivate</span> and <span class="monospaced">onSessionPassivate</span>. These may be of use if you are working with a servlet container in distributed mode, and want to be notified when the servlet HTTP session is about to be serialized (passivated) and de-serialized (activated) between container instances. These hooks are rarely used.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_43">See Also</h4>
<div class="paragraph"><p>Session management is discussed in section 9.5 of <em>Exploring Lift</em>: <a href="http://exploring.liftweb.net/">http://exploring.liftweb.net/</a>.</p></div>
<div class="paragraph"><p><a href="#RunningStateless">[RunningStateless]</a> shows how to run without state.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ShutdownHooks">Run Code when Lift Shuts Down</h3>
<div class="sect3">
<h4 id="_problem_44">Problem</h4>
<div class="paragraph"><p>You want to have some code executed when your Lift application is
shutting down.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_44">Solution</h4>
<div class="paragraph"><p>Append to <span class="monospaced">LiftRules.unloadHooks</span>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">unloadHooks</span><span class="o">.</span><span class="n">append</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Shutting down&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_45">Discussion</h4>
<div class="paragraph"><p>You append functions of type <span class="monospaced">() =&gt; Unit</span> to <span class="monospaced">unloadHooks</span>, and these functions are run
right at the end of the Lift handler, after sessions have been
destroyed, Lift actors have been shutdown, and requests have finished
being handled.</p></div>
<div class="paragraph"><p>This is triggered, in the words of the Java servlet
specification, "by the web container to indicate to a filter that it is
being taken out of service".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_44">See Also</h4>
<div class="paragraph"><p><a href="#RunTasksPeriodically">[RunTasksPeriodically]</a> includes an example of using a unload hook.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RunningStateless">Running Stateless</h3>
<div class="sect3">
<h4 id="_problem_45">Problem</h4>
<div class="paragraph"><p>You want to force your application to be stateless at the HTTP level.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_45">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">enableContainerSessions</span> <span class="k">=</span> <span class="kc">false</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessReqTest</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span> <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">true</span> <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>All requests will now be treated as stateless. Any attempt to use state,
such as via <span class="monospaced">SessionVar</span> for example, will trigger a warning in
developer mode: "Access to Lift&#8217;s statefull features from Stateless mode.
The operation on state will not complete."</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_46">Discussion</h4>
<div class="paragraph"><p>HTTP session creation is controlled via <span class="monospaced">enableContainerSessions</span>, and
applies for all requests. Leaving this value at the default (<span class="monospaced">true</span>)
allows more fine-grained control over which requests are stateless.</p></div>
<div class="paragraph"><p>Using <span class="monospaced">statelessReqTest</span> allows you to decide, based on the
<span class="monospaced">StatelessReqTest</span> case class, if a request should be stateless (<span class="monospaced">true</span>) or not (<span class="monospaced">false</span>).
For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">asset</span><span class="o">(</span><span class="n">file</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
  <span class="nc">List</span><span class="o">(</span><span class="s">&quot;.js&quot;</span><span class="o">,</span> <span class="s">&quot;.gif&quot;</span><span class="o">,</span> <span class="s">&quot;.css&quot;</span><span class="o">).</span><span class="n">exists</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="n">endsWith</span><span class="o">)</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessReqTest</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">StatelessReqTest</span><span class="o">(</span><span class="s">&quot;index&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="n">httpReq</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="k">case</span> <span class="nc">StatelessReqTest</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">file</span><span class="o">),</span>  <span class="k">_</span><span class="o">)</span> <span class="k">if</span> <span class="n">asset</span><span class="o">(</span><span class="n">file</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This example would only make the index page and any GIFs, JavaScript and
CSS files stateless. The <span class="monospaced">httpReq</span> part is a <span class="monospaced">HTTPRequest</span> instance,
allowing you to base the decision on the content of the request
(cookies, user agent, etc).</p></div>
<div class="paragraph"><p>Another option is <span class="monospaced">LiftRules.statelessDispatch</span> which allows you to
register a function which returns a <span class="monospaced">LiftResponse</span>. This will be
executed without a session, and convenient for REST-based services.</p></div>
<div class="paragraph"><p>If you just need to mark an entry in Sitemap as being stateless, you can:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;Stateless Page&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;demo&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">Stateless</span>
</pre></div></div></div>
<div class="paragraph"><p>A request for <em>/demo</em> would be processed without state.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_45">See Also</h4>
<div class="paragraph"><p><a href="#REST">[REST]</a> contains recipes for REST-based services in Lift.</p></div>
<div class="paragraph"><p>The Lift Wiki gives further details on the processing of stateless requests: <a href="http://www.assembla.com/wiki/show/liftweb/Stateless_Requests">http://www.assembla.com/wiki/show/liftweb/Stateless_Requests</a>.</p></div>
<div class="paragraph"><p>This stateless request control was introduced in Lift 2.2.  The announcement on the mailing list gives more details: <a href="https://groups.google.com/d/msg/liftweb/2rVMCnWppSo/KoaUMHeQAEAJ">https://groups.google.com/d/msg/liftweb/2rVMCnWppSo/KoaUMHeQAEAJ</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CatchException">Catch Any Exception</h3>
<div class="sect3">
<h4 id="_problem_46">Problem</h4>
<div class="paragraph"><p>You want a wrapper around all requests to catch exceptions and display
something to the user.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_46">Solution</h4>
<div class="paragraph"><p>Declare an exception handler in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">runMode</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Failed at: &quot;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="o">)</span>
    <span class="nc">InternalServerErrorResponse</span><span class="o">()</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In the above example, all exceptions for all requests at all run modes
are being matched, causing an error to be logged and a 500 (internal
server error) to be returned to the browser.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_47">Discussion</h4>
<div class="paragraph"><p>The partial function you add to <span class="monospaced">exceptionHandler</span> needs to return a
<span class="monospaced">LiftResponse</span> (i.e., something to send to the browser). The default
behaviour is to return an <span class="monospaced">XhtmlResponse</span>, which in
<span class="monospaced">Props.RunModes.Development</span> gives details of the exception, and in all
other run modes simply says: "Something unexpected happened".</p></div>
<div class="paragraph"><p>You can return any kind of <span class="monospaced">LiftResponse</span>, including <span class="monospaced">RedirectResponse</span>,
<span class="monospaced">JsonResponse</span>, <span class="monospaced">XmlResponse</span>, <span class="monospaced">JavaScriptResponse</span> and so on.</p></div>
<div class="paragraph"><p>The example above just sends a standard 500 error. That won&#8217;t be very helpful to your users.
An alternative is to render a custom message, but retain the 500 status code which will be
useful for external site monitoring services if you use them:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">runMode</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Failed at: &quot;</span><span class="o">+</span><span class="n">req</span><span class="o">.</span><span class="n">uri</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">content</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">render</span><span class="o">(&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">embed</span> <span class="kt">what</span><span class="o">=</span><span class="s">&quot;500&quot;</span> <span class="o">/&gt;,</span> <span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">)</span>
    <span class="nc">XmlResponse</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="n">head</span><span class="o">,</span> <span class="mi">500</span><span class="o">,</span> <span class="s">&quot;text/html&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">cookies</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Here we are sending back a response with a 500 status code, but the content is the
<span class="monospaced">Node</span> that results from running <span class="monospaced">src/main/webapp/template-hidden/500.html</span>.  Create that
file with the message you want to show to users:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>500<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Something is wrong!<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;p&gt;</span>It&#39;s our fault - sorry<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>You can also control what to send to clients when processing Ajax requests.  In the
following example, we&#8217;re matching just on Ajax POST requests, and returning
custom JavaScript to the browser:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds._</span>

<span class="k">val</span> <span class="n">ajax</span> <span class="k">=</span> <span class="nc">LiftRules</span><span class="o">.</span><span class="n">ajaxPath</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">mode</span><span class="o">,</span> <span class="nc">Req</span><span class="o">(</span><span class="n">ajax</span> <span class="o">::</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="nc">PostRequest</span><span class="o">),</span> <span class="n">ex</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Error handing ajax&quot;</span><span class="o">)</span>
    <span class="nc">JavaScriptResponse</span><span class="o">(</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Boom!&quot;</span><span class="o">))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>You could test out this handling code by creating an Ajax button that always produces
an exception:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>

<span class="k">class</span> <span class="nc">ThrowsException</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">def</span> <span class="n">fail</span> <span class="k">=</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="o">(</span><span class="s">&quot;not implemented&quot;</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxButton</span><span class="o">(</span><span class="s">&quot;Press Me&quot;</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">fail</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This Ajax example will jump in before Lift&#8217;s default behaviour for Ajax
errors. The default is to retry the Ajax command three times
(<span class="monospaced">LiftRules.ajaxRetryCount</span>), and then execute
<span class="monospaced">LiftRules.ajaxDefaultFailure</span>, which will pop up a dialog saying: "The
server cannot be contacted at this time"</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_46">See Also</h4>
<div class="paragraph"><p><a href="#Custom404">[Custom404]</a> for how to create a custom 404 (not found) page.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RestStreamContent">Streaming Content</h3>
<div class="sect3">
<h4 id="_problem_47">Problem</h4>
<div class="paragraph"><p>You want to stream content back to the web client.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_47">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">OutputStreamResponse</span>, passing it a function that will write to the
<span class="monospaced">OutputStream</span> that Lift supplies.</p></div>
<div class="paragraph"><p>In this example we&#8217;ll stream all the integers from one, via a REST service:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">Req</span><span class="o">,</span><span class="nc">OutputStreamResponse</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.rest._</span>

<span class="k">object</span> <span class="nc">Numbers</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="c1">// Convert a number to a String, and then to UTF-8 bytes</span>
  <span class="c1">// to send down the output stream.</span>
  <span class="k">def</span> <span class="n">num2bytes</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">)</span> <span class="n">getBytes</span><span class="o">(</span><span class="s">&quot;utf-8&quot;</span><span class="o">)</span>

  <span class="c1">// Generate numbers using a Scala stream:</span>
  <span class="k">def</span> <span class="n">infinite</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">num2bytes</span><span class="o">)</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;numbers&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="nc">OutputStreamResponse</span><span class="o">(</span> <span class="n">out</span> <span class="k">=&gt;</span> <span class="n">infinite</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="o">)</span> <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Scala&#8217;s <span class="monospaced">Stream</span> class is a way to generate a sequence with lazy evaluation. The values being
produced by <span class="monospaced">infinite</span> are used as example data to stream back to the client.</p></div>
<div class="paragraph"><p>Wire this into Lift in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Numbers</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Visiting <em>http://127.0.0.1:8080/numbers</em> will generate a 200 status code
and start producing the integers from 1. The numbers are produced quite quickly, so you
probably don&#8217;t want to try that in your web browser, but instead from something that
is easier to stop, such as cURL.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_48">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">OutputStreamResponse</span> expects a function of type <span class="monospaced">OutputStream =&gt; Unit</span>. The
<span class="monospaced">OutputStream</span> argument is the output stream to the client.  This means the bytes
we write to the stream are written to the client. In the above example&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">OutputStreamResponse</span><span class="o">(</span><span class="n">out</span> <span class="k">=&gt;</span> <span class="n">infinite</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;we are making use of the <span class="monospaced">write(byte[])</span> method on Java&#8217;s <span class="monospaced">OutputStream</span> (<span class="monospaced">out</span>), and sending it
the <span class="monospaced">Array[Byte]</span> being generated from our <span class="monospaced">infinite</span> stream.</p></div>
<div class="paragraph"><p>For more control over status codes, headers and cookies, there are a
variety of signatures for the <span class="monospaced">OutputStreamResponse</span> object. For the
most control, create an instance of the <span class="monospaced">OutputStreamResponse</span> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">OutputStreamResponse</span><span class="o">(</span>
  <span class="n">out</span><span class="k">:</span> <span class="o">(</span><span class="kt">OutputStream</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">,</span>
  <span class="n">size</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
  <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)],</span>
  <span class="n">cookies</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HTTPCookie</span><span class="o">],</span>
  <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Any headers you set (such as <span class="monospaced">Content-type</span>), or status code, may
already have been set by the time your output function is called. Note that
setting <span class="monospaced">size</span> to <span class="monospaced">-1</span> causes the <span class="monospaced">Content-length</span> header to be skipped.</p></div>
<div class="paragraph"><p>There are two related types of response: <span class="monospaced">InMemoryResponse</span> and
<span class="monospaced">StreamingResponse</span>.</p></div>
<div class="sect4">
<h5 id="_inmemoryresponse">InMemoryResponse</h5>
<div class="paragraph"><p><span class="monospaced">InMemoryResponse</span> is useful if you have already assembled the full
content to send to the client. The signature is straightforward:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">InMemoryResponse</span><span class="o">(</span>
  <span class="n">data</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">],</span>
  <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)],</span>
  <span class="n">cookies</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HTTPCookie</span><span class="o">],</span>
  <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>As an example, we can modify the recipe and force our <span class="monospaced">infinite</span> sequence of numbers to produce the first few numbers as a <span class="monospaced">Array[Byte]</span> in memory:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">serve</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="nc">AsInt</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">InMemoryResponse</span><span class="o">(</span><span class="n">infinite</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="n">toArray</span><span class="o">.</span><span class="n">flatten</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">,</span> <span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">AsInt</span> helper in Lift matches on an integer, meaning that a request starting with a number matches and we&#8217;ll return that many numbers from the infinite sequence. We&#8217;re not setting headers or cookies, and this request produces what you&#8217;d expect:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://127.0.0.1:8080/3
1
2
3</pre>
</div></div>
</div>
<div class="sect4">
<h5 id="_streamingresponse">StreamingResponse</h5>
<div class="paragraph"><p><span class="monospaced">StreamingResponse</span> pulls bytes into the output stream. This contrasts
with <span class="monospaced">OutputStreamResponse</span>, where you are pushing data to the client.</p></div>
<div class="paragraph"><p>Construct this type of response by providing a class with a <span class="monospaced">read</span> method that can be read
from:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">StreamingResponse</span><span class="o">(</span>
  <span class="n">data</span><span class="k">:</span> <span class="o">{</span><span class="kt">def</span> <span class="kt">read</span><span class="o">(</span><span class="kt">buf:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">])</span><span class="kt">:</span> <span class="kt">Int</span><span class="o">},</span>
  <span class="n">onEnd</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">,</span>
  <span class="n">size</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
  <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)],</span>
  <span class="n">cookies</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HTTPCookie</span><span class="o">],</span>
  <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Notice the use of a structural type for the <span class="monospaced">data</span> parameter. Anything
with a matching <span class="monospaced">read</span> method can be given here, including
<span class="monospaced">java.io.InputStream</span>-like objects, meaning <span class="monospaced">StreamingResponse</span> can act
as a pipe from input to output. Lift pulls 8k chunks from your
<span class="monospaced">StreamingResponse</span> to send to the client.</p></div>
<div class="paragraph"><p>Your <span class="monospaced">data</span> <span class="monospaced">read</span> function should follow the semantics of Java IO and
return "the total number of bytes read into the buffer, or -1 is there
is no more data because the end of the stream has been reached".</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_47">See Also</h4>
<div class="paragraph"><p>The contract for Java IO is described at <a href="http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html">http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DiskAccessControl">Serving a File with Access Control</h3>
<div class="sect3">
<h4 id="_problem_48">Problem</h4>
<div class="paragraph"><p>You have a file on disk, you want to allow a user to download it, but
only if they are allowed to. If they are not allowed to, you
want to explain why.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_48">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">RestHelper</span> to serve the file or an explanation page.</p></div>
<div class="paragraph"><p>For example,
suppose we have the file <em>/tmp/important</em> and we only want selected
requests to download that file from the <em>/download/important</em> URL. The
structure for that would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">StreamingResponse</span><span class="o">,</span> <span class="nc">LiftResponse</span><span class="o">,</span> <span class="nc">RedirectResponse</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.</span><span class="o">{</span><span class="nc">Box</span><span class="o">,</span> <span class="nc">Full</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span><span class="nc">FileInputStream</span><span class="o">,</span> <span class="nc">File</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">DownloadService</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="c1">// (code explained below to go here)</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="nc">Known</span><span class="o">(</span><span class="n">fileId</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">permitted</span><span class="o">)</span> <span class="n">fileResponse</span><span class="o">(</span><span class="n">fileId</span><span class="o">)</span>
      <span class="k">else</span> <span class="nc">Full</span><span class="o">(</span><span class="nc">RedirectResponse</span><span class="o">(</span><span class="s">&quot;/sorry&quot;</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We are allowing users to download "known" files. That is, files which we
approve of for access. We do this because opening up the file system to
any unfiltered end-user input pretty much means your server will be
compromised.</p></div>
<div class="paragraph"><p>For our example, <span class="monospaced">Known</span> is checking a static list of names:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">knownFiles</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;important&quot;</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">Known</span> <span class="o">{</span>
 <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">fileId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">knownFiles</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="k">_</span> <span class="o">==</span> <span class="n">fileId</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>For requests to these known resources, we convert the REST request into
a <span class="monospaced">Box[LiftResponse]</span>. For permitted access we serve up the file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">private</span> <span class="k">def</span> <span class="n">permitted</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">random</span> <span class="o">&lt;</span> <span class="mf">0.5d</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">fileResponse</span><span class="o">(</span><span class="n">fileId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">LiftResponse</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">file</span> <span class="k">&lt;-</span> <span class="nc">Box</span> <span class="o">!!</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">&quot;/tmp/&quot;</span><span class="o">+</span><span class="n">fileId</span><span class="o">)</span>
    <span class="n">input</span> <span class="k">&lt;-</span> <span class="n">tryo</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">))</span>
 <span class="o">}</span> <span class="k">yield</span> <span class="nc">StreamingResponse</span><span class="o">(</span><span class="n">input</span><span class="o">,</span>
    <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">input</span><span class="o">.</span><span class="n">close</span><span class="o">,</span>
    <span class="n">file</span><span class="o">.</span><span class="n">length</span><span class="o">,</span>
    <span class="n">headers</span><span class="k">=</span><span class="nc">Nil</span><span class="o">,</span>
    <span class="n">cookies</span><span class="k">=</span><span class="nc">Nil</span><span class="o">,</span>
    <span class="mi">200</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>If no permission is given, the user is redirected to <span class="monospaced">/sorry.html</span>.</p></div>
<div class="paragraph"><p>All of this is wired into Lift in <span class="monospaced">Boot.scala</span> with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">DownloadService</span><span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_49">Discussion</h4>
<div class="paragraph"><p>By turning the request into a <span class="monospaced">Box[LiftResponse]</span> we are able to serve
up the file, send the user to a different page, and also allow Lift to
handle the 404 (<span class="monospaced">Empty</span>) cases.</p></div>
<div class="paragraph"><p>If we added a test to see if the file existed on disk in <span class="monospaced">fileResponse</span>
that would cause the method to evaluate to <span class="monospaced">Empty</span> for missing files,
which triggers a 404. As the code stands, if the file does not exist,
the <span class="monospaced">tryo</span> would give us a <span class="monospaced">Failure</span> which would turn into a 404 error
with a body of "/tmp/important (No such file or directory)".</p></div>
<div class="paragraph"><p>Because we are testing for known resources via the <span class="monospaced">Known</span> extractor as
part of the pattern for <em>/download/</em>, unknown resources will not be
passed through to our <span class="monospaced">File</span> access code. Again, Lift will return a 404
for these.</p></div>
<div class="paragraph"><p>Guard expressions can also be useful for these kinds of situations:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">serve</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="nc">Known</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="k">_</span> <span class="k">if</span> <span class="n">permitted</span> <span class="k">=&gt;</span> <span class="n">fileResponse</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
  <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="k">_</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span> <span class="nc">RedirectResponse</span><span class="o">(</span><span class="s">&quot;/sorry&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>You can mix and match extractors, guards and conditions in your response
to best fit the way you want the code to look and work.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_48">See Also</h4>
<div class="paragraph"><p><em>Chatper 24: Extractors</em> from <em>Programming in Scala</em>: <a href="http://www.artima.com/pins1ed/extractors.html">http://www.artima.com/pins1ed/extractors.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RestrictByHeader">Access Restriction by HTTP Header</h3>
<div class="sect3">
<h4 id="_problem_49">Problem</h4>
<div class="paragraph"><p>You need to control access to a page based on the value of a HTTP
header.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_49">Solution</h4>
<div class="paragraph"><p>Use a custom <span class="monospaced">If</span> in SiteMap:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="nc">HeaderRequired</span> <span class="k">=</span> <span class="nc">If</span><span class="o">(</span>
  <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;ALLOWED&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="nc">Full</span><span class="o">(</span><span class="s">&quot;YES&quot;</span><span class="o">))</span> <span class="n">openOr</span> <span class="kc">false</span><span class="o">,</span>
  <span class="s">&quot;Access not allowed&quot;</span>
<span class="o">)</span>

<span class="c1">// Build SiteMap</span>
<span class="k">val</span> <span class="n">entries</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;Header Required&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;header-required&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">HeaderRequired</span>
<span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In this example <em>header-required.html</em> can only be viewed if the request
includes a HTTP header called <span class="monospaced">ALLOWED</span> with a value of <span class="monospaced">YES</span>. Any other
request for the page will be redirected with a Lift error notice of
"Access not allowed".</p></div>
<div class="paragraph"><p>This can be tested from the command line using a tool like cURL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://127.0.0.1:8080/header-required.html -H "ALLOWED:YES"</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_50">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">If</span> test ensures the <span class="monospaced">() =&gt; Boolean</span> function you supply as a first
argument returns <span class="monospaced">true</span> before the page it applies to is shown. In this example
we&#8217;ll get true if the request contains a header called "ALLOWED", and the optional
value of that header is <span class="monospaced">Full("YES")</span>.  This is a <span class="monospaced">LocParam</span> (location parameter) which
modifies the site map item. It can be appended to any menu items you want using the <span class="monospaced">&gt;&gt;</span> method.</p></div>
<div class="paragraph"><p>Note that without the header, the test will be false. This will mean with link to the page will not appear the
menu generated by <span class="monospaced">Menu.builder</span>.</p></div>
<div class="paragraph"><p>The second argument to the <span class="monospaced">If()</span> is what Lift does if the test isn&#8217;t true when the user tries to access the page.  It&#8217;s
a <span class="monospaced">() =&gt; LiftResponse</span> function.  This means return whatever you
like, including redirects to other pages.  In the example we are making use of a convenient implicit conversation
from a <span class="monospaced">String</span> ("Access not allowed") to a redirection that will take
the user to the home page.</p></div>
<div class="paragraph"><p>If you visit the page without a header, you&#8217;ll
see a notice saying "Access not allowed".  This will be the home page of the site, but
that&#8217;s just the default.</p></div>
<div class="paragraph"><p>You can request that Lift show a different page by setting <span class="monospaced">LiftRules.siteMapFailRedirectLocation</span> in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">siteMapFailRedirectLocation</span> <span class="k">=</span> <span class="s">&quot;static&quot;</span> <span class="o">::</span> <span class="s">&quot;permission&quot;</span> <span class="o">::</span> <span class="nc">Nil</span>
</pre></div></div></div>
<div class="paragraph"><p>If you then try to access <em>header-required.html</em> without the header set, you&#8217;ll be redirected to <em>/static/permission</em> and shown the content of
whatever you put in that page.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_49">See Also</h4>
<div class="paragraph"><p>The Lift wiki gives a summary of Lift&#8217;s Site Map and the tests you can include in site map entries: <a href="https://www.assembla.com/wiki/show/liftweb/SiteMap">https://www.assembla.com/wiki/show/liftweb/SiteMap</a>.</p></div>
<div class="paragraph"><p>There are further details in chapter 7 of <em>Exploring Lift</em> at <a href="http://exploring.liftweb.net">http://exploring.liftweb.net</a>, and "SiteMap and access control", chapter 7 of <em>Lift in Action</em> (Perrett, 2012, Manning Publications Co.).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="HttpServletRequest">Accessing <span class="monospaced">HttpServletRequest</span></h3>
<div class="sect3">
<h4 id="_problem_50">Problem</h4>
<div class="paragraph"><p>To satisfy some API you need access to the <span class="monospaced">HttpServletRequest</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_50">Solution</h4>
<div class="paragraph"><p>Cast <span class="monospaced">S.request</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.provider.servlet.HTTPRequestServlet</span>
<span class="k">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span>

<span class="k">def</span> <span class="n">servletRequest</span><span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">HttpServletRequest</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">req</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span>
  <span class="n">inner</span> <span class="k">&lt;-</span> <span class="nc">Box</span><span class="o">.</span><span class="n">asA</span><span class="o">[</span><span class="kt">HTTPRequestServlet</span><span class="o">](</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">inner</span><span class="o">.</span><span class="n">req</span>
</pre></div></div></div>
<div class="paragraph"><p>You can then make your API call:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">servletRequest</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">r</span> <span class="k">=&gt;</span> <span class="n">yourApiCall</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_51">Discussion</h4>
<div class="paragraph"><p>Lift abstracts away from the low-level HTTP request, and from the details of the
servlet container your application is running in.  However, it&#8217;s reassuring to know, if you
absolutely need it, there is a way to get back down to the low-level.</p></div>
<div class="paragraph"><p>Note that the results of <span class="monospaced">servletRequest</span> is a <span class="monospaced">Box</span> because there might not be a request
when you evaluate <span class="monospaced">servletRequest</span>&#8201;&#8212;&#8201;or you might one day port to a
different deployment environment and not be running on a standard Java
servlet container.</p></div>
<div class="paragraph"><p>As your code will have a direct dependency on the Java Servlet API,
you&#8217;ll need to include this dependency in your SBT build:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;javax.servlet&quot;</span> <span class="o">%</span> <span class="s">&quot;servlet-api&quot;</span> <span class="o">%</span> <span class="s">&quot;2.5&quot;</span> <span class="o">%</span> <span class="s">&quot;provided-&gt;default&quot;</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="RewriteForHttps">Force HTTPS Requests</h3>
<div class="sect3">
<h4 id="_problem_51">Problem</h4>
<div class="paragraph"><p>You want to ensure clients are using HTTPs.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_51">Solution</h4>
<div class="paragraph"><p>Add an <span class="monospaced">earlyResponse</span> function in <span class="monospaced">Boot.scala</span> redirecting http requests to https
equivalents. For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">earlyResponse</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span> <span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">scheme</span> <span class="o">!=</span> <span class="s">&quot;https&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">uriAndQuery</span> <span class="k">=</span> <span class="n">req</span><span class="o">.</span><span class="n">uri</span> <span class="o">+</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">queryString</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="s">&quot;?&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">)</span> <span class="n">openOr</span> <span class="s">&quot;&quot;</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;https://%s%s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">serverName</span><span class="o">,</span> <span class="n">uriAndQuery</span><span class="o">)</span>
    <span class="nc">Full</span><span class="o">(</span><span class="nc">PermRedirectResponse</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">cookies</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">))</span>
  <span class="o">}</span>
  <span class="k">else</span> <span class="nc">Empty</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_52">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">earlyResponse</span> call is called early in the Lift pipeline. It is
used to execute code before a request is handled and, if required, exit the
pipeline and return a response. The function signature expected is
<span class="monospaced">Req =&gt; Box[LiftResponse]</span>.</p></div>
<div class="paragraph"><p>In this example we are testing for a request that is not "https", and then
formulating a new URL that starts "https" and appends to it the rest of the
original URL and any query parameters. With this created, we return a redirections
to the new URL, along with any cookies that were set.</p></div>
<div class="paragraph"><p>By evaluating to <span class="monospaced">Empty</span> for other requests (i.e., https requets), Lift will continue passing the request
through the pipeline as usual.</p></div>
<div class="paragraph"><p>The ideal method to ensure requests are served using the correct scheme
would be via web server configuration, such as Apache or Nginx. This
isn&#8217;t possible in some cases, such as when your application is deployed
to a PaaS such as CloudBees.</p></div>
<div class="sect4">
<h5 id="_amazon_load_balancer">Amazon Load Balancer</h5>
<div class="paragraph"><p>For Amazon Elastic Load Balancer note that you need to use
<span class="monospaced">X-Forwarded-Proto</span> header to detect HTTPS. As mentioned in their
<em>Overview of Elastic Load Balancing</em> document, "Your server access logs
contain only the protocol used between the server and the load balancer;
they contain no information about the protocol used between the client
and the load balancer."</p></div>
<div class="paragraph"><p>In this situation modify the above test from
<span class="monospaced">req.request.scheme != "https"</span> to:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">req</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;X-Forwarded-Proto&quot;</span><span class="o">)</span> <span class="o">!=</span> <span class="nc">Full</span><span class="o">(</span><span class="s">&quot;https&quot;</span><span class="o">)</span>
</pre></div></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_50">See Also</h4>
<div class="paragraph"><p>The <em>Overview of Elastic Load Balancing</em> can be found at: <a href="http://docs.amazonwebservices.com/ElasticLoadBalancing/latest/DeveloperGuide/arch-loadbalancing.html">http://docs.amazonwebservices.com/ElasticLoadBalancing/latest/DeveloperGuide/arch-loadbalancing.html</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Squeryl">Relational Database Persistence with Record and Squeryl</h2>
<div class="sectionbody">
<div class="paragraph"><p>Squeryl is an object-relational mapping library.  It converts Scala classes into tables, rows and columns in a relational database, and provides a way to write SQL-like queries that are type-checked by the Scala compiler. The Lift Squeryl Record module integrates Squeryl with Record, meaning your Lift application and use Squeryl to store and fetch data while making use of the features of record, such as data validation.</p></div>
<div class="paragraph"><p>The code in this chapter can be found at: <a href="https://github.com/LiftCookbook/cookbook_squeryl">https://github.com/LiftCookbook/cookbook_squeryl</a>.</p></div>
<div class="sect2">
<h3 id="ConfiguringSqueryl">Configuring Squeryl and Record</h3>
<div class="sect3">
<h4 id="_problem_52">Problem</h4>
<div class="paragraph"><p>You want to configure your Lift application to use Squeryl and Record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_52">Solution</h4>
<div class="paragraph"><p>Include the Squeryl-Record dependency in your build, and in <span class="monospaced">Boot.scala</span> provide a database connection function to <span class="monospaced">SquerylRecord.initWithSquerylSession</span>.</p></div>
<div class="paragraph"><p>For example, to configure Squeryl with PostgreSQL, modify <span class="monospaced">build.sbt</span> to add two dependencies, one for Squeryl-Record and one for the database driver:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-RC2&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span><span class="o">,</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-squeryl-record&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span><span class="o">,</span>
    <span class="s">&quot;postgresql&quot;</span> <span class="o">%</span> <span class="s">&quot;postgresql&quot;</span> <span class="o">%</span> <span class="s">&quot;9.1-901.jdbc4&quot;</span>
    <span class="o">...</span>
    <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This will give you access to Squeryl version 0.9.5-6.</p></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> we define a connection and register it with Squeryl:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="s">&quot;org.postgresql.Driver&quot;</span><span class="o">)</span>

<span class="k">def</span> <span class="n">connection</span> <span class="k">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span>
  <span class="s">&quot;jdbc:postgresql://localhost/mydb&quot;</span><span class="o">,</span>
  <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="s">&quot;password&quot;</span><span class="o">)</span>

<span class="nc">SquerylRecord</span><span class="o">.</span><span class="n">initWithSquerylSession</span><span class="o">(</span>
  <span class="nc">Session</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="k">new</span> <span class="nc">PostgreSqlAdapter</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>All Squeryl queries need to run in the context of a transaction.  One way to provide a transaction is to configure
a transaction around all HTTP requests. This is also configured in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">S</span><span class="o">.</span><span class="n">addAround</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoanWrapper</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">inTransaction</span> <span class="o">{</span> <span class="n">f</span> <span class="o">}</span>
<span class="o">})</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_53">Discussion</h4>
<div class="paragraph"><p>You can use any JVM persistence mechanism with Lift. What Lift Record provides is a light interface around persistence with bindings to Lift&#8217;s CSS transforms, screens and wizards. Squeryl-Record is a concrete implementation to connect Record with Squeryl.  This means you can use standard Record objects, which are effectively your schema, with Squeryl and write queries which are validated at compile time.</p></div>
<div class="paragraph"><p>Plugging into Squeryl means initializing Squeryl&#8217;s session management, which allows us to wrap queries in Squeryl&#8217;s <span class="monospaced">transaction</span> and <span class="monospaced">inTransaction</span> functions.  The difference between these two calls is that <span class="monospaced">inTransaction</span> will start a new transaction if one doesn&#8217;t exist, whereas <span class="monospaced">transaction</span> always creates a new transaction.</p></div>
<div class="paragraph"><p>By ensuring a transaction is available for all HTTP requests via <span class="monospaced">addAround</span>, we can write queries in Lift and for the most part not have to establish transactions ourselves unless we want to.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>
<span class="k">val</span> <span class="n">r</span> <span class="k">=</span> <span class="n">myTable</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">MyRecord</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">myField</span><span class="o">(</span><span class="n">aValue</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>In this recipe, the <span class="monospaced">PostgreSqlAdapter</span> is being used. Squeryl also supports: <span class="monospaced">OracleAdapter</span>, <span class="monospaced">MySQLInnoDBAdapter</span> and <span class="monospaced">MySQLAdapter</span>, <span class="monospaced">MSSQLServer</span>, <span class="monospaced">H2Adapter</span>, <span class="monospaced">DB2Adapter</span> and <span class="monospaced">DerbyAdapter</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_51">See Also</h4>
<div class="paragraph"><p>The Squeryl <em>Getting Started Guide</em> links to more information about session management and configuration: <a href="http://squeryl.org/getting-started.html">http://squeryl.org/getting-started.html</a>.</p></div>
<div class="paragraph"><p>See <a href="#SquerylJNDI">[SquerylJNDI]</a> for configuring connections via Java Naming and Directory Interface (JNDI).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylJNDI">Using a JNDI Datasource</h3>
<div class="sect3">
<h4 id="_problem_53">Problem</h4>
<div class="paragraph"><p>You want to use a JNDI data source for your Record+Squeryl Lift
application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_53">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> call <span class="monospaced">initWithSquerylSession</span> with a <span class="monospaced">DataSource</span> looked up from the JDNI context:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">javax.sql.DataSource</span>
<span class="k">val</span> <span class="n">ds</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InitialContext</span><span class="o">().</span>
  <span class="n">lookup</span><span class="o">(</span><span class="s">&quot;java:comp/env/jdbc/mydb&quot;</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">DataSource</span><span class="o">]</span>

<span class="nc">SquerylRecord</span><span class="o">.</span><span class="n">initWithSquerylSession</span><span class="o">(</span>
  <span class="nc">Session</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">MySQLAdapter</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;replacing <span class="monospaced">mydb</span> with the name given to your database in your JNDI
configuration, and replacing <span class="monospaced">MySQLAdapter</span> with the appropriate adapter
for the database you are using.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_54">Discussion</h4>
<div class="paragraph"><p>The Java Naming and Directory Interface (JNDI) is service provided by
the web container (e.g., Jetty, Tomcat) which allows you to
configure a database connection in the container and then refer the
connection by name in your application. One advantage of this is that
you can avoid including database credentials to your Lift source base.</p></div>
<div class="paragraph"><p>The configuration of JNDI is different for each container, and may vary
with versions of the container you use. The <em>See Also</em> section includes
links to the documentation pages for popular containers.</p></div>
<div class="paragraph"><p>Some environments may also require that you to reference the JNDI resource
in your <span class="monospaced">src/main/webapp/WEB-INF/web.xml</span> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;resource-ref&gt;</span>
 <span class="nt">&lt;res-ref-name&gt;</span>jdbc/mydb<span class="nt">&lt;/res-ref-name&gt;</span>
 <span class="nt">&lt;res-type&gt;</span>javax.sql.DataSource<span class="nt">&lt;/res-type&gt;</span>
 <span class="nt">&lt;res-auth&gt;</span>Container<span class="nt">&lt;/res-auth&gt;</span>
<span class="nt">&lt;/resource-ref&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_52">See Also</h4>
<div class="paragraph"><p>Resources for JDNI configuration include:</p></div>
<div class="ulist"><ul>
<li>
<p>
An example on the Lift Wiki for Apache and Jetty configuration at:<a href="http://www.assembla.com/spaces/liftweb/wiki/Apache_and_Jetty_Configuration">http://www.assembla.com/spaces/liftweb/wiki/Apache_and_Jetty_Configuration</a>.
</p>
</li>
<li>
<p>
The documentation for Jetty gives examples for various databases: <a href="http://www.eclipse.org/jetty/documentation/current/jndi-datasource-examples.html">http://www.eclipse.org/jetty/documentation/current/jndi-datasource-examples.html</a>.
</p>
</li>
<li>
<p>
For Tomcat, the JNDI configuration guide is: <a href="http://tomcat.apache.org/tomcat-7.0-doc/jndi-resources-howto.html#JDBC_Data_Sources">http://tomcat.apache.org/tomcat-7.0-doc/jndi-resources-howto.html#JDBC_Data_Sources</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylOneToMany">One-to-Many Relationship</h3>
<div class="sect3">
<h4 id="_problem_54">Problem</h4>
<div class="paragraph"><p>You want to model a one-to-many relationship, such as a satellite belonging to a single planet, but a planet possibly having many satellites.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_54">Solution</h4>
<div class="paragraph"><p>Use Squeryl&#8217;s <span class="monospaced">oneToManyRelation</span> in your schema, and on your Lift model include a reference from the satellite to the planet.</p></div>
<div class="paragraph"><p>The objective is to model the relationship as shown in <a href="#SquerylPlanetOneToManyFigure">[SquerylPlanetOneToManyFigure]</a>.</p></div>
<div class="imageblock" id="SquerylPlanetOneToManyFigure">
<div class="content">
<img src="images/planets.png" alt="images/planets.png" width="640">
</div>
<div class="title">Figure 3. One planet may have many satellites, but a satellite orbits just one planet.</div>
</div>
<div class="paragraph"><p>In code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">org.squeryl.Schema</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.</span><span class="o">{</span><span class="nc">MetaRecord</span><span class="o">,</span> <span class="nc">Record</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.KeyedRecord</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.field.</span><span class="o">{</span><span class="nc">StringField</span><span class="o">,</span> <span class="nc">LongField</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>

<span class="k">object</span> <span class="nc">MySchema</span> <span class="k">extends</span> <span class="nc">Schema</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">planets</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>
  <span class="k">val</span> <span class="n">satellites</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">planetToSatellites</span> <span class="k">=</span> <span class="n">oneToManyRelation</span><span class="o">(</span><span class="n">planets</span><span class="o">,</span> <span class="n">satellites</span><span class="o">).</span>
    <span class="n">via</span><span class="o">((</span><span class="n">p</span><span class="o">,</span><span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="o">===</span> <span class="n">s</span><span class="o">.</span><span class="n">planetId</span><span class="o">)</span>

  <span class="n">on</span><span class="o">(</span><span class="n">satellites</span><span class="o">)</span> <span class="o">{</span> <span class="n">s</span> <span class="k">=&gt;</span>
    <span class="n">declare</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">planetId</span> <span class="n">defineAs</span> <span class="n">indexed</span><span class="o">(</span><span class="s">&quot;planet_idx&quot;</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">satellites</span> <span class="k">=</span> <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">left</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Planet</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>

  <span class="k">class</span> <span class="nc">Satellite</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
     <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Satellite</span>
     <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
     <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
     <span class="k">val</span> <span class="n">planetId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
     <span class="k">lazy</span> <span class="k">val</span> <span class="n">planet</span> <span class="k">=</span> <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">right</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Satellite</span> <span class="k">extends</span> <span class="nc">Satellite</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This schema defines the two tables based on the Record classes, as <span class="monospaced">table[Planet]</span> and <span class="monospaced">table[Satellite]</span>. It establishes a <span class="monospaced">oneToManyRelation</span> based on (<span class="monospaced">via</span>) the <span class="monospaced">planetId</span> in the satellite table.</p></div>
<div class="paragraph"><p>This gives Squeryl the information it needs to produce a foreign key to constrain the <span class="monospaced">planetId</span> to reference an existing record in the planet table. This can be seen in the schema generated by Squeryl:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">-- table declarations :</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Planet</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span>
  <span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Satellite</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">planetId</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span>
  <span class="p">);</span>
<span class="c1">-- indexes on Satellite</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">planet_idx</span> <span class="k">on</span> <span class="n">Satellite</span> <span class="p">(</span><span class="n">planetId</span><span class="p">);</span>
<span class="c1">-- foreign key constraints :</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Satellite</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">SatelliteFK1</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Planet</span><span class="p">(</span><span class="n">idField</span><span class="p">);</span>
</pre></div></div></div>
<div class="paragraph"><p>An index called <span class="monospaced">planet_idx</span> is declared on the <span class="monospaced">planetId</span> field to improve query performance during joins.</p></div>
<div class="paragraph"><p>Finally we make use of the <span class="monospaced">planetToSatellites.left</span> and <span class="monospaced">right</span> methods to establish lookup queries as <span class="monospaced">Planet.satellites</span> and <span class="monospaced">Satellite.planet</span>.  We can demonstrate their use by inserting example data and running the queries:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">inTransaction</span> <span class="o">{</span>
  <span class="n">code</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="nc">MySchema</span><span class="o">.</span><span class="n">create</span>

  <span class="k">import</span> <span class="nn">code.model.MySchema._</span>

  <span class="k">val</span> <span class="n">earth</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Earth&quot;</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">mars</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars&quot;</span><span class="o">))</span>

  <span class="c1">// .save as a short-hand for satellite.insert when we don&#39;t need</span>
  <span class="c1">// to immediately reference the record (save returns Unit).</span>
  <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;The Moon&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">earth</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>
  <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Phobos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>

  <span class="k">val</span> <span class="n">deimos</span> <span class="k">=</span> <span class="n">satellites</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span>
    <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Deimos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">)</span> <span class="o">)</span>

  <span class="n">println</span><span class="o">(</span><span class="s">&quot;Deimos orbits: &quot;</span><span class="o">+</span><span class="n">deimos</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">)</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;Moons of Mars are: &quot;</span><span class="o">+</span><span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">))</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Running this code produce the output:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Deimos orbits: Mars
Moons of Mars are: List(Phobos, Deimos)</pre>
</div></div>
<div class="paragraph"><p>In this example code we&#8217;re calling <span class="monospaced">deimos.planet.single</span> which returns one result or will thrown an exception if the associated planet was not found. <span class="monospaced">headOption</span> is the safer way if there&#8217;s a chance the record will not be found, as it will evaluate to <span class="monospaced">None</span> or <span class="monospaced">Some[Planet]</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_55">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">planetToSatellites.left</span> method is not a simple collection of <span class="monospaced">Satellite</span> objects.  It&#8217;s a Squeryl <span class="monospaced">Query[Satellite]</span>, meaning you can treat it like any other kind of <span class="monospaced">Queryable[Satellite]</span>.  For example we could ask for those satellites of a planet that are alphabetically after "E", which for Mars would match "Phobos":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="n">gt</span> <span class="s">&quot;E&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">left</span> method result is also a <span class="monospaced">OneToMany[Satellite]</span> which adds the following methods:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">assign</span>&#8201;&#8212;&#8201;adds a new relationship, but does not update the database.
</p>
</li>
<li>
<p>
<span class="monospaced">associate</span>&#8201;&#8212;&#8201;which is like <span class="monospaced">assign</span> but does update the database.
</p>
</li>
<li>
<p>
<span class="monospaced">deleteAll</span>&#8201;&#8212;&#8201;to remove the relationships.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <span class="monospaced">assign</span> call gives the satellite the relationship to the planet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">express</span> <span class="k">=</span> <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars Express&quot;</span><span class="o">)</span>
<span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">assign</span><span class="o">(</span><span class="n">express</span><span class="o">)</span>
<span class="n">express</span><span class="o">.</span><span class="n">save</span>
</pre></div></div></div>
<div class="paragraph"><p>The next time we query <span class="monospaced">mars.satellites</span> we will find the Mars Express orbiter.</p></div>
<div class="paragraph"><p>A call to <span class="monospaced">associate</span> would go one step further for us, making Squeryl insert or update the satellite automatically:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">express</span> <span class="k">=</span> <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars Express&quot;</span><span class="o">)</span>
<span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">express</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The third method, <span class="monospaced">deleteAll</span> does what it sounds like it should do. It would execute the following and return the number of rows removed:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">Satellite</span>
</pre></div></div></div>
<div class="paragraph"><p>The right side of the one-to-many also has additional methods added by <span class="monospaced">ManyToOne[Planet]</span> of <span class="monospaced">assign</span> and <span class="monospaced">delete</span>.  Be aware that to delete the "one" side of a many-to-one, anything assigned to record will need to have been deleted already to avoid a database constraint error that would arise from, for example, leaving satellites referencing non-existent planets.</p></div>
<div class="paragraph"><p>As <span class="monospaced">left</span> and <span class="monospaced">right</span> are queries, it means each time you use them you&#8217;ll be sending a new query to the database.  Squeryl refer to these forms as <em>stateless relations</em>.</p></div>
<div class="paragraph"><p>The <em>stateful</em> versions of <span class="monospaced">left</span> and <span class="monospaced">right</span> look like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
 <span class="o">...</span>
 <span class="k">lazy</span> <span class="k">val</span> <span class="n">satellites</span> <span class="k">:</span> <span class="kt">StatefulOneToMany</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span> <span class="k">=</span>
   <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">leftStateful</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Satellite</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">planet</span> <span class="k">:</span> <span class="kt">StatefulManyToOne</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">rightStateful</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This change means the results of <span class="monospaced">mars.satellites</span> will be cached. Subsequent calls on that instance of a <span class="monospaced">Planet</span> won&#8217;t trigger a round trip to the database. You can still <span class="monospaced">associate</span> new records or <span class="monospaced">deleteAll</span> records which will work as you expect, but if a relationship is added or changed elsewhere you&#8217;ll need to call <span class="monospaced">refresh</span> on the relation to see the change.</p></div>
<div class="paragraph"><p>Which version should you use? That will depend on your application, but you can use both in the same record if you need to.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_53">See Also</h4>
<div class="paragraph"><p>Squeryl relations are documented at <a href="http://squeryl.org/relations.html">http://squeryl.org/relations.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylManyToMany">Many-to-Many Relationship</h3>
<div class="sect3">
<h4 id="_problem_55">Problem</h4>
<div class="paragraph"><p>You want to model a many-to-many relationship, such as a planet being visted by many space probes, but a space probe also visiting many planets.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_55">Solution</h4>
<div class="paragraph"><p>Use Squeryl&#8217;s <span class="monospaced">manyToManyRelation</span> in your schema, and implement a record to hold the join between the two sides of the relationship. <a href="#SquerylPlanetManyToManyFigure">[SquerylPlanetManyToManyFigure]</a> shows the structure we will create in this recipe, where <span class="monospaced">Visit</span> is the record that will connect each many to the other many.</p></div>
<div class="imageblock" id="SquerylPlanetManyToManyFigure">
<div class="content">
<img src="images/visits.png" alt="images/visits.png" width="640">
</div>
<div class="title">Figure 4. Many-to-many: Jupiter was visited by Juno and Voyager 1; Saturn was visited by Voyager.</div>
</div>
<div class="paragraph"><p>The schema is defined in terms of two tables, one for planets and one for space probes, plus a relationship between the two based on a third class, called <span class="monospaced">Visit</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">org.squeryl.Schema</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.</span><span class="o">{</span><span class="nc">MetaRecord</span><span class="o">,</span> <span class="nc">Record</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.KeyedRecord</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.field.</span><span class="o">{</span><span class="nc">IntField</span><span class="o">,</span> <span class="nc">StringField</span><span class="o">,</span> <span class="nc">LongField</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>
<span class="k">import</span> <span class="nn">org.squeryl.dsl.ManyToMany</span>

<span class="k">object</span> <span class="nc">MySchema</span> <span class="k">extends</span> <span class="nc">Schema</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">planets</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>
  <span class="k">val</span> <span class="n">probes</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Probe</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">probeVisits</span> <span class="k">=</span> <span class="n">manyToManyRelation</span><span class="o">(</span><span class="n">probes</span><span class="o">,</span> <span class="n">planets</span><span class="o">).</span><span class="n">via</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span> <span class="o">{</span>
    <span class="o">(</span><span class="n">probe</span><span class="o">,</span> <span class="n">planet</span><span class="o">,</span> <span class="n">visit</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="o">(</span><span class="n">visit</span><span class="o">.</span><span class="n">probeId</span> <span class="o">===</span> <span class="n">probe</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">visit</span><span class="o">.</span><span class="n">planetId</span> <span class="o">===</span> <span class="n">planet</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">probes</span> <span class="k">:</span> <span class="kt">ManyToMany</span><span class="o">[</span><span class="kt">Probe</span>,<span class="kt">Visit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">MySchema</span><span class="o">.</span><span class="n">probeVisits</span><span class="o">.</span><span class="n">right</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Planet</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>

  <span class="k">class</span> <span class="nc">Probe</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Probe</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Probe</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">planets</span> <span class="k">:</span> <span class="kt">ManyToMany</span><span class="o">[</span><span class="kt">Planet</span>,<span class="kt">Visit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">MySchema</span><span class="o">.</span><span class="n">probeVisits</span><span class="o">.</span><span class="n">left</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Probe</span> <span class="k">extends</span> <span class="nc">Probe</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Probe</span><span class="o">]</span>

  <span class="k">class</span> <span class="nc">Visit</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Visit</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">planetId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">probeId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Visit</span> <span class="k">extends</span> <span class="nc">Visit</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> we can print out the schema&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">inTransaction</span> <span class="o">{</span>
  <span class="n">code</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="nc">MySchema</span><span class="o">.</span><span class="n">printDdl</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;which will produce something like this, depending on the database in use:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">-- table declarations :</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Planet</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span>
  <span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Probe</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span>
  <span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Visit</span> <span class="p">(</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">planetId</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">probeId</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span>
  <span class="p">);</span>
<span class="c1">-- foreign key constraints :</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK1</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">probeId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Probe</span><span class="p">(</span><span class="n">idField</span><span class="p">);</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK2</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Planet</span><span class="p">(</span><span class="n">idField</span><span class="p">);</span>
</pre></div></div></div>
<div class="paragraph"><p>Notice that the <span class="monospaced">visit</span> table will hold a row for each relationship between a <span class="monospaced">planetId</span> and <span class="monospaced">probeId</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">Planet.probes</span> and <span class="monospaced">Probe.planets</span> provide an <span class="monospaced">associate</span> method to establish a new relationship. For example, we can establish a set of planets and probes&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">jupiter</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Jupiter&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">saturn</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Saturn&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">juno</span> <span class="k">=</span> <span class="n">probes</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Probe</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Juno&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">voyager1</span> <span class="k">=</span> <span class="n">probes</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Probe</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Voyager 1&quot;</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;and then connect them:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">juno</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
<span class="n">voyager1</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
<span class="n">voyager1</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">saturn</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>We can also use <span class="monospaced">Probe.planets</span> and <span class="monospaced">Planet.probes</span> as a query to look up the associations.  To access all the probes that had visited each planet in a snippet, we can write this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">class</span> <span class="nc">ManyToManySnippet</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="s">&quot;#planet-visits&quot;</span> <span class="o">#&gt;</span> <span class="n">planets</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">planet</span> <span class="k">=&gt;</span>
      <span class="s">&quot;.planet-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">planet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span> <span class="o">&amp;</span>
      <span class="s">&quot;.probe-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">planet</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The snippet could be combined with a template like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;ManyToManySnippet&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Planet facts<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;planet-visits&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;planet-name&quot;</span><span class="nt">&gt;</span>Name will be here<span class="nt">&lt;/span&gt;</span> was visited by:
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;probe-name&quot;</span><span class="nt">&gt;</span>Probe name goes here<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The top half of <a href="#SquerylManyToManyScreengrab">[SquerylManyToManyScreengrab]</a> gives an example of the output from this snippet and template.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_56">Discussion</h4>
<div class="paragraph"><p>The Squeryl DSL <span class="monospaced">manyToManyRelation(probes, planets).via[Visit]</span> is the core element here connecting our <span class="monospaced">Planet</span>, <span class="monospaced">Probe</span> and <span class="monospaced">Visit</span> records together. It allows us to access the "left" and "right" sides of the relationship in our model as <span class="monospaced">Probe.planets</span> and <span class="monospaced">Planet.probes</span>.</p></div>
<div class="paragraph"><p>As with <a href="#SquerylOneToMany">[SquerylOneToMany]</a> for one-to-many relationships, the left and right sides are queries. When you ask for <span class="monospaced">Planet.probes</span> the database is queried appropriately with a join on the <span class="monospaced">Visit</span> records:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">Select</span>
  <span class="n">Probe</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
  <span class="n">Probe</span><span class="p">.</span><span class="n">idField</span>
<span class="k">From</span>
  <span class="n">Visit</span><span class="p">,</span>
  <span class="n">Probe</span>
<span class="k">Where</span>
  <span class="p">(</span><span class="n">Visit</span><span class="p">.</span><span class="n">probeId</span> <span class="o">=</span> <span class="n">Probe</span><span class="p">.</span><span class="n">idField</span><span class="p">)</span> <span class="k">and</span> <span class="p">(</span><span class="n">Visit</span><span class="p">.</span><span class="n">planetId</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Also as described in <a href="#SquerylOneToMany">[SquerylOneToMany]</a> there are stateful variants of <span class="monospaced">left</span> and <span class="monospaced">right</span> to cache the query results.</p></div>
<div class="paragraph"><p>In the data we inserted into the database, we did not have to mention <span class="monospaced">Visit</span>. The Squeryl <span class="monospaced">manyToManyRelation</span> has enough information to know how to insert a visit as the relationship.  Incidentally, it doesn&#8217;t matter which way round we make the calls in a many-to-many relationship.  The following two expressions are equivalent and result in the same database structure:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">juno</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
<span class="c1">// ..or..</span>
<span class="n">jupiter</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">juno</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>You might even wonder why we had to bother with defining a <span class="monospaced">Visit</span> record at all, but there are benefits in doing so. For example, you can attach additional information onto the join table, such as the year the probe visited a planet.</p></div>
<div class="paragraph"><p>To do this, we modify the record to include the additional field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Visit</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Visit</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">planetId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">probeId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">year</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">IntField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">Visit</span> is still a container for the <span class="monospaced">planetId</span> and <span class="monospaced">probeId</span> references, but we also have a plain integer holder for the year of the visit.</p></div>
<div class="paragraph"><p>To record a visit year, we need the <span class="monospaced">assign</span> method provided by <span class="monospaced">ManyToMany[T]</span>.  This will establish the relationship, but not change the database. Instead, it returns the <span class="monospaced">Visit</span> instance which we can change and then store in the database:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">probeVisits</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">voyager1</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">assign</span><span class="o">(</span><span class="n">saturn</span><span class="o">).</span><span class="n">year</span><span class="o">(</span><span class="mi">1980</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>The return type of <span class="monospaced">assign</span> in this case is <span class="monospaced">Visit</span>, and <span class="monospaced">Visit</span> has a <span class="monospaced">year</span> field. Inserting the <span class="monospaced">Visit</span> record via <span class="monospaced">probeVisits</span> will create a row in the table for visits.</p></div>
<div class="paragraph"><p>To access this extra information on the <span class="monospaced">Visit</span> object, you can make use of a couple of methods provided by <span class="monospaced">ManyToMany[T]</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">associations</span>&#8201;&#8212;&#8201;a query returning the <span class="monospaced">Visit</span> objects related to the <span class="monospaced">Planet.probes</span> or <span class="monospaced">Probe.planets</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">associationMap</span>&#8201;&#8212;&#8201;a query returning pairs of <span class="monospaced">(Planet,Visit)</span> or <span class="monospaced">(Probe,Visit)</span> depending on which side of the join you call it on (probes or planets).
</p>
</li>
</ul></div>
<div class="paragraph"><p>For example, in a snippet we could list all the space probes, and for each probe show the planet it visited and what year it was there.  The snippet would look like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;#probe-visits&quot;</span> <span class="o">#&gt;</span> <span class="n">probes</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">probe</span> <span class="k">=&gt;</span>
  <span class="s">&quot;.probe-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">probe</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span> <span class="o">&amp;</span>
  <span class="s">&quot;.visit&quot;</span> <span class="o">#&gt;</span> <span class="n">probe</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associationMap</span><span class="o">.</span><span class="n">collect</span> <span class="o">{</span>
    <span class="k">case</span> <span class="o">(</span><span class="n">planet</span><span class="o">,</span> <span class="n">visit</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="s">&quot;.planet-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">planet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span> <span class="o">&amp;</span>
      <span class="s">&quot;.year&quot;</span> <span class="o">#&gt;</span> <span class="n">visit</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">is</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We are using <span class="monospaced">collect</span> here rather than <span class="monospaced">map</span> just to match the <span class="monospaced">(Planet,Visit)</span> tuple and give the values meaningful names. You could also use <span class="monospaced">(for { (planet, visit) &lt;- probe.planets.associationMap } yield ...)</span> if you prefer.</p></div>
<div class="paragraph"><p>The lower-half of <a href="#SquerylManyToManyScreengrab">[SquerylManyToManyScreengrab]</a> demonstrates how this snippet would render when combined with the following template:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Probe facts<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;probe-visits&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;probe-name&quot;</span><span class="nt">&gt;</span>Space craft name<span class="nt">&lt;/span&gt;</span> visited:<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;visit&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;planet-name&quot;</span><span class="nt">&gt;</span>Name here<span class="nt">&lt;/span&gt;</span> in <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;year&quot;</span><span class="nt">&gt;</span>n<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="imageblock" id="SquerylManyToManyScreengrab">
<div class="content">
<img src="images/visitsscreengrab.png" alt="images/visitsscreengrab.png" width="640">
</div>
<div class="title">Figure 5. Example output from using the many-to-many features in this recipe.</div>
</div>
<div class="paragraph"><p>To remove an association you have access to <span class="monospaced">dissociate</span> and <span class="monospaced">dissociateAll</span> on the <span class="monospaced">left</span> and <span class="monospaced">right</span> queries.  To remove a single association:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">numRowsChanged</span> <span class="k">=</span> <span class="n">juno</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">dissociate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This would be executed in SQL as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">Visit</span>
<span class="k">where</span>
  <span class="n">probeId</span> <span class="o">=</span> <span class="o">?</span> <span class="k">and</span> <span class="n">planetId</span> <span class="o">=</span> <span class="o">?</span>
</pre></div></div></div>
<div class="paragraph"><p>To remove all the associations:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">numRowsChanged</span> <span class="k">=</span> <span class="n">jupiter</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">dissociateAll</span>
</pre></div></div></div>
<div class="paragraph"><p>The SQL for this is:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">Visit</span>
<span class="k">where</span>
  <span class="n">Visit</span><span class="p">.</span><span class="n">planetId</span> <span class="o">=</span> <span class="o">?</span>
</pre></div></div></div>
<div class="paragraph"><p>What you cannot do is delete a <span class="monospaced">Planet</span> or <span class="monospaced">Probe</span> if that record still has associations in the <span class="monospaced">Visit</span> relationship.  What you&#8217;d get is a referential integrity exception thrown.  Instead, you&#8217;ll need to <span class="monospaced">dissociatateAll</span> first:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">jupiter</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">dissociateAll</span>
<span class="n">planets</span><span class="o">.</span><span class="n">delete</span><span class="o">(</span><span class="n">jupiter</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>However, if you do want <em>cascading deletes</em> you can achieve this by overriding the default behaviour in your schema:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// To automatically remove probes when we remove planets:</span>
<span class="n">probeVisits</span><span class="o">.</span><span class="n">rightForeignKeyDeclaration</span><span class="o">.</span><span class="n">constrainReference</span><span class="o">(</span><span class="n">onDelete</span> <span class="n">cascade</span><span class="o">)</span>

<span class="c1">// To automatically remove planets when we remove probes:</span>
<span class="n">probeVisits</span><span class="o">.</span><span class="n">leftForeignKeyDeclaration</span><span class="o">.</span><span class="n">constrainReference</span><span class="o">(</span><span class="n">onDelete</span> <span class="n">cascade</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This is part of the schema, in that it will change the table constraints, with <span class="monospaced">printDdl</span> producing this (depending on the database you use):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK1</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">probeId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Probe</span><span class="p">(</span><span class="n">idField</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK2</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Planet</span><span class="p">(</span><span class="n">idField</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span><span class="p">;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_54">See Also</h4>
<div class="paragraph"><p><a href="#SquerylOneToMany">[SquerylOneToMany]</a>, on one-to-many relationships, discusses <span class="monospaced">leftStateful</span> and <span class="monospaced">rightStateful</span> relations, which are also applicable for many-to-many relationships.</p></div>
<div class="paragraph"><p>Foreign keys, cascading deletes, are described at: <a href="http://squeryl.org/relations.html">http://squeryl.org/relations.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FieldValidation">Adding Validation to a Field</h3>
<div class="sect3">
<h4 id="_problem_56">Problem</h4>
<div class="paragraph"><p>You want to add validation to a field in your model, so that users are informed of missing fields or fields that aren&#8217;t acceptable to your application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_56">Solution</h4>
<div class="paragraph"><p>Override the <span class="monospaced">validations</span> method on your field and provide one re more validation functions.</p></div>
<div class="paragraph"><p>As an example, imagine we have a database of planets and we want to ensure any new planets entered by users have names of at least five characters.  We add this as a validation on our record:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>   <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
        <span class="n">valMinLen</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;Name too short&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span> <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
    <span class="o">}</span>

  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>To check the validation, in our snippet we call <span class="monospaced">validate</span> on the record which will return all the errors for the record:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code</span>
<span class="k">package</span> <span class="nn">snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="n">S</span><span class="o">,</span><span class="nc">SHtml</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="k">import</span> <span class="nn">model.MySchema._</span>

<span class="k">class</span> <span class="nc">ValidateSnippet</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">newPlanet</span> <span class="k">=</span> <span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span>

    <span class="k">def</span> <span class="n">validateAndSave</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">newPlanet</span><span class="o">.</span><span class="n">validate</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Nil</span> <span class="k">=&gt;</span>
        <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">newPlanet</span><span class="o">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Planet &#39;%s&#39; saved&quot;</span> <span class="n">format</span> <span class="n">newPlanet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">)</span>

      <span class="k">case</span> <span class="n">errors</span> <span class="k">=&gt;</span>
        <span class="n">S</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="n">errors</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="s">&quot;#planetName&quot;</span> <span class="o">#&gt;</span> <span class="n">newPlanet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toForm</span> <span class="o">&amp;</span>
    <span class="s">&quot;type=submit&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">onSubmitUnit</span><span class="o">(</span><span class="n">validateAndSave</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>When the snippet runs we render the <span class="monospaced">Planet.name</span> field and wire up a submit button to call the <span class="monospaced">validateAndSave</span> method.</p></div>
<div class="paragraph"><p>If the <span class="monospaced">validate</span> call indicates there are no errors (<span class="monospaced">Nil</span>), we can save the record and inform the user via a notice.  If there are errors, we render all of them with <span class="monospaced">S.error</span>.</p></div>
<div class="paragraph"><p>The corresponding template could be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Planet Name Validation<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Add a planet<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;Msgs?showAll=false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;lift:notice</span><span class="na">_class</span><span class="nt">&gt;</span>noticeBox<span class="err">&lt;</span>/lift:notice_class&gt;
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;p&gt;</span>
    Planet names need to be at least 5 characters long.
  <span class="nt">&lt;/p&gt;</span>

  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;ValidateSnippet?form&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;div&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;planetName&quot;</span><span class="nt">&gt;</span>Planet name:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;planetName&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">data-lift=</span><span class="s">&quot;Msg?id=name_id&amp;errorClass=error&quot;</span><span class="nt">&gt;</span>
        Msg to appear here
      <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>

  <span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>In this template the error message is shown next to the <span class="monospaced">input</span> field, styled with a CSS class of <span class="monospaced">errorClass</span>. The success notice
is shown near the top of the page, just below the <span class="monospaced">&lt;h1&gt;</span> heading, using a styled called <span class="monospaced">noticeBox</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_57">Discussion</h4>
<div class="paragraph"><p>The built-in validations are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">valMinLen</span>&#8201;&#8212;&#8201;validate a string is at least a given length, as shown above.
</p>
</li>
<li>
<p>
<span class="monospaced">valMaxLen</span>&#8201;&#8212;&#8201;validate that a string is not above a given length.
</p>
</li>
<li>
<p>
<span class="monospaced">valRegex</span>&#8201;&#8212;&#8201;validate a string matches the given pattern.
</p>
</li>
</ul></div>
<div class="paragraph"><p>An example of regular expression validation on a field would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">java.util.regex.Pattern</span>

<span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">1024</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
    <span class="n">valRegex</span><span class="o">(</span> <span class="nc">Pattern</span><span class="o">.</span><span class="n">compile</span><span class="o">(</span><span class="s">&quot;^https?://.*&quot;</span><span class="o">),</span>
              <span class="s">&quot;URLs should start http:// or https://&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span>
    <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The list of errors from <span class="monospaced">validate</span> are of type <span class="monospaced">List[FieldError]</span>.  The <span class="monospaced">S.error</span> method accepts this list and registered each validation error message so it can be shown on the page.  It does this by associating the message with an ID for the field, allowing you to pick out just the errors for an individual field, as we do in this recipe.  The ID is stored on the field, and in the case of <span class="monospaced">Planet.name</span> it is available as <span class="monospaced">Planet.name.uniqueFieldId</span>.  It&#8217;s a <span class="monospaced">Box[String]</span> with a value of <span class="monospaced">Full("name_id")</span>.  It is this <span class="monospaced">name_id</span> value that we used in the <span class="monospaced">lift:Msg?id=name_id&amp;errorClass=error</span> markup to pick out just the error for this field.</p></div>
<div class="paragraph"><p>You don&#8217;t have to use <span class="monospaced">S.error</span> to display validation messages.  You can roll your own display code, making use of the <span class="monospaced">FieldError</span> directly.  As you can see from the source for <span class="monospaced">FieldError</span>, the error is available as a <span class="monospaced">msg</span> property:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">FieldError</span><span class="o">(</span><span class="n">field</span><span class="k">:</span> <span class="kt">FieldIdentifier</span><span class="o">,</span> <span class="n">msg</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">toString</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">uniqueFieldId</span> <span class="o">+</span> <span class="s">&quot; : &quot;</span> <span class="o">+</span> <span class="n">msg</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_55">See Also</h4>
<div class="paragraph"><p>The <span class="monospaced">BaseField.scala</span> class in the Lift source code contains the definition of the built-in <span class="monospaced">StringValidators</span>. Find the source at: <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala">https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala</a>.</p></div>
<div class="paragraph"><p><a href="#Forms">[Forms]</a> describes form processing, notices and errors.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CustomValidation">Custom Validation Logic</h3>
<div class="sect3">
<h4 id="_problem_57">Problem</h4>
<div class="paragraph"><p>You want to provide your own validation logic and apply it to a field in
a record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_57">Solution</h4>
<div class="paragraph"><p>Implement a function from the type of the field to
<span class="monospaced">List[FieldError]</span>, and reference the function in the <span class="monospaced">validations</span> on the field.</p></div>
<div class="paragraph"><p>Here&#8217;s an example: we have a database of planets, and when a user
enters a new planet, we want the name to be unique.  The name of the planet
is a <span class="monospaced">String</span>, so we need to provide a function from <span class="monospaced">String =&gt; List[FieldError]</span>.</p></div>
<div class="paragraph"><p>With the validation function defined (<span class="monospaced">valUnique</span>, below), we include it in the list of <span class="monospaced">validations</span> on the
<span class="monospaced">name</span> field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.FieldError</span>

<span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
      <span class="n">valUnique</span><span class="o">(</span><span class="s">&quot;Planet already exists&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span>
      <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">valUnique</span><span class="o">(</span><span class="n">errorMsg</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">String</span><span class="o">)(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">FieldError</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Planet</span><span class="o">.</span><span class="n">unique_?</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="kc">true</span> <span class="k">=&gt;</span> <span class="nc">FieldError</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">errorMsg</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>
      <span class="k">case</span> <span class="kc">false</span> <span class="k">=&gt;</span> <span class="nc">Nil</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Planet</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">unique_?</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">from</span><span class="o">(</span><span class="n">planets</span><span class="o">)</span> <span class="o">{</span> <span class="n">p</span> <span class="k">=&gt;</span>
    <span class="n">where</span><span class="o">(</span><span class="n">lower</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="o">===</span> <span class="n">lower</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="n">select</span><span class="o">(</span><span class="n">p</span><span class="o">)</span>
  <span class="o">}.</span><span class="n">isEmpty</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The validation is triggered just like any other validation, as described in <a href="#FieldValidation">[FieldValidation]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_58">Discussion</h4>
<div class="paragraph"><p>By convention validation functions have two argument lists: the first
for the error message; the second to receive the value to validate. This
allows you to easily re-use your validation function on other fields.  For example,
if you wanted to validate that satellites have a unique name, you could use
exactly the same function but provide a different error message.</p></div>
<div class="paragraph"><p>The <span class="monospaced">FieldError</span> you return needs to know the field it applies to as
well as the message to display. In the example the field is <span class="monospaced">name</span>, but
we&#8217;ve used <span class="monospaced">this.name</span> to avoid confusion with the <span class="monospaced">name</span> parameter passed
into the <span class="monospaced">valUnique</span> function.</p></div>
<div class="paragraph"><p>The example code has used text for the error message, but there is a variation of <span class="monospaced">FieldError</span> that
accepts <span class="monospaced">NodeSeq</span>.  This allows you to produce safe markup as part of the error if you need to.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">FieldError</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">Please</span> <span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;/policy&quot;</span><span class="o">&gt;</span><span class="n">our</span> <span class="n">name</span> <span class="n">policy</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>For internationalisation, you may prefer to pass in a key to the validation function, and
resolve it via <span class="monospaced">S.?</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
      <span class="n">valUnique</span><span class="o">(</span><span class="s">&quot;validation.planet&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span>
      <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
  <span class="o">}</span>

<span class="c1">// ...combined with...</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">valUnique</span><span class="o">(</span><span class="n">errorKey</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">String</span><span class="o">)(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">FieldError</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Planet</span><span class="o">.</span><span class="n">unique_?</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="kc">false</span> <span class="k">=&gt;</span> <span class="nc">FieldError</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">S</span> <span class="o">?</span> <span class="n">errorKey</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>
    <span class="k">case</span> <span class="kc">true</span> <span class="k">=&gt;</span> <span class="nc">Nil</span>
  <span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_56">See Also</h4>
<div class="paragraph"><p><a href="#FieldValidation">[FieldValidation]</a> discusses field validation and the built-in validations.</p></div>
<div class="paragraph"><p>Text localisation is discussed on the Lift wiki at: <a href="https://www.assembla.com/wiki/show/liftweb/Localization">https://www.assembla.com/wiki/show/liftweb/Localization</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylFilter">Modify a Field Value Before it is Set</h3>
<div class="sect3">
<h4 id="_problem_58">Problem</h4>
<div class="paragraph"><p>You want to modify the value of a field, so the value in your model is
the modified version.  For example, to clean a value by removing leading and trailing whitespace.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_58">Solution</h4>
<div class="paragraph"><p>Override <span class="monospaced">setFilter</span> and provide a list of functions to apply to a field.</p></div>
<div class="paragraph"><p>To remove leading and trailing whitespace entered by the user, the field would use the <span class="monospaced">trim</span> filter:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">override</span> <span class="k">def</span> <span class="n">setFilter</span> <span class="k">=</span> <span class="n">trim</span> <span class="k">_</span> <span class="o">::</span> <span class="k">super</span><span class="o">.</span><span class="n">setFilter</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_59">Discussion</h4>
<div class="paragraph"><p>The built-in filters are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">crop</span>&#8201;&#8212;&#8201;enforces the field&#8217;s min and max length by truncation.
</p>
</li>
<li>
<p>
<span class="monospaced">trim</span>&#8201;&#8212;&#8201;applies <span class="monospaced">String.trim</span> to the field value.
</p>
</li>
<li>
<p>
<span class="monospaced">toUpper</span> and <span class="monospaced">toLower</span>&#8201;&#8212;&#8201;change the case of the field value.
</p>
</li>
<li>
<p>
<span class="monospaced">removeRegExChars</span>&#8201;&#8212;&#8201;removes matching regular expression characters.
</p>
</li>
<li>
<p>
<span class="monospaced">notNull</span>&#8201;&#8212;&#8201;coverts null values to an empty string.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Filters are run before validation. This means if you have a minimum length validation and the trim filter, for example, users cannot pass the validation test by just including spaces on the end of the value they enter.</p></div>
<div class="paragraph"><p>A filter for a <span class="monospaced">String</span> field would be of type <span class="monospaced">String =&gt; String</span>, and the <span class="monospaced">setFilter</span> function expects a <span class="monospaced">List</span> of these.  Knowing this, it&#8217;s straight-forward to write custom filters. For example, here&#8217;s is a filter that applies a simple form of title case on our <span class="monospaced">name</span> field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="k">def</span> <span class="n">titleCase</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
  <span class="n">in</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\\s&quot;</span><span class="o">).</span>
  <span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toList</span><span class="o">).</span>
  <span class="n">collect</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span>  <span class="k">=&gt;</span> <span class="o">(</span><span class="nc">Character</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">(</span><span class="n">x</span><span class="o">).</span><span class="n">toString</span> <span class="o">::</span> <span class="n">xs</span><span class="o">).</span><span class="n">mkString</span>
  <span class="o">}.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This function is splitting the input string on spaces, converting each word into a list of characters, converting the first character into upper case, and then gluing the strings back together.</p></div>
<div class="paragraph"><p>When installed as a filter&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">override</span> <span class="k">def</span> <span class="n">setFilter</span> <span class="k">=</span>
    <span class="n">trim</span> <span class="k">_</span> <span class="o">::</span> <span class="n">titleCase</span> <span class="k">_</span> <span class="o">::</span> <span class="k">super</span><span class="o">.</span><span class="n">setFilter</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;a user entering "jaglan beta" as a planet name would see it stored in the database as "Jaglan Beta".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_57">See Also</h4>
<div class="paragraph"><p>The best place to understand the filters is the trait <span class="monospaced">StringValidators</span> in the source for <span class="monospaced">BaseField</span>: <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala">https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala</a>.</p></div>
<div class="paragraph"><p>If you really do need to apply title case to a value, the Apache Commons <span class="monospaced">WordUtils</span> class provides ready-made functions for this.  See: <a href="http://commons.apache.org/lang/">http://commons.apache.org/lang/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylUnitTest">Testing with Specs2</h3>
<div class="sect3">
<h4 id="_problem_59">Problem</h4>
<div class="paragraph"><p>You want to write Specs2 unit tests which access your database model with Squeryl and Record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_59">Solution</h4>
<div class="paragraph"><p>Use an in-memory database, and arrange for it to be set up around your test.</p></div>
<div class="paragraph"><p>There are three parts to this: including a database in your project and connect to it in an in-memory mode; creating a re-usable trait to set up the database; and then using the trait in your test.</p></div>
<div class="paragraph"><p>The H2 database has an in memory mode, meaning it won&#8217;t save data to disk. It needs to 